<!doctype html>
<html lang="fi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pumpun hyötysuhde · Villen koodailut</title>
    <link rel="icon" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      html,body,#root{height:100%}
      .kpi{font-size:1.75rem;line-height:2.25rem}
      @media (min-width:1024px){ .sticky-col{position:sticky; top:1rem} }
    </style>
  </head>
  <body class="bg-gray-50">
    <nav class="bg-white border-b">
      <div class="max-w-6xl mx-auto px-4 py-2 text-sm text-gray-600 flex items-center gap-3">
        <a href="index.html" class="hover:underline">← Etusivu</a>
        <span class="text-gray-300">|</span>
        <span>Pumpun hyötysuhdelaskuri</span>
      </div>
    </nav>

    <div id="root" class="max-w-6xl mx-auto px-4 py-6"></div>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const {useState,useMemo,useEffect} = React;
      const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));

      // ----- UI -----
      const Field = ({label,children,help}) => (
        <label className="flex flex-col gap-1">
          <span className="text-sm text-gray-600">{label}</span>
          {children}
          {help && <span className="text-xs text-gray-400">{help}</span>}
        </label>
      );
      const Input = props => (
        <input {...props}
          className={(props.className||"")+" w-full rounded-xl border p-2 focus:outline-none focus:ring text-right"} />
      );
      const Select = props => (
        <select {...props}
          className={(props.className||"")+" w-full rounded-xl border p-2"} />
      );
      const KPI = ({label,value,unit,dec=2,muted=false}) => {
        const txt = Number.isFinite(value) ? value.toLocaleString(undefined,{maximumFractionDigits:dec}) : "–";
        return (
          <div className={"rounded-2xl p-4 border bg-white "+(muted?"opacity-80":"")}>
            <div className="text-xs uppercase tracking-wide text-gray-500">{label}</div>
            <div className="kpi font-semibold">{txt} <span className="text-gray-500 text-base font-normal">{unit}</span></div>
          </div>
        );
      };

      // ----- Fysiikka-apurit -----
      function flowToM3s(q,unit){
        const v=+q; if(!Number.isFinite(v)||v<=0) return NaN;
        if(unit==="m3h") return v/3600;
        if(unit==="ls")  return v/1000;
        if(unit==="m3s") return v;
        if(unit==="gpm") return v*0.003785411784/60;
        return NaN;
      }
      function dpToHead(dp,unit,rho,g){
        let Pa=+dp; if(!Number.isFinite(Pa)) return NaN;
        if(unit==="bar") Pa*=1e5; else if(unit==="kpa") Pa*=1e3;
        return Pa/(rho*g);
      }
      function waterDensityApprox(T){
        const pts=[[0,999.84],[20,998.2],[40,992.2],[60,983.2],[80,971.8],[100,958.4]];
        if(T<=0) return 999.84; if(T>=100) return 958.4;
        for(let i=0;i<pts.length-1;i++){ const [t1,r1]=pts[i],[t2,r2]=pts[i+1];
          if(T>=t1&&T<=t2){ const f=(T-t1)/(t2-t1); return r1+f*(r2-r1); } }
        return 998.0;
      }
      function motorEffEstimate(ratedKW,shaftKW,mode){
        const rk=Math.max(0.37, Number(ratedKW)||0.37);
        const load=Math.min(1.2,Math.max(0.2,(Number(shaftKW)||0)/rk||0.9));
        const xs=[0.75,1.1,2.2,4,7.5,11,15,22,30,37,55,75,110,160,250,355];
        const IE3=[.78,.82,.85,.88,.90,.915,.926,.939,.948,.953,.957,.960,.963,.966,.970,.972];
        const IE2=IE3.map(x=>x-0.01), IE4=IE3.map(x=>x+0.01);
        const ys = mode==="ie2"?IE2 : mode==="ie4"?IE4 : IE3;
        const itp = (x)=>{ if(x<=xs[0])return ys[0]; if(x>=xs.at(-1))return ys.at(-1);
          for(let i=0;i<xs.length-1;i++){ if(x>=xs[i]&&x<=xs[i+1]){ const f=(x-xs[i])/(xs[i+1]-xs[i]); return ys[i]+f*(ys[i+1]-ys[i]); } }
          return ys.at(-1);
        };
        const base=itp(rk);
        const corr=(load<1)?-(0.025*(1-load)):-(0.01*(load-1));
        return clamp(base+corr,0.7,0.985);
      }

      function App(){
        // --- Perus ---
        const [q,setQ]=useState(50), [qUnit,setQUnit]=useState("m3h");
        const [modeHead,setModeHead]=useState("H"); // H or dP
        const [H,setH]=useState(35);
        const [dP,setDP]=useState(3.4), [dPunit,setDPunit]=useState("bar");

        const [rho,setRho]=useState(998), [temp,setTemp]=useState(""), [g,setG]=useState(9.81);

        // --- Tehomoodi ---
        const [powTab,setPowTab]=useState("elec"); // elec | shaft
        const [Pelec,setPelec]=useState(22), [etaVFD,setEtaVFD]=useState(0.98);
        const [motorRated,setMotorRated]=useState(30), [motorMode,setMotorMode]=useState("auto"), [etaMotor,setEtaMotor]=useState();
        const [PshaftIn,setPshaftIn]=useState(20);

        // --- Käyttö & vertailu ---
        const [hrs,setHrs]=useState(4000), [price,setPrice]=useState(0.12), [targetEta,setTargetEta]=useState(0.80);

        // --- Lisäasetukset ---
        const [advOpen,setAdvOpen]=useState(false);
        const [uncQ,setUncQ]=useState(2), [uncH,setUncH]=useState(2), [uncP,setUncP]=useState(1);
        const [npsha,setNpsha]=useState(""), [npshr,setNpshr]=useState(""), [npshMargin,setNpshMargin]=useState(0.5);

        // Päivitä veden ρ lämpötilasta
        useEffect(()=>{ const T=parseFloat(temp); if(!Number.isNaN(T)) setRho(+waterDensityApprox(T).toFixed(1)); },[temp]);

        // Laskenta
        const R = useMemo(()=>{
          const Qs=flowToM3s(q,qUnit);
          const Hval = (modeHead==="H") ? +H : dpToHead(dP,dPunit,rho,g);
          if(!Number.isFinite(Qs)||!Number.isFinite(Hval)||Qs<=0||Hval<=0) return {error:"Anna kelvolliset Q ja H/Δp."};

          const Phyd = rho*g*Qs*Hval/1000; // kW

          let Pshaft, Pgrid, etaTot, etaM_used;
          if (powTab==="elec"){
            if(!Number.isFinite(Pelec)||Pelec<=0||!Number.isFinite(etaVFD)||etaVFD<=0) return {error:"Tarkista verkkoteho ja VFD-hyötysuhde."};
            const shaft_guess=Pelec*etaVFD*0.94;
            const ieMode = (motorMode==="ie2"||motorMode==="ie4") ? motorMode : "ie3";
            etaM_used = (motorMode==="manual") ? clamp(etaMotor||0,0,1) : motorEffEstimate(motorRated,shaft_guess,ieMode);
            Pshaft = Pelec*etaVFD*etaM_used;
            Pgrid  = Pelec;
            etaTot = clamp(Phyd/Pgrid,0,1);
          } else {
            if(!Number.isFinite(PshaftIn)||PshaftIn<=0) return {error:"Tarkista akseliteho."};
            Pshaft = PshaftIn;
            Pgrid  = Number.isFinite(Pelec)&&Pelec>0 ? Pelec : undefined;
            etaTot = Pgrid ? clamp(Phyd/Pgrid,0,1) : undefined;
          }

          const etaPump = clamp(Phyd/Math.max(Pshaft,1e-9),0,1);
          const Q_m3h = Qs*3600;
          const Eyear = Pgrid ? Pgrid*hrs : undefined;
          const cost  = Eyear ? Eyear*price : undefined;
          const spec  = (Pgrid && Q_m3h>0) ? (Pgrid/Q_m3h) : undefined;

          // Tavoite-η_pump → vuosienergian säästö
          let save_kWh_year, save_eur_year, save_label = "verkossa";
          const neededPshaft = Phyd / Math.max(targetEta,1e-9); // kW
          if (powTab==="elec"){
            const ieMode2 = (motorMode==="ie2"||motorMode==="ie4") ? motorMode : "ie3";
            const etaM2 = (motorMode==="manual") ? clamp(etaMotor||0,0,1) : motorEffEstimate(motorRated,neededPshaft,ieMode2);
            const chain = etaVFD * (etaM2||etaM_used||0.92);
            const Pelec_target = chain>0 ? neededPshaft/chain : undefined;
            if (Number.isFinite(Pelec_target)) {
              const deltaP = Math.max(0, Pgrid - Pelec_target);
              save_kWh_year = deltaP * hrs;
            }
          } else {
            // vain akseliteho tunnetaan: ilmoita säästö akselitasolla
            const deltaPshaft = Math.max(0, Pshaft - neededPshaft);
            save_kWh_year = deltaPshaft * hrs;
            save_label = "akselilla";
          }
          if (Number.isFinite(save_kWh_year)) save_eur_year = save_kWh_year * price;

          // Epävarmuus min–max
          const uq=Math.abs(uncQ)/100||0, uh=Math.abs(uncH)/100||0, up=Math.abs(uncP)/100||0;
          const Qmin=Qs*(1-uq), Qmax=Qs*(1+uq), Hmin=Hval*(1-uh), Hmax=Hval*(1+uh);
          const Phyd_min=rho*g*Math.max(Qmin,0)*Math.max(Hmin,0)/1000, Phyd_max=rho*g*Math.max(Qmax,0)*Math.max(Hmax,0)/1000;
          const Pshaft_min=Pshaft*(1-up), Pshaft_max=Pshaft*(1+up);
          const Pgrid_min=Pgrid?Pgrid*(1-up):undefined, Pgrid_max=Pgrid?Pgrid*(1+up):undefined;
          const etaPump_min=clamp(Phyd_min/Math.max(Pshaft_max,1e-9),0,1);
          const etaPump_max=clamp(Phyd_max/Math.max(Pshaft_min,1e-9),0,1);
          const etaTot_min= Pgrid? clamp(Phyd_min/Math.max(Pgrid_max,1e-9),0,1):undefined;
          const etaTot_max= Pgrid? clamp(Phyd_max/Math.max(Pgrid_min,1e-9),0,1):undefined;

          // NPSH
          let npshMsg="Syötä NPSH_a ja NPSH_r tarvittaessa.", npshOK=null;
          if(npsha!=="" && npshr!==""){
            const a=+npsha, r=+npshr, m=+npshMargin||0;
            if(Number.isFinite(a)&&Number.isFinite(r)){ npshOK = a >= r + m;
              npshMsg = npshOK ? `OK: NPSH_a−NPSH_r = ${(a-r).toFixed(2)} m (≥ ${m} m)` :
                                 `VAROITUS: NPSH_a−NPSH_r = ${(a-r).toFixed(2)} m < ${m} m`; }
          }

          const warn = etaPump<0.35 ? "η_pump alle 35 % – tarkista mittaukset."
                     : etaPump>0.92 ? "η_pump yli 92 % vaikuttaa epätodennäköiseltä."
                     : "";

          return {Qs,Hval,Phyd,Pshaft,Pgrid,etaPump,etaTot,Eyear,cost,spec,
                  etaPump_min,etaPump_max,etaTot_min,etaTot_max,npshMsg,npshOK,
                  save_kWh_year, save_eur_year, save_label, warn};
        },[q,qUnit,modeHead,H,dP,dPunit,rho,g,powTab,Pelec,etaVFD,motorRated,motorMode,etaMotor,PshaftIn,hrs,price,targetEta,uncQ,uncH,uncP,npsha,npshr,npshMargin]);

        // Pikatestit
        const presets=[
          {name:"Hyvä η_pump (IE3)", s:{q:80,qUnit:"m3h",modeHead:"H",H:40,powTab:"elec",Pelec:30,etaVFD:0.98,motorRated:37,motorMode:"ie3"}},
          {name:"Matala η_pump", s:{q:50,qUnit:"m3h",modeHead:"H",H:10,powTab:"elec",Pelec:30,etaVFD:0.97,motorRated:30,motorMode:"ie2"}},
          {name:"Akseliteho syötetty", s:{q:60,qUnit:"m3h",modeHead:"H",H:35,powTab:"shaft",PshaftIn:22}},
          {name:"Δp→H muunnos", s:{q:100,qUnit:"m3h",modeHead:"dP",dP:3.2,dPunit:"bar",powTab:"elec",Pelec:45,etaVFD:0.985,motorRated:55,motorMode:"ie4"}},
        ];
        const [presetIdx,setPresetIdx]=useState(-1);
        const applyPreset=()=>{
          const p=presets[presetIdx]?.s; if(!p) return;
          setQ(p.q??q); setQUnit(p.qUnit??qUnit); setModeHead(p.modeHead??modeHead); setH(p.H??H);
          setDP(p.dP??dP); setDPunit(p.dPunit??dPunit);
          setPowTab(p.powTab??powTab); if(p.Pelec!==undefined) setPelec(p.Pelec); setEtaVFD(p.etaVFD??etaVFD);
          setMotorRated(p.motorRated??motorRated); setMotorMode(p.motorMode??motorMode); if(p.PshaftIn!==undefined) setPshaftIn(p.PshaftIn);
        };

        // Tuloste (ilman <script>-tageja templaatissa)
        const printSummary=()=>{
          const r=R;
          const fmt=(x,dec=2)=>Number.isFinite(x)?x.toLocaleString(undefined,{maximumFractionDigits:dec}):"–";
          const html=[
            '<!doctype html><html><head><meta charset="utf-8"><title>Pumpun hyötysuhde – yhteenveto</title>',
            '<style>body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px}h1{margin:0 0 8px}h2{margin:18px 0 8px}',
            'table{border-collapse:collapse;width:100%;margin:8px 0 16px}th,td{border:1px solid #ddd;padding:8px;font-size:14px}',
            'th{background:#f3f4f6;text-align:left}.muted{color:#6b7280;font-size:12px}</style></head><body>',
            '<h1>Pumpun hyötysuhdelaskelma – yhteenveto</h1><div class="muted">Luotu ',new Date().toLocaleString(),'</div>',
            '<h2>Syötteet</h2><table><tbody>',
            '<tr><th>Virtaama Q</th><td>',q,' ',qUnit,'</td><th>H/Δp</th><td>',(modeHead==="H"?"H":"Δp"),'</td></tr>',
            '<tr><th>Nostokorkeus H</th><td>',fmt(R.Hval,3),' m</td><th>Δp (jos annettu)</th><td>',(modeHead==="dP"?`${dP} ${dPunit}`:"-"),'</td></tr>',
            '<tr><th>Tiheys ρ</th><td>',rho,' kg/m³</td><th>g</th><td>',g,' m/s²</td></tr>',
            '<tr><th>Tehomoodi</th><td>',(powTab==="elec"?"Verkkoteho":"Akseliteho"),'</td><th>P</th><td>',(powTab==="elec"?`${Pelec} kW`:`${PshaftIn} kW`),'</td></tr>',
            '</tbody></table>',
            '<h2>Tulokset</h2><table><tbody>',
            '<tr><th>Hydraulinen teho</th><td>',fmt(r.Phyd),' kW</td><th>Akseliteho</th><td>',fmt(r.Pshaft),' kW</td></tr>',
            '<tr><th>η_pump</th><td>',fmt(r.etaPump*100,1),' %</td><th>η_pump (min–max)</th><td>',fmt(r.etaPump_min*100,1),'–',fmt(r.etaPump_max*100,1),' %</td></tr>',
            '<tr><th>η_tot</th><td>',(r.etaTot!=null?fmt(r.etaTot*100,1)+' %':'–'),'</td><th>η_tot (min–max)</th><td>',(r.etaTot_min!=null?fmt(r.etaTot_min*100,1)+'–'+fmt(r.etaTot_max*100,1)+' %':'–'),'</td></tr>',
            '<tr><th>Ominaisenergia</th><td>',(r.spec!=null?fmt(r.spec,4)+' kWh/m³':'–'),'</td><th>Vuotuinen energia</th><td>',(r.Eyear!=null?fmt(r.Eyear,0)+' kWh':'–'),'</td></tr>',
            '<tr><th>Arvioitu vuosisäästö</th><td>',(r.save_kWh_year!=null?fmt(r.save_kWh_year,0)+' kWh ('+(r.save_label||'verkossa')+')':'–'),'</td>',
            '<th>Kustannussäästö</th><td>',(r.save_eur_year!=null?fmt(r.save_eur_year,0)+' €':'–'),'</td></tr>',
            '</tbody></table><div class="muted">Kaavat: P_hyd=ρgQH; η_pump=P_hyd/P_shaft; η_tot=P_hyd/P_elec; H=Δp/(ρg).</div></body></html>'
          ].join('');
          const w=window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=>{try{w.print()}catch(e){}},200);
        };

        return (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Lomake */}
            <div className="lg:col-span-2 space-y-6">
              <div className="flex flex-col sm:flex-row sm:items-end gap-3">
                <div className="flex-1">
                  <h1 className="text-2xl font-bold">Pumpun hyötysuhdelaskuri</h1>
                  <p className="text-sm text-gray-500">Syötä virtaama ja nostokorkeus/paine. Valitse mitattu teho. Tulokset päivittyvät oikealle.</p>
                </div>
                <div className="flex items-center gap-2">
                  <Select value={-1} onChange={e=>{const i=+e.target.value; if(i>=0){ const p=[{q:80,qUnit:"m3h",modeHead:"H",H:40,powTab:"elec",Pelec:30,etaVFD:0.98,motorRated:37,motorMode:"ie3"},
                                                                                           {q:50,qUnit:"m3h",modeHead:"H",H:10,powTab:"elec",Pelec:30,etaVFD:0.97,motorRated:30,motorMode:"ie2"},
                                                                                           {q:60,qUnit:"m3h",modeHead:"H",H:35,powTab:"shaft",PshaftIn:22},
                                                                                           {q:100,qUnit:"m3h",modeHead:"dP",dP:3.2,dPunit:"bar",powTab:"elec",Pelec:45,etaVFD:0.985,motorRated:55,motorMode:"ie4"}][i];
                    setQ(p.q); setQUnit(p.qUnit); setModeHead(p.modeHead); setH(p.H??H); setDP(p.dP??dP); setDPunit(p.dPunit??dPunit);
                    setPowTab(p.powTab); if(p.Pelec!=null) setPelec(p.Pelec); if(p.etaVFD!=null) setEtaVFD(p.etaVFD);
                    if(p.motorRated!=null) setMotorRated(p.motorRated); if(p.motorMode) setMotorMode(p.motorMode); if(p.PshaftIn!=null) setPshaftIn(p.PshaftIn);
                  }}}>
                    <option value="-1">— Pikatesti —</option>
                    <option value="0">Hyvä η_pump (IE3)</option>
                    <option value="1">Matala η_pump</option>
                    <option value="2">Akseliteho syötetty</option>
                    <option value="3">Δp→H muunnos</option>
                  </Select>
                  <button onClick={printSummary} className="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm">Tulosta</button>
                </div>
              </div>

              {/* 1) Prosessitiedot */}
              <section className="bg-white rounded-2xl shadow p-4 space-y-4">
                <div className="text-sm font-semibold">1) Prosessitiedot</div>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <Field label="Virtaama Q">
                    <div className="flex gap-2">
                      <Input type="number" step="0.001" min="0.0001" value={q} onChange={e=>setQ(parseFloat(e.target.value)||0)} />
                      <Select value={qUnit} onChange={e=>setQUnit(e.target.value)} className="w-28 text-right">
                        <option value="m3h">m³/h</option><option value="ls">L/s</option><option value="m3s">m³/s</option><option value="gpm">US gpm</option>
                      </Select>
                    </div>
                  </Field>
                  <Field label="Valinta">
                    <Select value={modeHead} onChange={e=>setModeHead(e.target.value)}>
                      <option value="H">Annan nostokorkeuden H</option>
                      <option value="dP">Annan paine-eron Δp</option>
                    </Select>
                  </Field>
                  {modeHead==="H" ? (
                    <Field label="Nostokorkeus H"><Input type="number" step="0.001" min="0.0001" value={H} onChange={e=>setH(parseFloat(e.target.value)||0)} /><div className="text-xs text-gray-500 text-right">m</div></Field>
                  ) : (
                    <div className="grid grid-cols-2 gap-2">
                      <Field label="Paine-ero Δp"><Input type="number" step="0.001" min="0" value={dP} onChange={e=>setDP(parseFloat(e.target.value)||0)} /></Field>
                      <Field label="Yksikkö"><Select value={dPunit} onChange={e=>setDPunit(e.target.value)}><option value="bar">bar</option><option value="kpa">kPa</option><option value="pa">Pa</option></Select></Field>
                    </div>
                  )}
                </div>

                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <Field label="Nesteen tiheys ρ" help="Vesi 20 °C ≈ 998 kg/m³">
                    <Input type="number" step="0.1" min="100" max="5000" value={rho} onChange={e=>setRho(parseFloat(e.target.value)||0)} />
                  </Field>
                  <Field label="Lämpötila (vedelle)" help="Päivittää ρ-arvion">
                    <Input type="number" step="0.1" min="-10" max="120" value={temp} onChange={e=>setTemp(e.target.value)} />
                  </Field>
                  <Field label="g">
                    <Input type="number" step="0.0001" min="9.78" max="9.83" value={g} onChange={e=>setG(parseFloat(e.target.value)||9.81)} />
                  </Field>
                </div>
              </section>

              {/* 2) Teho */}
              <section className="bg-white rounded-2xl shadow p-4 space-y-4">
                <div className="text-sm font-semibold">2) Mitattu teho</div>
                <div className="flex gap-1">
                  <button onClick={()=>setPowTab("elec")} className={"px-3 py-1.5 rounded-xl border text-sm "+(powTab==="elec"?"bg-gray-900 text-white":"bg-white hover:bg-gray-50")}>Verkkoteho</button>
                  <button onClick={()=>setPowTab("shaft")} className={"px-3 py-1.5 rounded-xl border text-sm "+(powTab==="shaft"?"bg-gray-900 text-white":"bg-white hover:bg-gray-50")}>Akseliteho</button>
                </div>

                {powTab==="elec" ? (
                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <Field label="Verkkoteho P_elec (kW)"><Input type="number" step="0.001" min="0.001" value={Pelec} onChange={e=>setPelec(parseFloat(e.target.value)||0)} /></Field>
                    <Field label="VFD-hyötysuhde η_VFD"><Input type="number" step="0.001" min="0.5" max="1" value={etaVFD} onChange={e=>setEtaVFD(parseFloat(e.target.value)||0)} /></Field>
                    <Field label="Moottorin nimellisteho (kW)"><Input type="number" step="0.1" min="0.1" value={motorRated} onChange={e=>setMotorRated(parseFloat(e.target.value)||0)} /></Field>
                    <Field label="Moottorin hyötysuhteen arvio">
                      <Select value={motorMode} onChange={e=>setMotorMode(e.target.value)}>
                        <option value="auto">Automaattinen (IE3)</option>
                        <option value="ie2">Automaattinen (IE2)</option>
                        <option value="ie3">Automaattinen (IE3)</option>
                        <option value="ie4">Automaattinen (IE4)</option>
                        <option value="manual">Syötän itse</option>
                      </Select>
                    </Field>
                    <Field label="η_moottori (jos syötän itse)">
                      <Input type="number" step="0.001" min="0.5" max="1" disabled={motorMode!=="manual"}
                             value={motorMode==="manual"?(etaMotor??""):""} onChange={e=>setEtaMotor(parseFloat(e.target.value)||0)} />
                    </Field>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <Field label="Akseliteho P_shaft (kW)"><Input type="number" step="0.001" min="0.001" value={PshaftIn} onChange={e=>setPshaftIn(parseFloat(e.target.value)||0)} /></Field>
                    <div className="sm:col-span-2 text-sm text-gray-500 self-center">Säästö lasketaan tässä tilassa akselitasolla.</div>
                  </div>
                )}

                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <Field label="Käyttötunnit vuodessa"><Input type="number" step="1" min="0" max="8760" value={hrs} onChange={e=>setHrs(parseFloat(e.target.value)||0)} /></Field>
                  <Field label="Sähkön hinta"><Input type="number" step="0.001" min="0" value={price} onChange={e=>setPrice(parseFloat(e.target.value)||0)} /></Field>
                  <Field label="Tavoite η_pump"><Input type="number" step="0.001" min="0.01" max="1" value={targetEta} onChange={e=>setTargetEta(parseFloat(e.target.value)||0)} /></Field>
                </div>
              </section>

              {/* 3) Lisäasetukset */}
              <section className="bg-white rounded-2xl shadow p-4">
                <button onClick={()=>setAdvOpen(o=>!o)} className="w-full text-left flex items-center justify-between">
                  <span className="text-sm font-semibold">3) Lisäasetukset</span>
                  <span className="text-sm text-gray-500">{advOpen?"Piilota":"Näytä"}</span>
                </button>
                {advOpen && (
                  <div className="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="space-y-4">
                      <div className="text-sm uppercase tracking-wide text-gray-500">Epävarmuusarviot (±%)</div>
                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <Field label="Virtaama"><Input type="number" step="0.1" min="0" max="50" value={uncQ} onChange={e=>setUncQ(parseFloat(e.target.value)||0)} /></Field>
                        <Field label="H/Δp"><Input type="number" step="0.1" min="0" max="50" value={uncH} onChange={e=>setUncH(parseFloat(e.target.value)||0)} /></Field>
                        <Field label="Teho"><Input type="number" step="0.1" min="0" max="50" value={uncP} onChange={e=>setUncP(parseFloat(e.target.value)||0)} /></Field>
                      </div>
                      <div className="text-sm text-gray-600">
                        η_pump ~ {Number.isFinite(R.etaPump_min)?(R.etaPump_min*100).toFixed(1):"–"}–{Number.isFinite(R.etaPump_max)?(R.etaPump_max*100).toFixed(1):"–"} %
                        {R.etaTot_min!=null && <> • η_tot ~ {(R.etaTot_min*100).toFixed(1)}–{(R.etaTot_max*100).toFixed(1)} %</>}
                      </div>
                    </div>
                    <div className="space-y-4">
                      <div className="text-sm uppercase tracking-wide text-gray-500">NPSH</div>
                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <Field label="NPSH_a"><Input type="number" step="0.01" min="0" value={npsha} onChange={e=>setNpsha(e.target.value)} /></Field>
                        <Field label="NPSH_r"><Input type="number" step="0.01" min="0" value={npshr} onChange={e=>setNpshr(e.target.value)} /></Field>
                        <Field label="Turvamarginaali"><Input type="number" step="0.01" min="0" value={npshMargin} onChange={e=>setNpshMargin(parseFloat(e.target.value)||0)} /></Field>
                      </div>
                      <div className={"text-sm "+(R.npshOK===false?"text-red-600":R.npshOK===true?"text-emerald-600":"text-gray-500")}>{R.npshMsg}</div>
                    </div>
                  </div>
                )}
              </section>
            </div>

            {/* Oikea tulospaneeli */}
            <aside className="sticky-col space-y-3">
              {R.error && <div className="rounded-2xl border border-amber-300 bg-amber-50 text-amber-900 p-3 text-sm">{R.error}</div>}
              {!R.error && R.warn && <div className="rounded-2xl border border-orange-300 bg-orange-50 text-orange-900 p-3 text-sm">{R.warn}</div>}
              <KPI label="Hydraulinen teho" value={R.Phyd} unit="kW" />
              <KPI label="Akseliteho (syöte/arvio)" value={R.Pshaft} unit="kW" />
              <KPI label="Pumpun hyötysuhde η_pump" value={R.etaPump!=null?R.etaPump*100:undefined} unit="%" dec={1} />
              <KPI label="Kokonaishyötysuhde η_tot" value={R.etaTot!=null?R.etaTot*100:undefined} unit="%" dec={1} muted />
              <KPI label="Ominaisenergia" value={R.spec} unit="kWh/m³" dec={4} muted />
              <KPI label="Vuotuinen energia" value={R.Eyear} unit="kWh/a" dec={0} muted />
              <KPI label="Vuotuinen kustannus" value={R.cost} unit="€/a" dec={0} muted />
              <KPI label={"Arvioitu vuosisäästö ("+(R.save_label||"verkossa")+")"} value={R.save_kWh_year} unit="kWh/a" dec={0} />
              <KPI label="Kustannussäästö" value={R.save_eur_year} unit="€/a" dec={0} />
            </aside>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
