<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Paineisku-Stopperi üö´üí• ‚Äì Villen koodailut</title>
<style>
  :root{
    --bg:#0b1020; --panel:#0f172e; --ink:#eaf2ff; --muted:#a6bdd6;
    --accent:#39d353; --warn:#ffd166; --danger:#ff627d;
    --radius:18px; --shadow:0 12px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1200px 600px at 15% -10%, rgba(94,160,255,.10), transparent 60%), #0b1020;
    color:var(--ink); font:16px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    display:flex; align-items:center; justify-content:center; padding:14px;
    user-select:none; -webkit-tap-highlight-color: transparent;
  }
  .wrap{width:min(1200px,100%); display:grid; gap:14px}
  header, footer{
    background:linear-gradient(180deg,#111a33,#0f1730 55%,#0c142a);
    border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:10px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  header .brand{font-weight:900; letter-spacing:.2px}
  header .sub{opacity:.7; font-weight:600}
  footer{justify-content:center; font-size:13px; color:#cfdcff}

  .game{ display:grid; gap:14px; grid-template-columns: 1.4fr 1fr; }
  @media (max-width:980px){ .game{grid-template-columns:1fr} }
  .panel{
    background:linear-gradient(180deg,var(--panel),#0b1327 60%,#0a1122);
    border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:14px;
  }

  .meterWrap{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
  @media (max-width:980px){ .meterWrap{grid-template-columns:1fr} }
  .meterCard{
    display:grid; gap:10px; padding:12px; border:1px solid rgba(255,255,255,.06); border-radius:14px;
    background:linear-gradient(180deg,#0e1631,#0c152c)
  }

  .gauge{
    height:420px; position:relative; border-radius:14px; overflow:hidden;
    background:linear-gradient(180deg,#0a1124,#0b152e);
    border:1px solid rgba(255,255,255,.09);
  }
  .gauge .grid{
    position:absolute; inset:0; background-image:
      linear-gradient(to top, rgba(255,255,255,.06) 1px, transparent 1px);
    background-size: 100% 38px; opacity:.25;
  }
  .gauge .fill{
    position:absolute; left:0; bottom:0; width:100%; height:0%;
    background:linear-gradient(180deg, #2655ff, #4fd6ff);
    transition:height .08s linear;
  }
  .gauge .limit{
    position:absolute; left:0; right:0; height:2px; background:var(--warn);
    box-shadow:0 0 0 3px rgba(255,209,102,.18), 0 0 12px rgba(255,209,102,.6);
  }
  .gauge.flash{animation:gflash .6s ease}
  @keyframes gflash{ 0%{box-shadow:0 0 0 0 rgba(255,98,125,.0)} 40%{box-shadow:0 0 0 8px rgba(255,209,102,.35)} 100%{box-shadow:0 0 0 0 rgba(255,209,102,.0)} }
  .gTitle{display:flex; align-items:baseline; gap:8px; font-weight:800}
  .gTitle small{color:var(--muted); font-weight:600}

  .speedBox{display:grid; gap:8px}
  .bar{height:12px; background:#0a1230; border:1px solid rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
  .bar>div{height:100%; width:0%; background:linear-gradient(90deg,#4fd6ff,#ffab57)}
  .hint{color:#cfe1ff; opacity:.75; font-size:14px}

  .rightCol{display:grid; gap:14px}
  .sliderCard{display:grid; grid-template-columns: 100px 1fr; gap:14px; align-items:center}
  @media (max-width:520px){ .sliderCard{grid-template-columns: 84px 1fr} }
  .slider{
    position:relative; width:84px; height:420px; border-radius:14px;
    background:linear-gradient(180deg,#0a1124,#0b152e); border:1px solid rgba(255,255,255,.08);
    touch-action:none; cursor:pointer;
  }
  .slider .track{position:absolute; left:50%; top:10px; bottom:10px; width:8px; transform:translateX(-50%); background:#17305f; border-radius:999px}
  .slider .knob{
    position:absolute; left:50%; transform:translate(-50%,-50%);
    width:68px; height:24px; border-radius:12px; background:linear-gradient(180deg,#1d3d7a,#17356a);
    border:1px solid rgba(255,255,255,.14); box-shadow:0 6px 12px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.08);
  }
  .sliderLabel{font-weight:800}
  .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
  .pill{
    padding:8px 10px; border:1px solid rgba(255,255,255,.08); border-radius:12px; background:#0c162e;
    display:flex; justify-content:space-between; align-items:center; gap:10px
  }
  .big{font-size:18px; font-weight:900}
  .score{font-size:20px; font-weight:900}
  .btnRow{display:flex; gap:8px; flex-wrap:wrap}
  .btn{
    border:1px solid rgba(255,255,255,.10); background:#0c152b; color:#e9f2ff; padding:10px 14px; border-radius:12px;
    cursor:pointer; font-weight:800; box-shadow:var(--shadow); font-size:16px
  }
  .btn:disabled{opacity:.6; cursor:not-allowed}
  .btn.primary{background:linear-gradient(180deg,#1b2f55,#122547)}
  .titleline{display:flex; justify-content:space-between; align-items:center}
  .titleline .lvl{opacity:.85; font-weight:800}
  .titleline .status{font-weight:800}
  .titleline .status.ok{color:#8ff0a6}
  .titleline .status.fail{color:#ff8599}
  .titleline .status.warn{color:#ffd166}

  /* === Loppuruutu === */
  .finalOverlay{
    position:fixed; inset:0; z-index:9999;
    display:grid; place-items:center;
    background:rgba(8,12,24,.72);
    backdrop-filter: blur(6px);
  }
  .finalCard{
    width:min(720px, calc(100% - 32px));
    background:linear-gradient(180deg,#0f1730,#0b142a);
    border:1px solid rgba(255,255,255,.10);
    box-shadow:0 20px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);
    border-radius:20px; padding:24px;
    text-align:center; color:#eaf2ff;
  }
  .finalCard h1{margin:0 0 6px 0; font-size:34px; font-weight:900}
  .finalCard .score{font-size:54px; font-weight:900; margin:6px 0 2px 0}
  .finalCard .sub{opacity:.8; margin-bottom:14px}
  .finalBtns{display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap}
  .finalBtn{
    border:1px solid rgba(255,255,255,.12); background:#0c152b; color:#e9f2ff;
    padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:800; font-size:16px;
    box-shadow:0 10px 24px rgba(0,0,0,.35)
  }
  .finalBtn.primary{background:linear-gradient(180deg,#1b2f55,#122547)}
  .hidden{display:none}

  /* Toast */
  .toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background:#0b142a; border:1px solid rgba(255,255,255,.12);
    padding:8px 12px; border-radius:10px; color:#eaf2ff; font-weight:700;
    box-shadow:0 10px 24px rgba(0,0,0,.35); z-index:10000;
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">Paineisku-Stopperi üö´üí• <span class="sub">‚Äì avaa nopeasti ilman piikki√§</span></div>
    <div class="sub">¬© <strong>Villen koodailut</strong></div>
  </header>

  <div class="game panel">
    <div class="meterWrap">
      <div class="meterCard">
        <div class="gTitle">Linjapaine <small>(eff.)</small></div>
        <div id="gauge" class="gauge">
          <div class="grid"></div>
          <div id="limit" class="limit" style="top:40%"></div>
          <div id="fill" class="fill" style="height:0%"></div>
        </div>
        <div class="grid2">
          <div class="pill">P_eff: <span id="pText" class="big">0.00</span></div>
          <div class="pill">P-raja: <span id="plText" class="big">‚Äî</span></div>
        </div>
        <div class="speedBox">
          <div> Avausnopeus </div>
          <div class="bar"><div id="spd"></div></div>
          <div class="hint">Vinkki: tasainen liike voittaa. Keltainen viiva = paineiskun raja.</div>
        </div>
      </div>

      <div class="meterCard">
        <div class="titleline">
          <div class="lvl">Taso <span id="lvl">1</span>/10</div>
          <div id="status" class="status warn">K√§ynniss√§‚Ä¶</div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div class="pill">Aika: <span id="time" class="big">‚Äî</span></div>
          <div class="pill">Avaus: <span id="openPct" class="big">0%</span></div>
        </div>
        <div class="pill" style="margin-top:8px; display:block">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <div>Pisteet (t√§m√§ taso)</div><div id="score" class="score">0</div>
          </div>
          <div style="opacity:.7; font-size:13px">Kokonaispisteet: <span id="totScore">0</span></div>
        </div>
        <div class="pill" style="margin-top:8px">Titteli: <span id="title" class="big">‚Äî</span></div>
        <div class="pill" style="margin-top:8px">Avustus: <span id="assistText" class="big">P√§√§ll√§</span></div>
        <div class="btnRow" style="margin-top:8px">
          <button id="retry" class="btn">‚ü≤ Uudestaan</button>
          <button id="next" class="btn primary" disabled>‚è≠ Seuraava taso</button>
        </div>
      </div>
    </div>

    <div class="rightCol">
      <div class="sliderCard pill">
        <div class="slider" id="slider">
          <div class="track"></div>
          <div id="knob" class="knob" style="top:100%"></div>
        </div>
        <div style="display:grid; gap:8px">
          <div class="sliderLabel">Venttiilin asento: <span id="vText" class="big">0%</span></div>
          <div class="hint">Ved√§ kahvaa yl√∂s ‚Üí avaa venttiili. Tavoite: 100% ilman rajan ylityst√§.</div>
          <div class="grid2">
            <div class="pill">H√§iri√∂: <span id="distText">pieni aalto</span></div>
            <div class="pill">Raja-aika: <span id="tLimitText">‚Äî</span></div>
          </div>
        </div>
      </div>
      <div class="pill">Pikalause: ‚ÄúAvaa hiljaa ‚Äì avausnopeus kasvattaa paineiskua.‚Äù</div>
    </div>
  </div>

  <footer>¬© <span id="year"></span> <strong>Villen koodailut</strong></footer>
</div>

<!-- LOPPURUUTU -->
<div id="finalOverlay" class="finalOverlay hidden" role="dialog" aria-modal="true">
  <div class="finalCard">
    <h1 id="finalTitle">‚Äî</h1>
    <div class="score" id="finalScore">0</div>
    <div class="sub">Yhteispisteet ‚Äì 10/10 tasoa suoritettu</div>
    <div class="finalBtns">
      <button id="newGameBtn" class="finalBtn primary">üöÄ Uusi peli</button>
      <button id="shareBtn" class="finalBtn">üì§ Jaa tulos</button>
      <button id="closeFinalBtn" class="finalBtn">N√§yt√§ tausta</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden">Kopioitu</div>

<script>
/* ===== Utils ===== */
const $ = (id)=>document.getElementById(id);
$('year').textContent = new Date().getFullYear();
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const aExp = (dt,tau)=> 1 - Math.exp(-dt/Math.max(1e-6,tau));

/* ===== Audio ===== */
let AC; function audio(){ if(!AC) AC=new (window.AudioContext||window.webkitAudioContext)(); return AC; }
function beep(freq=520, dur=0.12, vol=0.25){
  try{ const ctx=audio(); const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type='square'; o.frequency.value=freq; g.gain.value=vol; o.connect(g).connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+dur);
  }catch(e){}
}

/* ===== Game State ===== */
const G = {
  level:1, maxLevel:10,
  v:0, vPrev:0, targetV:0, dvdt:0,
  P:0, P_eff:0,                // P_eff on nyt low-passattu (inhimillisempi)
  P_limit:1.2,
  Kv:1.2, C:4.0, kf:0.12, kSurge:0.9, rSoft:0.12, gamma:1.4,
  t:0, tLimit:25, dt:0.02,
  qDemand:0.55, demandAmp:0.06, demandHz:0.05, jitter:0.0,
  spikeTimer:0, spikeAmp:0,
  exceeded:false, exceedCount:0, sinceExceed:0, excessArea:0,
  running:true, finished:false,
  score:0, totalScore:0, title:'‚Äî',
  // Avustus vain tasolla 1 (nopea, mutta pehme√§)
  useLimiter:true, slewUp:1.10, slewDown:1.80,
  // Aikavakiot (s√§√§det√§√§n tasoittain)
  tauEff:0.16,   // P_eff low-pass (100‚Äì160 ms)
};

/* ===== Loppuruutu + jakaminen ===== */
function finalRank(total){
  if(total >= 1000) return 'Silkkik√§si Suurmestari üèÜ';
  if(total >= 750)  return 'Paine-sommelier Pro ü•á';
  if(total >= 500)  return 'Raju r√§pp√§ri (sert.) ü•à';
  return 'Letku-loko (harjoittelija) üõ†Ô∏è';
}
function showFinal(){
  $('finalScore').textContent = G.totalScore.toString();
  $('finalTitle').textContent = finalRank(G.totalScore);
  $('finalOverlay').classList.remove('hidden');
}
function hideFinal(){ $('finalOverlay').classList.add('hidden'); }
function showToast(msg='Kopioitu'){
  const t=$('toast'); t.textContent=msg; t.classList.remove('hidden');
  clearTimeout(showToast._t); showToast._t=setTimeout(()=>t.classList.add('hidden'), 1600);
}
async function shareResult(){
  const title = $('finalTitle').textContent;
  const score = G.totalScore;
  const text = `Paineisku-Stopperi ‚Äì ${title}, pisteet: ${score} (10/10) ‚Äì Villen koodailut`;
  const url = location.href;
  try{
    if(navigator.share){ await navigator.share({title:'Paineisku-Stopperi', text, url}); showToast('Jaettu'); }
    else if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(`${text}\n${url}`); showToast('Kopioitu'); }
    else{ const ta=document.createElement('textarea'); ta.value=`${text}\n${url}`; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); showToast('Kopioitu'); }
  }catch(e){ showToast('Jakaminen ep√§onnistui'); }
}
$('newGameBtn').addEventListener('click', ()=>{ hideFinal(); G.totalScore = 0; setLevel(1); });
$('closeFinalBtn').addEventListener('click', ()=> hideFinal());
$('shareBtn').addEventListener('click', ()=> shareResult());

/* ===== Level config ===== */
function setLevel(lv){
  G.level = lv;

  // Perus (voit viel√§ s√§√§t√§√§ omilla arvoillasi)
  G.Kv=1.2; G.C=4.0; G.kf=0.12; G.kSurge=0.9; G.rSoft=0.12; G.gamma=1.4;
  G.P_limit=1.22; G.tLimit=22; G.demandAmp=0.07; G.demandHz=0.06; G.jitter=0.0;
  G.spikeTimer=0; G.spikeAmp=0;

  // Avustus vain Taso 1 ‚Äì ja nopeana, jotta VOI ep√§onnistua
  G.useLimiter = (lv===1);
  if(G.useLimiter){ G.slewUp=1.10; G.slewDown=1.80; } // ~1 s t√§ydest√§ kiinni/auki

  // Inhimillinen aikavakio P_eff: lv1 hitaampi ‚Üí lv10 nopeampi
  G.tauEff = (lv<=2)?0.16 : (lv<=4)?0.14 : (lv<=7)?0.12 : 0.10;

  // Tasoittain (haaste kasvaa)
  if(lv===1){ G.C=4.6; G.kSurge=1.05; G.P_limit=1.24; G.rSoft=0.09; G.tLimit=22; $('distText').textContent='pieni aalto'; }
  if(lv===2){ G.C=4.0; G.kSurge=1.20; G.P_limit=1.22; G.rSoft=0.08; G.tLimit=21; $('distText').textContent='pieni aalto'; }
  if(lv===3){ G.C=3.6; G.kSurge=1.35; G.P_limit=1.19; G.rSoft=0.075; G.tLimit=20; $('distText').textContent='aalto'; }
  if(lv===4){ G.C=3.3; G.kSurge=1.50; G.P_limit=1.17; G.rSoft=0.07; G.tLimit=19; $('distText').textContent='aalto'; }
  if(lv===5){ G.C=3.1; G.kSurge=1.65; G.P_limit=1.15; G.rSoft=0.06; G.tLimit=18; G.jitter=0.015; $('distText').textContent='aalto + h√§iri√∂'; }
  if(lv===6){ G.C=2.9; G.kSurge=1.80; G.P_limit=1.13; G.rSoft=0.055; G.tLimit=17; G.jitter=0.02;  $('distText').textContent='aalto + ‚Äúnyk√§ys‚Äù'; }
  if(lv===7){ G.C=2.7; G.kSurge=1.95; G.P_limit=1.11; G.rSoft=0.050; G.tLimit=16; G.demandAmp=0.12; $('distText').textContent='isompi aalto'; }
  if(lv===8){ G.C=2.6; G.kSurge=2.10; G.P_limit=1.09; G.rSoft=0.045; G.tLimit=15; G.demandAmp=0.14; G.jitter=0.03; $('distText').textContent='isompi aalto + h√§ly'; }
  if(lv===9){ G.C=2.5; G.kSurge=2.25; G.P_limit=1.07; G.rSoft=0.040; G.tLimit=14; G.demandAmp=0.16; G.jitter=0.035; $('distText').textContent='kova aalto + h√§ly'; }
  if(lv===10){G.C=2.4; G.kSurge=2.40; G.P_limit=1.05; G.rSoft=0.038; G.tLimit=13; G.demandAmp=0.18; G.jitter=0.04;  $('distText').textContent='mestaritaso'; }

  resetRound();
}

function resetRound(){
  G.v=0; G.vPrev=0; G.targetV=0; G.dvdt=0;
  G.P=0; G.P_eff=0; G.qDemand=0.55;
  G.t=0; G.exceeded=false; G.exceedCount=0; G.sinceExceed=0; G.excessArea=0;
  G.score=0; G.finished=false; G.running=true;

  // UI reset
  $('lvl').textContent=G.level;
  $('status').textContent='K√§ynniss√§‚Ä¶'; $('status').className='status warn';
  $('title').textContent='‚Äî';
  $('next').disabled=true;
  $('tLimitText').textContent = G.tLimit.toFixed(0)+' s';
  $('plText').textContent = G.P_limit.toFixed(2);
  $('assistText').textContent = G.useLimiter ? 'P√§√§ll√§' : 'Pois';
  $('knob').style.top = '100%';
  $('vText').textContent = '0%';
  $('openPct').textContent = '0%';

  placeLimitLine();
  updateUI(true);
}

function placeLimitLine(){
  const maxP=1.6, frac = clamp(G.P_limit/maxP, 0, 1);
  $('limit').style.top = ( (1-frac)*100 ) + '%';
}

/* ===== Input: drag asettaa targetV ===== */
const slider=$('slider'), knob=$('knob');
let dragging=false;
function setVFromY(clientY){
  const r = slider.getBoundingClientRect();
  const y = clamp(clientY, r.top+10, r.bottom-10);
  const frac = 1 - ( (y - (r.top+10)) / (r.height-20) ); // 0..1
  G.targetV = clamp(frac, 0, 1);
}
slider.addEventListener('pointerdown', (e)=>{ dragging=true; slider.setPointerCapture(e.pointerId); setVFromY(e.clientY); });
slider.addEventListener('pointermove', (e)=>{ if(dragging){ setVFromY(e.clientY); } });
slider.addEventListener('pointerup',   (e)=>{ dragging=false; try{ slider.releasePointerCapture(e.pointerId);}catch(_){} });
slider.addEventListener('pointercancel',(e)=>{ dragging=false; });

/* ===== Physics & loop ===== */
function step(){
  const dt = G.dt;
  if(G.running){
    // Kysynt√§
    const t = G.t;
    const noise = G.jitter ? (G.jitter*(Math.random()-0.5)) : 0;
    const wave = G.demandAmp*Math.sin(2*Math.PI*G.demandHz*t + 1.1);
    let spike = 0;
    if(G.level>=8 && Math.random()<0.05) spike += 0.08 + Math.random()*0.07;
    else if(G.level>=5 && Math.random()<0.03) spike += 0.06 + Math.random()*0.05;
    G.qDemand = clamp(0.55 + wave + noise + spike, 0.25, 0.98);

    // Venttiilin liike: taso 1 rajattu nopeasti, muut tasot v√§lit√∂n (haaste)
    if(G.useLimiter){
      const diff = G.targetV - G.v;
      const stepMax = (diff>0 ? G.slewUp : G.slewDown) * dt;
      if (Math.abs(diff) <= stepMax) G.v = G.targetV;
      else G.v += Math.sign(diff) * stepMax;
    } else {
      G.v = G.targetV; // ei rajoitinta
    }

    // dv/dt
    G.dvdt = (G.v - G.vPrev) / dt;

    // Takaisku-nyk√§ys (hard-tasoilla herkempi)
    if(G.level>=6 && G.dvdt > 0.30 && G.spikeTimer<=0){
      const ampBase = (G.level>=9 ? 0.18 : (G.level>=7 ? 0.15 : 0.12));
      G.spikeTimer = 0.10;
      G.spikeAmp = ampBase + Math.random()*0.08;
    }
    if(G.spikeTimer>0){ G.spikeTimer -= dt; if(G.spikeTimer<0) G.spikeTimer=0; }
    const P_bump = (G.spikeTimer>0 ? G.spikeAmp*(G.spikeTimer/0.10) : 0);

    // S√§ili√∂ + surge (surge ei en√§√§ loikkaa yhdell√§ framella)
    const q_in = G.Kv * G.v;
    const dPdt = (q_in - G.qDemand)/G.C - G.kf*G.P;
    G.P = clamp(G.P + dPdt * dt, 0, 1.8);

    const surge = Math.max(0, Math.abs(G.dvdt) - G.rSoft);
    // Low-passaa surge ‚Üí inhimillinen nousu
    if(!G._surgeLP) G._surgeLP = 0;
    G._surgeLP += aExp(dt, 0.12) * (surge - G._surgeLP); // ~120 ms
    const P_surge = G.kSurge * Math.pow(G._surgeLP, G.gamma);

    // P_eff: my√∂s low-pass (tasokohtainen aikavakio)
    const rawEff = clamp(G.P + P_surge + P_bump, 0, 1.8);
    G.P_eff += aExp(dt, G.tauEff) * (rawEff - G.P_eff);

    // Rajanylitys
    if(G.P_eff > G.P_limit){
      G.exceeded = true; G.sinceExceed = 0; G.exceedCount++;
      G.excessArea += (G.P_eff - G.P_limit)*dt;
      flashGauge(); beep(520 + Math.random()*60, .09, .22);
    } else { G.sinceExceed += dt; }

    // Aika & voitto
    const win = (G.v >= 0.95 && G.sinceExceed >= 1.5 && G.t < G.tLimit);
    G.t += dt;
    if(win){ finish(true); }
    if(G.t >= G.tLimit){ finish(false); }

    G.vPrev = G.v;
  }
  updateUI();
  requestAnimationFrame(step);
}
requestAnimationFrame(step);

function flashGauge(){
  const g=$('gauge'); g.classList.remove('flash'); void g.offsetWidth; g.classList.add('flash');
}

/* ===== Finish & scoring ===== */
function finish(success){
  if(G.finished) return;
  G.finished = true; G.running=false;

  const penaltyFactor = (G.level>=6 ? 380 : 320);
  const timeScore = Math.max(0, Math.round(100 * (G.tLimit - G.t) / G.tLimit));
  const penalty   = Math.round(penaltyFactor * G.excessArea);
  const smoothBonus = (G.exceedCount===0 ? 80 : 0);
  G.score = Math.max(0, timeScore - penalty + smoothBonus);
  G.totalScore += G.score;

  let title='Letku-leko üõ†Ô∏è';
  if(success && G.exceedCount===0 && G.t < 0.6*G.tLimit) title='Silkkik√§si üß§';
  else if(success && G.exceedCount===0) title='Paine-sommelier üç∑';
  else if(success) title='Raju r√§pp√§ri üö®';
  G.title = title;

  $('title').textContent = title;
  $('score').textContent = G.score;
  $('totScore').textContent = G.totalScore;

  $('status').textContent = success ? 'Taso suoritettu!' : 'Aika loppui';
  $('status').className = 'status ' + (success?'ok':'fail');

  // Viimeinen taso ‚Üí loppuruutu
  if(success && G.level >= G.maxLevel){
    $('next').disabled = true;
    showFinal(); return;
  }
  $('next').disabled = !success;
}

$('retry').onclick = ()=> resetRound();
$('next').onclick  = ()=>{ const n = (G.level>=G.maxLevel) ? 1 : (G.level+1); setLevel(n); };

/* ===== UI update ===== */
function updateUI(force=false){
  const maxP = 1.6;
  const frac = clamp(G.P_eff / maxP, 0, 1);
  $('fill').style.height = (frac*100)+'%';
  $('pText').textContent = G.P_eff.toFixed(2);
  $('time').textContent = (G.t).toFixed(1)+' / '+G.tLimit.toFixed(0)+' s';
  $('knob').style.top = (100 - G.v*100) + '%';
  $('vText').textContent = Math.round(G.v*100)+'%';
  $('openPct').textContent = Math.round(G.v*100)+'%';
  const s = Math.max(0, Math.abs(G.dvdt) - G.rSoft);
  const sFrac = clamp(s/(G.rSoft*3.2), 0, 1);
  $('spd').style.width = (sFrac*100)+'%';
  $('score').textContent = G.score; $('totScore').textContent = G.totalScore;
}

/* ===== Init ===== */
setLevel(1);
</script>
</body>
</html>
