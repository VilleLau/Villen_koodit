<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Paineisku-Stopperi üö´üí• ‚Äì Villen koodailut</title>
<style>
  :root{
    --bg:#0b1020; --panel:#0f172e; --ink:#eaf2ff; --muted:#a6bdd6;
    --accent:#39d353; --warn:#ffd166; --danger:#ff627d;
    --radius:18px; --shadow:0 12px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1200px 600px at 15% -10%, rgba(94,160,255,.10), transparent 60%), #0b1020;
    color:var(--ink); font:16px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    display:flex; align-items:center; justify-content:center; padding:14px;
    user-select:none; -webkit-tap-highlight-color: transparent;
  }
  .wrap{width:min(1200px,100%); display:grid; gap:14px}
  header, footer{
    background:linear-gradient(180deg,#111a33,#0f1730 55%,#0c142a);
    border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:10px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  header .brand{font-weight:900; letter-spacing:.2px}
  header .sub{opacity:.7; font-weight:600}
  footer{justify-content:center; font-size:13px; color:#cfdcff}

  /* LAYOUT */
  .game{
    display:grid; gap:14px;
    grid-template-columns: 1.4fr 1fr; /* mittari iso */
  }
  @media (max-width:980px){
    .game{grid-template-columns:1fr}
  }
  .panel{
    background:linear-gradient(180deg,var(--panel),#0b1327 60%,#0a1122);
    border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:14px;
  }

  /* LEFT: mittarit */
  .meterWrap{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
  @media (max-width:980px){ .meterWrap{grid-template-columns:1fr} }

  .meterCard{
    display:grid; gap:10px; padding:12px; border:1px solid rgba(255,255,255,.06); border-radius:14px;
    background:linear-gradient(180deg,#0e1631,#0c152c)
  }

  .gauge{
    height:420px; position:relative; border-radius:14px; overflow:hidden;
    background:linear-gradient(180deg,#0a1124,#0b152e);
    border:1px solid rgba(255,255,255,.09);
  }
  .gauge .grid{
    position:absolute; inset:0; background-image:
      linear-gradient(to top, rgba(255,255,255,.06) 1px, transparent 1px);
    background-size: 100% 38px; opacity:.25;
  }
  .gauge .fill{
    position:absolute; left:0; bottom:0; width:100%; height:0%;
    background:linear-gradient(180deg, #2655ff, #4fd6ff);
    transition:height .08s linear;
  }
  .gauge .limit{
    position:absolute; left:0; right:0; height:2px; background:var(--warn);
    box-shadow:0 0 0 3px rgba(255,209,102,.18), 0 0 12px rgba(255,209,102,.6);
  }
  .gauge.flash{animation:gflash .6s ease}
  @keyframes gflash{
    0%{box-shadow:0 0 0 0 rgba(255,98,125,.0)}
    40%{box-shadow:0 0 0 8px rgba(255,98,125,.35)}
    100%{box-shadow:0 0 0 0 rgba(255,98,125,.0)}
  }
  .gTitle{display:flex; align-items:baseline; gap:8px; font-weight:800}
  .gTitle small{color:var(--muted); font-weight:600}

  .speedBox{display:grid; gap:8px}
  .bar{height:12px; background:#0a1230; border:1px solid rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
  .bar>div{height:100%; width:0%; background:linear-gradient(90deg,#4fd6ff,#ffab57)}
  .hint{color:#cfe1ff; opacity:.75; font-size:14px}

  /* RIGHT: ohjaus + stats */
  .rightCol{display:grid; gap:14px}
  .sliderCard{display:grid; grid-template-columns: 100px 1fr; gap:14px; align-items:center}
  @media (max-width:520px){ .sliderCard{grid-template-columns: 84px 1fr} }
  .slider{
    position:relative; width:84px; height:420px; border-radius:14px;
    background:linear-gradient(180deg,#0a1124,#0b152e); border:1px solid rgba(255,255,255,.08);
    touch-action:none; cursor:pointer;
  }
  .slider .track{position:absolute; left:50%; top:10px; bottom:10px; width:8px; transform:translateX(-50%); background:#17305f; border-radius:999px}
  .slider .knob{
    position:absolute; left:50%; transform:translate(-50%,-50%);
    width:68px; height:24px; border-radius:12px; background:linear-gradient(180deg,#1d3d7a,#17356a);
    border:1px solid rgba(255,255,255,.14); box-shadow:0 6px 12px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.08);
  }
  .sliderLabel{font-weight:800}
  .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
  .pill{
    padding:8px 10px; border:1px solid rgba(255,255,255,.08); border-radius:12px; background:#0c162e;
    display:flex; justify-content:space-between; align-items:center; gap:10px
  }
  .big{font-size:18px; font-weight:900}
  .score{font-size:20px; font-weight:900}
  .btnRow{display:flex; gap:8px; flex-wrap:wrap}
  .btn{
    border:1px solid rgba(255,255,255,.10); background:#0c152b; color:#e9f2ff; padding:10px 14px; border-radius:12px;
    cursor:pointer; font-weight:800; box-shadow:var(--shadow); font-size:16px
  }
  .btn:disabled{opacity:.6; cursor:not-allowed}
  .btn.primary{background:linear-gradient(180deg,#1b2f55,#122547)}
  .titleline{display:flex; justify-content:space-between; align-items:center}
  .titleline .lvl{opacity:.85; font-weight:800}
  .titleline .status{font-weight:800}
  .titleline .status.ok{color:#8ff0a6}
  .titleline .status.fail{color:#ff8599}
  .titleline .status.warn{color:#ffd166}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">Paineisku-Stopperi üö´üí• <span class="sub">‚Äì avaa nopeasti ilman piikki√§</span></div>
    <div class="sub">¬© <strong>Villen koodailut</strong></div>
  </header>

  <div class="game panel">
    <!-- LEFT: Mittarit -->
    <div class="meterWrap">
      <div class="meterCard">
        <div class="gTitle">Linjapaine <small>(eff.)</small></div>
        <div id="gauge" class="gauge">
          <div class="grid"></div>
          <div id="limit" class="limit" style="top:40%"></div>
          <div id="fill" class="fill" style="height:0%"></div>
        </div>
        <div class="grid2">
          <div class="pill">P_eff: <span id="pText" class="big">0.00</span></div>
          <div class="pill">P-raja: <span id="plText" class="big">‚Äî</span></div>
        </div>
        <div class="speedBox">
          <div> Avausnopeus </div>
          <div class="bar"><div id="spd"></div></div>
          <div class="hint">Vinkki: tasainen liike voittaa. Keltainen viiva = paineiskun raja.</div>
        </div>
      </div>

      <div class="meterCard">
        <div class="titleline">
          <div class="lvl">Taso <span id="lvl">1</span>/10</div>
          <div id="status" class="status warn">K√§ynniss√§‚Ä¶</div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div class="pill">Aika: <span id="time" class="big">‚Äî</span></div>
          <div class="pill">Avaus: <span id="openPct" class="big">0%</span></div>
        </div>
        <div class="pill" style="margin-top:8px; display:block">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <div>Pisteet (t√§m√§ taso)</div><div id="score" class="score">0</div>
          </div>
          <div style="opacity:.7; font-size:13px">Kokonaispisteet: <span id="totScore">0</span></div>
        </div>
        <div class="pill" style="margin-top:8px">Titteli: <span id="title" class="big">‚Äî</span></div>
        <div class="btnRow" style="margin-top:8px">
          <button id="retry" class="btn">‚ü≤ Uudestaan</button>
          <button id="next" class="btn primary" disabled>‚è≠ Seuraava taso</button>
        </div>
      </div>
    </div>

    <!-- RIGHT: Ohjaus -->
    <div class="rightCol">
      <div class="sliderCard pill">
        <div class="slider" id="slider">
          <div class="track"></div>
          <div id="knob" class="knob" style="top:100%"></div>
        </div>
        <div style="display:grid; gap:8px">
          <div class="sliderLabel">Venttiilin asento: <span id="vText" class="big">0%</span></div>
          <div class="hint">Ved√§ kahvaa yl√∂s ‚Üí avaa venttiili. Tavoite: 100% ilman rajan ylityst√§.</div>
          <div class="grid2">
            <div class="pill">H√§iri√∂: <span id="distText">pieni aalto</span></div>
            <div class="pill">Raja-aika: <span id="tLimitText">25 s</span></div>
          </div>
        </div>
      </div>
      <div class="pill">Pikalause: ‚ÄúAvaa hiljaa ‚Äì avausnopeus kasvattaa paineiskua.‚Äù</div>
    </div>
  </div>

  <footer>¬© <span id="year"></span> <strong>Villen koodailut</strong></footer>
</div>

<script>
/* ===== Utils ===== */
const $ = (id)=>document.getElementById(id);
$('year').textContent = new Date().getFullYear();
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

/* ===== Simple audio (beep on piikki) ===== */
let AC; function audio(){ if(!AC) AC=new (window.AudioContext||window.webkitAudioContext)(); return AC; }
function beep(freq=520, dur=0.12, vol=0.25){
  try{
    const ctx=audio(); const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type='square'; o.frequency.value=freq; g.gain.value=vol; o.connect(g).connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+dur);
  }catch(e){}
}

/* ===== Game State ===== */
const G = {
  level:1, maxLevel:10,
  v:0, vPrev:0, dvdt:0,
  P:0, P_eff:0, P_limit:1.2,
  Kv:1.2, C:4.0, kf:0.12, kSurge:0.9, rSoft:0.12, gamma:1.4,
  t:0, tLimit:25, dt:0.02,
  qDemand:0.55, demandAmp:0.06, demandHz:0.05, jitter:0.0,
  spikeTimer:0, spikeAmp:0,
  exceeded:false, exceedCount:0, sinceExceed:0, excessArea:0,
  running:true, finished:false,
  score:0, totalScore:0, title:'‚Äî',

  /* ===== Slew-limiter (uusi) ===== */
  targetV: 0,       // kahvalla asetettu tavoite
  slewUp: 0.18,     // max nosto-nopeus (osuutta/s), esim. 0.18 = 18 %/s
  slewDown: 0.50    // max lasku-nopeus (saa laskea nopeammin)
};

/* ===== Level definitions ===== */
function setLevel(lv){
  G.level = lv;
  // defaults
  G.Kv=1.2; G.C=4.0; G.kf=0.12; G.kSurge=0.9; G.rSoft=0.12; G.gamma=1.4;
  G.P_limit=1.20; G.tLimit=25; G.demandAmp=0.06; G.demandHz=0.05; G.jitter=0.0;
  G.spikeTimer=0; G.spikeAmp=0;

  if(lv===1){ G.C=5.5; G.kSurge=0.60; G.P_limit=1.30; G.demandAmp=0.04; $('distText').textContent='hyvin pieni aalto'; }
  if(lv===2){ G.C=5.0; G.kSurge=0.70; G.P_limit=1.28; G.demandAmp=0.06; $('distText').textContent='pieni aalto'; }
  if(lv===3){ G.C=3.6; G.kSurge=0.80; G.P_limit=1.25; G.tLimit=24; $('distText').textContent='pieni aalto'; }
  if(lv===4){ G.C=3.6; G.kSurge=1.00; G.P_limit=1.20; G.rSoft=0.10; G.tLimit=24; $('distText').textContent='pieni aalto'; }
  if(lv===5){ G.C=3.6; G.kSurge=1.05; G.P_limit=1.20; G.tLimit=23; G.jitter=0.015; $('distText').textContent='aalto + satunnaispiikkej√§'; }
  if(lv===6){ G.C=3.4; G.kSurge=1.10; G.P_limit=1.20; G.tLimit=22; G.jitter=0.02; $('distText').textContent='aalto + ‚Äútakaisku‚Äù-nyk√§ys'; }
  if(lv===7){ G.C=3.2; G.kSurge=1.20; G.P_limit=1.15; G.tLimit=20; G.demandAmp=0.10; $('distText').textContent='isompi aalto'; }
  if(lv===8){ G.C=3.2; G.kSurge=1.20; G.P_limit=1.15; G.tLimit=20; G.demandAmp=0.11; G.jitter=0.02; $('distText').textContent='isompi aalto + h√§ly'; }
  if(lv===9){ G.C=3.1; G.kSurge=1.30; G.P_limit=1.13; G.tLimit=19; G.demandAmp=0.12; G.jitter=0.03; $('distText').textContent='kova aalto + h√§ly'; }
  if(lv===10){ G.C=3.0; G.kSurge=1.40; G.P_limit=1.12; G.tLimit=18; G.demandAmp=0.14; G.jitter=0.04; $('distText').textContent='mestaritaso'; }

  // Hidasta dynamiikkaa globaalisti
  G.C *= 1.5;
  G.Kv *= 0.80;

  resetRound();
}
function resetRound(){
  G.v=0; G.vPrev=0; G.dvdt=0;
  G.targetV=0;                // my√∂s tavoite nollaan
  G.P=0; G.P_eff=0; G.qDemand=0.55;
  G.t=0; G.exceeded=false; G.exceedCount=0; G.sinceExceed=0; G.excessArea=0;
  G.score=0; G.finished=false; G.running=true;

  // Resetoi liukus√§√§timen ulkoasu alas (0 %)
  document.getElementById('knob').style.top = '100%';
  document.getElementById('vText').textContent = '0%';
  document.getElementById('openPct').textContent = '0%';
  $('lvl').textContent=G.level;

  $('status').textContent='K√§ynniss√§‚Ä¶'; $('status').className='status warn';
  $('title').textContent='‚Äî';
  $('next').disabled=true;
  $('tLimitText').textContent = G.tLimit.toFixed(0)+' s';
  $('plText').textContent = G.P_limit.toFixed(2);
  placeLimitLine();
  updateUI(true);
}
function placeLimitLine(){
  // gauge is 0..1.6 bar visuaalisesti
  const maxP=1.6;
  const frac = clamp(G.P_limit/maxP, 0, 1);
  $('limit').style.top = ( (1-frac)*100 ) + '%';
}

/* ===== Input: vertical drag slider (asettaa targetV) ===== */
const slider=$('slider'), knob=$('knob');
let dragging=false;
function setVFromY(clientY){
  const r = slider.getBoundingClientRect();
  const y = clamp(clientY, r.top+10, r.bottom-10);
  const frac = 1 - ( (y - (r.top+10)) / (r.height-20) ); // 0..1
  G.targetV = clamp(frac, 0, 1); // vain tavoite muuttuu
}
slider.addEventListener('pointerdown', (e)=>{ dragging=true; slider.setPointerCapture(e.pointerId); setVFromY(e.clientY); });
slider.addEventListener('pointermove', (e)=>{ if(dragging){ setVFromY(e.clientY); } });
slider.addEventListener('pointerup',   (e)=>{ dragging=false; try{ slider.releasePointerCapture(e.pointerId);}catch(_){} });
slider.addEventListener('pointercancel',(e)=>{ dragging=false; });

/* ===== Physics & loop ===== */
function step(){
  const dt = G.dt; // fixed step
  if(G.running){
    // Demand profile
    const t = G.t;
    const noise = G.jitter ? (G.jitter*(Math.random()-0.5)) : 0;
    const wave = G.demandAmp*Math.sin(2*Math.PI*G.demandHz*t + 1.1);
    // occasional spike (levels 5+)
    let spike = 0;
    if(G.level>=5 && Math.random()<0.02) spike += 0.06 + Math.random()*0.05;
    G.qDemand = clamp(0.55 + wave + noise + spike, 0.3, 0.95);

    /* Venttiili seuraa kahvaa rajoitetulla nopeudella (slew-limiter) */
    {
      const diff = G.targetV - G.v;
      const stepMax = (diff > 0 ? G.slewUp : G.slewDown) * dt;
      if (Math.abs(diff) <= stepMax) G.v = G.targetV;
      else G.v += Math.sign(diff) * stepMax;
    }

    // dv/dt todellisesta venttiilist√§
    G.dvdt = (G.v - G.vPrev) / dt;

    // Backflow ‚Äúnyk√§ys‚Äù on fast open (level 6+)
    if(G.level>=6 && G.dvdt > 0.40 && G.spikeTimer<=0){
      G.spikeTimer = 0.10; // 100 ms
      G.spikeAmp = 0.12 + Math.random()*0.08;
    }
    if(G.spikeTimer>0){ G.spikeTimer -= dt; if(G.spikeTimer<0) G.spikeTimer=0; }

    // Tank model (hitaampi alku: v^1.25)
    const q_in = G.Kv * Math.pow(G.v, 1.25);
    const dPdt = (q_in - G.qDemand)/G.C - G.kf*G.P;
    G.P += dPdt * dt;
    G.P = clamp(G.P, 0, 1.8);

    // Surge model
    const surge = Math.max(0, Math.abs(G.dvdt) - G.rSoft);
    const P_surge = G.kSurge * Math.pow(surge, G.gamma);
    const P_bump  = (G.spikeTimer>0 ? G.spikeAmp*(G.spikeTimer/0.10) : 0);
    G.P_eff = clamp(G.P + P_surge + P_bump, 0, 1.8);

    // Exceed handling
    if(G.P_eff > G.P_limit){
      G.exceeded = true;
      G.sinceExceed = 0;
      G.exceedCount++;
      G.excessArea += (G.P_eff - G.P_limit)*dt;
      flashGauge();
      beep(520 + Math.random()*60, .09, .2);
    } else {
      G.sinceExceed += dt;
    }

    // Win condition & time
    const win = (G.v >= 0.95 && G.sinceExceed >= 1.5 && G.t < G.tLimit);
    G.t += dt;
    if(win){ finish(true); }
    if(G.t >= G.tLimit){ finish(false); }

    G.vPrev = G.v;
  }
  updateUI();
  requestAnimationFrame(step);
}
requestAnimationFrame(step);

function flashGauge(){
  const g=$('gauge'); g.classList.remove('flash'); void g.offsetWidth; g.classList.add('flash');
}

/* ===== Finish & scoring ===== */
function finish(success){
  if(G.finished) return;
  G.finished = true; G.running=false;

  // Pisteet
  const timeScore = Math.max(0, Math.round(100 * (G.tLimit - G.t) / G.tLimit));
  const penalty   = Math.round(250 * G.excessArea);
  const smoothBonus = (G.exceedCount===0 ? 80 : 0);
  G.score = Math.max(0, timeScore - penalty + smoothBonus);
  G.totalScore += G.score;

  // Titteli
  let title='Letku-leko üõ†Ô∏è';
  if(success && G.exceedCount===0 && G.t < 0.6*G.tLimit) title='Silkkik√§si üß§';
  else if(success && G.exceedCount===0) title='Paine-sommelier üç∑';
  else if(success) title='Raju r√§pp√§ri üö®';
  G.title = title;

  $('title').textContent = title;
  $('score').textContent = G.score;
  $('totScore').textContent = G.totalScore;

  $('status').textContent = success ? 'Taso suoritettu!' : 'Aika loppui';
  $('status').className = 'status ' + (success?'ok':'fail');

  $('next').disabled = !success;
}

$('retry').onclick = ()=> resetRound();
$('next').onclick  = ()=>{
  const n = (G.level>=G.maxLevel) ? 1 : (G.level+1);
  setLevel(n);
};

/* ===== UI update (n√§ytt√§√§ todellisen v:n) ===== */
function updateUI(force=false){
  // Gauge fill (visual scale 0..1.6)
  const maxP = 1.6;
  const frac = clamp(G.P_eff / maxP, 0, 1);
  $('fill').style.height = (frac*100)+'%';
  $('pText').textContent = G.P_eff.toFixed(2);
  $('time').textContent = (G.t).toFixed(1)+' / '+G.tLimit.toFixed(0)+' s';

  // Nuppi ja prosentit seuraavat todellista venttiili√§
  document.getElementById('knob').style.top = (100 - G.v*100) + '%';
  document.getElementById('vText').textContent = Math.round(G.v*100)+'%';
  document.getElementById('openPct').textContent = Math.round(G.v*100)+'%';

  // Speed bar (normalize to rSoft..rSoft*4)
  const s = Math.max(0, Math.abs(G.dvdt) - G.rSoft);
  const sFrac = clamp(s/(G.rSoft*3.2), 0, 1);
  $('spd').style.width = (sFrac*100)+'%';

  $('score').textContent = G.score;
  $('totScore').textContent = G.totalScore;
}

/* ===== Init ===== */
setLevel(1);
</script>
</body>
</html>
