<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PSSHT! Vuotojahti ü¶ä ‚Äì Villen koodailut</title>
<style>
  :root{
    --bg:#0b1020;--panel:#0f172e;--panel2:#0c1428;--muted:#9fb3c8;
    --accent:#39d353;--accent2:#5ea0ff;--warn:#ffb020;--danger:#ff4d6d;
    --radius:18px;--shadow:0 12px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:
      radial-gradient(1400px 700px at 15% -10%, rgba(94,160,255,.10), transparent 60%),
      radial-gradient(1200px 600px at 110% 10%, rgba(57,211,83,.08), transparent 60%),
      linear-gradient(#0b1020,#0b1020);
    color:#e8f0ff;font:16px/1.5 ui-monospace, Menlo, Consolas, "Liberation Mono", monospace;
    display:flex;align-items:center;justify-content:center;padding:14px;
  }
  .wrap{width:min(1200px,100%);display:grid;gap:14px}
  header{
    background:linear-gradient(180deg,#111a33,#0f1730 50%,#0c142a);
    border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow);
    padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px
  }
  .brand{display:flex;align-items:center;gap:10px;font-weight:800}
  .hdr-right{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{
    border:1px solid rgba(255,255,255,.10);background:#0c152b;color:#e9f2ff;padding:10px 14px;border-radius:12px;
    cursor:pointer;font-weight:800;letter-spacing:.2px;box-shadow:var(--shadow);font-size:16px
  }
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn:hover{border-color:rgba(255,255,255,.18);transform:translateY(-1px)}
  .btn.primary{background:linear-gradient(180deg,#1b2f55,#122547)}
  .toggle{display:inline-flex;gap:8px;align-items:center}
  .grid{display:grid;gap:14px;grid-template-columns:0.95fr 1.3fr 0.75fr}
  @media (max-width:1050px){.grid{grid-template-columns:1fr}}
  .panel{
    background:linear-gradient(180deg,var(--panel),#0b1327 60%,#0a1122);
    border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px
  }
  .title{margin:0 0 10px 0;color:var(--muted);font-size:15px;letter-spacing:.3px}
  /* CONTROL SIDE */
  .control-group{display:grid;gap:10px}
  .row{display:grid;grid-template-columns:120px 1fr 80px;gap:8px;align-items:center}
  .biggrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .pill{border:1px solid rgba(255,255,255,.10);background:#0b142a;border-radius:12px;padding:8px 10px;display:inline-flex;gap:8px;align-items:center}
  .sublist{display:flex;flex-wrap:wrap;gap:8px}
  .subbtn{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:#102040;cursor:pointer}
  .subbtn.on{background:#15325e;border-color:#3f6bd1}
  /* SCHEMATIC */
  svg{width:100%;height:auto;background:linear-gradient(180deg,#0e1630,#0b1226);border:1px solid rgba(255,255,255,.06);border-radius:14px}
  .pipe{fill:none;stroke:#7aa2ff88;stroke-linecap:round;stroke-linejoin:round}
  .node{fill:#0b1226;stroke:#8fb4ff66}
  .meter{fill:#0c162e;stroke:#ffffff22}
  .txt{fill:#cfe3ff;font-size:12px}
  .label{fill:#9fb3c8;font-size:12px}
  /* STATS */
  .statgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .card{background:linear-gradient(180deg,#0c162e,#0b1428);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:10px}
  .big{font-weight:800;font-size:18px}
  .ok{color:var(--accent);font-weight:800}
  .bad{color:var(--danger);font-weight:800}
  .bar{height:10px;background:#0a1120;border:1px solid rgba(255,255,255,.06);border-radius:10px;overflow:hidden}
  .bar>div{height:100%;background:linear-gradient(90deg,var(--accent),#7dffb0);width:0;transition:width .25s}
  .log{max-height:220px;overflow:auto;background:#0b1428;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:8px;font-size:13px;color:#cfe3ff}
  /* MODALS */
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:9999}
  .modal{width:min(720px,92%);max-height:86vh;overflow:auto;background:linear-gradient(180deg,#0f172e,#0b1327 60%,#0a1122);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px}
  /* FOOTER */
  footer{opacity:.85;color:#c9d8ff;text-align:center;font-size:13px}
  /* MOBILE EMPHASIS */
  .bigbtn{font-size:18px;padding:12px 14px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">PSSHT! Vuotojahti ü¶ä <span style="opacity:.6;font-weight:600">‚Äî Pneumavuoto-etsiv√§ (1‚Äì10)</span></div>
    <div class="hdr-right">
      <button id="helpBtn" class="btn">‚ùì Ohjeet</button>
      <label class="pill toggle"><input id="mute" type="checkbox"/> Mykist√§</label>
      <a class="btn" href="./index.html">‚¨Ö Etusivu</a>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT: CONTROLS -->
    <section class="panel">
      <h3 class="title">S√§√§d√∂t</h3>
      <div class="control-group">
        <div class="pill" style="justify-content:space-between;display:flex">
          <div>Valittu haara: <strong id="selBranch">A</strong> ‚Äì avautuma <strong id="selOpen">60%</strong></div>
          <div>Kierros: <strong id="round">1</strong>/10</div>
        </div>

        <div class="biggrid">
          <button class="btn bigbtn" id="minus10">‚àí10%</button>
          <button class="btn bigbtn" id="minus5">‚àí5%</button>
          <button class="btn bigbtn" id="plus5">+5%</button>
          <button class="btn bigbtn" id="plus10">+10%</button>
        </div>

        <div class="pill">Alahaarat (ON/OFF): <span id="subList" class="sublist"></span></div>

        <div class="biggrid">
          <button class="btn" id="hintBtn">üí° Vihje (‚àí10p)</button>
          <button class="btn primary" id="guessBtn">üïµÔ∏è Arvaa</button>
          <button class="btn" id="resetBtn">‚ü≤ Uudelleenkalibrointi</button>
          <button class="btn" id="nextBtn" disabled>‚è≠ Seuraava kierros</button>
        </div>

        <div id="quickHelp" class="pill" style="line-height:1.6">
          <strong>Pikaohje:</strong> s√§√§d√§ venttiilej√§ 5 % askelin ja tarkkaile Q<sub>tot</sub> & P<sub>haar</sub>. Vihje = ‚àí10p. 
          Energiasakko c<sub>E</sub>=0.02. My√∂hemmill√§ tasoilla drift & stuck valve. Erist√§ vuoto alahaaroilla (ON/OFF) ja tee arvaus.
        </div>
      </div>
    </section>

    <!-- CENTER: SCHEMATIC -->
    <section class="panel">
      <h3 class="title">Tehdashalli ‚Äì skeema</h3>
      <svg id="schem" viewBox="0 0 1000 520" role="img" aria-label="Kompressori, jakotukki ja haarat A‚ÄìF"></svg>
      <div class="pill" style="margin-top:8px">Klikkaa haaraa valitaksesi sen. Putken paksuus ~ virtaus. Mittarit n√§ytt√§v√§t haarapaineen.</div>
      <div id="log" class="log" style="margin-top:8px"></div>
    </section>

    <!-- RIGHT: STATS -->
    <aside class="panel">
      <h3 class="title">Mittarit & pisteet</h3>
      <div class="statgrid">
        <div class="card">
          <div>Q<sub>tot</sub></div>
          <div id="qtot" class="big">‚Äî</div>
          <div class="bar"><div id="qbar"></div></div>
        </div>
        <div class="card">
          <div>P<sub>header</sub></div>
          <div id="phead" class="big">‚Äî</div>
          <div class="bar"><div id="pbar"></div></div>
        </div>
        <div class="card">
          <div>Aika</div>
          <div id="time" class="big">‚Äî</div>
          <div class="bar"><div id="tbar"></div></div>
        </div>
        <div class="card">
          <div>Pisteet</div>
          <div id="score" class="big">0</div>
          <div class="pill">Energia: <span id="energy">0.0</span></div>
        </div>
      </div>

      <h3 class="title" style="margin-top:10px">Haarapaineet</h3>
      <div id="pressList" class="card" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px"></div>

      <h3 class="title" style="margin-top:10px">Tilanne</h3>
      <div class="card">
        <div>Vuotoja j√§ljell√§: <strong id="leaksLeft">‚Äî</strong></div>
        <div>Stuck valve? <strong id="stuckInfo">ei</strong></div>
        <div>Supply drift: <strong id="driftInfo">0%</strong></div>
      </div>
    </aside>
  </div>

  <footer>¬© <span id="year"></span> PSSHT! Vuotojahti ü¶ä ‚Äì <strong>Villen koodailut</strong></footer>
</div>

<!-- HELP MODAL -->
<div id="helpModal" class="overlay">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:800">PSSHT! Vuotojahti ü¶ä ‚Äì Ohjeet</div>
      <button id="helpClose" class="btn">‚úï</button>
    </div>
    <div style="color:#b8c8e6;line-height:1.6">
      <p><strong>Tavoite:</strong> paikanna <em>vuodon sijainti</em> (haara/alahara) ja <em>koko</em> (pieni/keskisuuri/suuri) mahdollisimman v√§hill√§ toimilla ja pienell√§ energialla.</p>
      <h4 style="margin:10px 0 6px 0;color:#cfe3ff">Miten edet√§</h4>
      <ol>
        <li>S√§√§d√§ valittua haaraa <strong>¬±5 %</strong> (¬±10 % nappi) ja tarkkaile <strong>Q<sub>tot</sub></strong> & haarapaineita.</li>
        <li>Erist√§ alahaaroja <strong>ON/OFF</strong> -napeilla (jos haarassa on alahaaroja).</li>
        <li>Kun olet varma, paina <strong>Arvaa</strong> ‚Üí valitse <em>haara</em>, (tarv.) <em>alahara</em> ja <em>koko</em>.</li>
      </ol>
      <h4 style="margin:10px 0 6px 0;color:#cfe3ff">S√§√§nn√∂t & pisteet</h4>
      <ul>
        <li>Perus +100p, oikea koko +30/+45/+60p, v√§√§r√§ ‚àí40p. Vihje ‚àí10p. Venttiilis√§√§t√∂ ‚àí1p/toimi.</li>
        <li>Aikaraja tasokohtainen; ylittyess√§ ‚àí20p. Energiasta sakko: ‚àí‚åä<strong>0.02</strong> ¬∑ ‚à´Q<sub>tot</sub>¬∑P<sub>h</sub> dt‚åã p.</li>
        <li>Tasoissa 7‚Äì10: <em>supply drift</em> (¬±3‚Äì5 %) ja joskus <em>stuck valve</em> (min 10‚Äì20 % auki).</li>
      </ul>
      <h4 style="margin:10px 0 6px 0;color:#cfe3ff">Vinkkej√§</h4>
      <ul>
        <li>Vuotava haara vaikuttaa usein eniten <strong>Q<sub>tot</sub></strong>:iin, kun sit√§ <em>suljetaan</em> v√§h√§n.</li>
        <li>Driftin aikana katso <strong>suhteellisia</strong> muutoksia (Œî ennen/j√§lkeen), ei absoluuttisia.</li>
        <li>Jos venttiili on ‚Äústuck‚Äù, sen sulkeminen ei muuta virtausta odotetusti ‚Üí ep√§ile ko. haaraa.</li>
      </ul>
      <div style="margin-top:10px;opacity:.8">Onnea mets√§stykseen ‚Äì tavoittele titteli√§ <strong>Nollavuoto-ninja ü•∑‚ö°</strong>!</div>
    </div>
  </div>
</div>

<!-- GUESS MODAL -->
<div id="guessModal" class="overlay">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:800">üïµÔ∏è Arvaa vuoto</div>
      <button id="guessClose" class="btn">‚úï</button>
    </div>
    <div style="display:grid;gap:10px">
      <div class="pill">Valitse haara:
        <select id="guessBranch"></select>
      </div>
      <div class="pill">Valitse alahaara (jos on):
        <select id="guessSub"></select>
      </div>
      <div class="pill">Koko:
        <select id="guessSize">
          <option value="small">pieni</option>
          <option value="medium" selected>keskisuuri</option>
          <option value="large">suuri</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="guessSubmit" class="btn primary">Vahvista arvaus</button>
        <button id="guessAnother" class="btn">Lis√§√§ toinen arvaus</button>
      </div>
      <div id="guessInfo" class="pill">Vihje: jos haaralla on 2 alahaaraa (A1/A2), p√§√§ttele kumpi eristym√§ll√§.</div>
    </div>
  </div>
</div>

<script>
/* ===== Utilities ===== */
const $ = (id)=>document.getElementById(id);
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
$('year').textContent = new Date().getFullYear();

/* ===== Sound (WebAudio) ===== */
let AC; let muted=false;
function initAudio(){ if(!AC){ AC=new (window.AudioContext||window.webkitAudioContext)(); } }
function playPssht(){
  if(muted) return; initAudio();
  const dur=0.12; const n=AC.createBuffer(1, AC.sampleRate*dur, AC.sampleRate);
  const d=n.getChannelData(0);
  for(let i=0;i<d.length;i++){ d[i]=(Math.random()*2-1)*Math.exp(-i/(d.length*0.7)); }
  const src=AC.createBufferSource(); src.buffer=n;
  const g=AC.createGain(); g.gain.setValueAtTime(0.25, AC.currentTime); g.gain.exponentialRampToValueAtTime(0.001, AC.currentTime+dur);
  src.connect(g).connect(AC.destination); src.start();
}
function playBubble(){
  if(muted) return; initAudio();
  const o=AC.createOscillator(); const g=AC.createGain();
  o.type='sine'; o.frequency.setValueAtTime(500,AC.currentTime);
  o.frequency.exponentialRampToValueAtTime(1200,AC.currentTime+0.08);
  g.gain.setValueAtTime(0.2,AC.currentTime); g.gain.exponentialRampToValueAtTime(0.0001,AC.currentTime+0.2);
  o.connect(g).connect(AC.destination); o.start(); o.stop(AC.currentTime+0.21);
}
$('mute').addEventListener('change',e=>{ muted=e.target.checked; });

/* ===== Game State ===== */
const G = {
  level:1, round:1, score:0, timeLeft:90, timeMax:90, dt:0.2,
  Ps:3.0, // base supply pressure
  alpha:0.08, n:1.6, cE:0.02,
  driftAmp:0, driftHz:0, stuckInfo:false,
  branches:[], // [{name:'A', open:0.6, Kvs:1.0, r:0.6, stuckMin:0.0, subs:[{name:'A1', on:true}], meterP:0, flow:0}]
  leaks:[], // [{b:0, sub:null or 0.., size:'small|medium|large', K:... , found:false}]
  energy:0, qtot:0, phead:0,
  selected:0, actions:0, leaksFound:0, finished:false
};
const BRN=['A','B','C','D','E','F'];

/* ===== Physics ===== */
// Given phead and state, compute branch flows (demand) and leak flows, return {qtot, branchP[]}
function branchFlowForP(phead, br){
  // Demand through branch valve (independent of subs; subs only gate leaks in this model)
  const open = Math.max(br.open, br.stuckMin);
  const K = br.Kvs * Math.pow(clamp(open,0,1), G.n);
  // Solve series loss: Q = K*sqrt(p_i), p_i = phead - r*Q^2 => Q^2(1 + K^2 r) = K^2 phead
  const denom = 1 + K*K*br.r;
  const q = K * Math.sqrt(Math.max(0, phead) / Math.max(1e-9, denom));
  // Local branch pressure after loss:
  const p_i = Math.max(0, phead - br.r*q*q);
  let qLeak = 0;
  // Leaks in this branch (at branch-level or sub-level if sub ON)
  for(const L of G.leaks){
    if(L.found) continue;
    if(L.b === br.idx){
      if(L.sub==null){
        qLeak += L.K * Math.sqrt(p_i);
      } else {
        const on = br.subs[L.sub] && br.subs[L.sub].on;
        if(on) qLeak += L.K * Math.sqrt(p_i);
      }
    }
  }
  return {qDemand:q, p_i, qLeak};
}

function networkGivenP(phead){
  let qtot=0; const branchP=[]; const branchQ=[];
  G.branches.forEach(br=>{
    const {qDemand, p_i, qLeak} = branchFlowForP(phead, br);
    branchP.push(p_i);
    branchQ.push(qDemand + qLeak);
    qtot += (qDemand + qLeak);
  });
  return {qtot, branchP, branchQ};
}

function solveNetwork(){
  // supply with drift
  const t = perfNow/1000;
  const PsDrift = G.Ps * (1 + G.driftAmp*Math.sin(2*Math.PI*G.driftHz*t)) + (G.driftAmp? (G.Ps*0.005*(Math.random()-0.5)):0);
  // solve phead in [0, PsDrift] such that phead = PsDrift - alpha*qtot(phead)^2
  let lo=0, hi=Math.max(0.1, PsDrift), mid=0;
  for(let it=0; it<40; it++){
    mid = 0.5*(lo+hi);
    const {qtot} = networkGivenP(mid);
    const f = mid - (PsDrift - G.alpha*qtot*qtot);
    if(Math.abs(f)<1e-4) break;
    const {qtot:ql} = networkGivenP(lo);
    const flo = lo - (PsDrift - G.alpha*ql*ql);
    if(Math.sign(flo)===Math.sign(f)) lo=mid; else hi=mid;
  }
  const {qtot, branchP, branchQ} = networkGivenP(mid);
  G.qtot=qtot; G.phead=mid;
  // store to branches
  G.branches.forEach((b,i)=>{ b.meterP=branchP[i]; b.flow=branchQ[i]; });
}

/* ===== Level Generator ===== */
function rand(a,b){ return a + Math.random()*(b-a); }
function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function levelConfig(level){
  // defaults from spec table
  const cfg = {
    time: 90 + Math.max(0, level-1)*6, // grows a bit
    driftAmp: 0, driftHz: 0.03 + level*0.002,
    leaks:1, leakPattern:'any', // 'any' | 'sameBranchTwo'
    sizes: ['medium'],
    noise: 0.015 + level*0.003,
    stuckMin: 0,
    subsPer: [0,0,0,0,0,0]
  };
  const subsVariants = [
    [0,0,0,0,0,0],
    [1,0,0,0,0,0],
    [1,1,0,0,0,0],
    [1,1,1,0,0,0],
    [2,1,1,0,0,0],
    [2,1,1,1,0,0],
    [2,2,1,1,0,0],
    [2,2,2,1,1,0],
    [2,2,2,2,1,1],
    [2,2,2,2,2,2],
  ];
  cfg.subsPer = subsVariants[Math.min(9, level-1)];

  if(level===1){ cfg.leaks=1; cfg.sizes=['medium']; }
  if(level===2){ cfg.leaks=1; cfg.sizes=['small','medium']; }
  if(level===3){ cfg.leaks=1; cfg.sizes=['small']; }
  if(level===4){ cfg.leaks=1; cfg.sizes=['small','large']; }
  if(level===5){ cfg.leaks=2; cfg.sizes=['small','medium']; cfg.driftAmp=0.01; }
  if(level===6){ cfg.leaks=2; cfg.sizes=['small','small']; cfg.driftAmp=0.02; }
  if(level===7){ cfg.leaks=2; cfg.sizes=['small','medium']; cfg.driftAmp=0.03; cfg.stuckMin=0.10; }
  if(level===8){ cfg.leaks=2; cfg.sizes=['small','small']; cfg.driftAmp=0.04; cfg.stuckMin=0.15; cfg.leakPattern='sameBranchTwo'; }
  if(level===9){ cfg.leaks=3; cfg.sizes=['small','medium','medium']; cfg.driftAmp=0.05; cfg.stuckMin=0.15; }
  if(level===10){ cfg.leaks=3; cfg.sizes=['small','medium','large']; cfg.driftAmp=0.05; cfg.stuckMin=0.20; }

  return cfg;
}

function sizeToK(size){
  if(size==='small') return rand(0.10,0.16);
  if(size==='medium') return rand(0.18,0.26);
  return rand(0.30,0.40); // large
}

function setupLevel(){
  const L = levelConfig(G.level);
  G.timeMax = L.time; G.timeLeft=L.time;
  G.driftAmp = L.driftAmp; G.driftHz = L.driftHz;
  G.energy=0; G.actions=0; G.leaksFound=0; G.finished=false;
  G.stuckInfo = L.stuckMin>0;

  // branches
  G.branches = [];
  for(let i=0;i<6;i++){
    const subsN = L.subsPer[i]||0;
    const subs=[];
    for(let s=0;s<subsN;s++) subs.push({name:BRN[i]+(s+1), on:true, Kvs: rand(0.4,0.8)});
    G.branches.push({
      idx:i, name:BRN[i],
      open: rand(0.5,0.8),
      Kvs: rand(0.9,1.2),
      r: rand(0.4,0.8),
      stuckMin: (Math.random()<0.25)? L.stuckMin : 0, // ei aina
      subs,
      meterP:0, flow:0
    });
  }
  G.selected = 0;

  // leaks
  G.leaks = [];
  if(L.leakPattern==='sameBranchTwo' && L.leaks===2){
    const bIdx = Math.floor(Math.random()*6);
    // Need at least 2 subs; if not, fallback to any
    if(G.branches[bIdx].subs.length>=2){
      const s1=0, s2=1;
      G.leaks.push({b:bIdx, sub:s1, size:L.sizes[0], K:sizeToK(L.sizes[0]), found:false});
      G.leaks.push({b:bIdx, sub:s2, size:L.sizes[1], K:sizeToK(L.sizes[1]), found:false});
    } else {
      // fallback random
      for(let k=0;k<L.leaks;k++){
        const bi=Math.floor(Math.random()*6);
        const subOpt = (G.branches[bi].subs.length? Math.floor(Math.random()*G.branches[bi].subs.length): null);
        G.leaks.push({b:bi, sub:subOpt, size:L.sizes[k]||'small', K:sizeToK(L.sizes[k]||'small'), found:false});
      }
    }
  } else {
    for(let k=0;k<L.leaks;k++){
      const bi=Math.floor(Math.random()*6);
      const subOpt = (Math.random()<0.55 && G.branches[bi].subs.length)? Math.floor(Math.random()*G.branches[bi].subs.length): null;
      G.leaks.push({b:bi, sub:subOpt, size:L.sizes[k]||'small', K:sizeToK(L.sizes[k]||'small'), found:false});
    }
  }
  // physics init
  solveNetwork();
  // UI
  renderSchematic();
  renderControls();
  log(`Uusi kierros ${G.level}/10. Vuotoja: ${G.leaks.length}.`);
  updateSide();
}

/* ===== Actions & UI ===== */
function log(t){ const el=$('log'); const ts=new Date().toLocaleTimeString(); el.innerHTML=`<div>‚Ä¢ ${t}</div>`+el.innerHTML; }

function renderControls(){
  $('round').textContent=G.level;
  $('selBranch').textContent = G.branches[G.selected].name;
  $('selOpen').textContent = Math.round(G.branches[G.selected].open*100)+'%';

  // subs
  const cont = $('subList'); cont.innerHTML='';
  const b = G.branches[G.selected];
  if(b.subs.length===0){ cont.textContent='(ei alahaaroja)'; }
  else b.subs.forEach((s,idx)=>{
    const btn=document.createElement('button');
    btn.className='subbtn '+(s.on?'on':'');
    btn.textContent = s.name + (s.on?' ON':' OFF');
    btn.onclick=()=>{
      s.on=!s.on; G.actions++; playPssht(); timeCost(1.0); scoreChange(-1);
      log(`${s.name} ‚Üí ${s.on?'ON':'OFF'}`);
      updateAll();
    };
    cont.appendChild(btn);
  });
}

function timeCost(sec){ G.timeLeft = Math.max(0, G.timeLeft - sec); }
function scoreChange(dp){ G.score = Math.max(0, G.score + dp); $('score').textContent=Math.round(G.score); }

function selectBranch(i){
  G.selected=i; renderControls(); highlightSelected();
}

$('minus5').onclick=()=>adjOpen(-0.05);
$('plus5').onclick =()=>adjOpen(+0.05);
$('minus10').onclick=()=>adjOpen(-0.10);
$('plus10').onclick =()=>adjOpen(+0.10);

function adjOpen(delta){
  const b = G.branches[G.selected];
  const before = b.open;
  b.open = clamp(b.open + delta, 0, 1);
  // stuck valve lower bound
  if(b.stuckMin>0 && b.open < b.stuckMin) b.open = b.stuckMin;
  if(Math.abs(b.open-before)<1e-6) { log(`Haaran ${b.name} venttiili ei en√§√§ liiku (stuck?)`); return; }
  G.actions++; playPssht(); timeCost(1.0); scoreChange(-1);
  log(`${b.name}: avautuma ${Math.round(before*100)}% ‚Üí ${Math.round(b.open*100)}%`);
  renderControls(); updateAll();
}

$('hintBtn').onclick=()=>{
  // branch sensitivity: virtual -5% on each open
  const baseQ = G.qtot;
  let bestI=0, bestDelta=-1;
  for(let i=0;i<G.branches.length;i++){
    const tmp = G.branches[i].open;
    const stuck = G.branches[i].stuckMin||0;
    G.branches[i].open = Math.max(stuck, clamp(tmp - 0.05, 0, 1));
    solveNetwork(); const d = baseQ - G.qtot;
    if(d > bestDelta){ bestDelta = d; bestI = i; }
    G.branches[i].open = tmp;
  }
  // sub-hint inside best branch: test toggling ON->OFF for each sub
  let subHint=null, subDelta=0;
  const b = G.branches[bestI];
  if(b.subs.length){
    const baseOn = b.subs.map(s=>s.on);
    for(let j=0;j<b.subs.length;j++){
      if(!b.subs[j].on) continue; // test only turning OFF
      b.subs[j].on=false; solveNetwork();
      const d = baseQ - G.qtot;
      if(d > subDelta){ subDelta = d; subHint = j; }
      b.subs[j].on = baseOn[j];
    }
  }
  // restore network value
  solveNetwork(); updateAll();
  scoreChange(-10); timeCost(1.5);
  const hintText = `Vihje: suurin vaikutus ${G.branches[bestI].name}${subHint!=null?('‚Üí'+G.branches[bestI].subs[subHint].name):''}.`;
  log(hintText);
  // flash highlight
  flashHint(bestI, subHint);
};

$('resetBtn').onclick=()=>{ // cosmetic ‚Äúre-zero‚Äù
  log('Uudelleenkalibrointi: mittarit nollattu hetkeksi.');
  playPssht(); // no score change
};

$('nextBtn').onclick=()=>{
  if(G.level>=10){ log('Peli l√§pi! Aloitetaan alusta.'); G.level=1; G.score=0; }
  else G.level++;
  setupLevel(); $('nextBtn').disabled=true;
};

/* ===== Guess UI ===== */
$('guessBtn').onclick=()=>openGuess();
$('guessClose').onclick=()=>$('guessModal').style.display='none';
$('guessAnother').onclick=()=>{ $('guessInfo').textContent='Voit tehd√§ toisen arvauksen samalla kierroksella (jos vuotoja on useampi).'; };
$('guessSubmit').onclick=submitGuess;

function openGuess(){
  const sel = $('guessBranch'); sel.innerHTML='';
  BRN.forEach((n,i)=>{
    const opt=document.createElement('option'); opt.value=String(i); opt.textContent=n; sel.appendChild(opt);
  });
  sel.value=String(G.selected);
  fillSubGuess(G.selected);
  $('guessSize').value='medium';
  $('guessModal').style.display='flex';
}
function fillSubGuess(bi){
  const subSel=$('guessSub'); subSel.innerHTML='';
  const b = G.branches[bi];
  const noneOpt=document.createElement('option'); noneOpt.value='-1'; noneOpt.textContent='(yl√§haara)'; subSel.appendChild(noneOpt);
  b.subs.forEach((s,idx)=>{ const o=document.createElement('option'); o.value=String(idx); o.textContent=s.name; subSel.appendChild(o); });
}
$('guessBranch').addEventListener('change', (e)=>{ fillSubGuess(Number(e.target.value)); });

function submitGuess(){
  const bi = Number($('guessBranch').value);
  const si = Number($('guessSub').value); // -1 for none
  const size = $('guessSize').value;
  const pretty = `${G.branches[bi].name}${si>=0?('‚Üí'+G.branches[bi].subs[si].name):''} (${size})`;
  // check against remaining leaks
  let ok=false, matchedIndex=-1;
  for(let i=0;i<G.leaks.length;i++){
    const L=G.leaks[i];
    if(L.found) continue;
    const subMatch = ( (si<0 && L.sub==null) || (si>=0 && L.sub===si) );
    if(L.b===bi && subMatch && L.size===size){
      ok=true; matchedIndex=i; break;
    }
  }
  if(ok){
    G.leaks[matchedIndex].found=true;
    G.leaksFound++;
    playBubble();
    const bonus = (size==='small'?30:(size==='medium'?45:60));
    scoreChange(100 + bonus); // perus + koko
    log(`‚úÖ Oikein: ${pretty}. +${100+bonus}p`);
    if(G.leaksFound >= G.leaks.length){
      finishRound(true);
      $('guessModal').style.display='none';
      return;
    } else {
      $('guessInfo').textContent=`Hyv√§! Vuoto l√∂ydetty (${G.leaksFound}/${G.leaks.length}). J√§ljell√§ viel√§ ${G.leaks.length-G.leaksFound}.`;
    }
  } else {
    scoreChange(-40);
    log(`‚ùå V√§√§r√§ arvaus: ${pretty} (‚àí40p)`);
  }
}

/* ===== Round End ===== */
function finishRound(success){
  if(G.finished) return;
  G.finished=true;
  // energy penalty
  const ePenalty = Math.floor(G.cE * G.energy);
  scoreChange(-ePenalty);
  // time bonus
  const tBonus = success ? Math.round(20 * (G.timeLeft/G.timeMax)) : 0;
  scoreChange(tBonus);
  // title
  const ePerSec = (G.energy/Math.max(1, (G.timeMax-G.timeLeft)));
  let title='Kompressorin kauhu üêä';
  if(ePerSec<0.15) title='Nollavuoto-ninja ü•∑‚ö°';
  else if(ePerSec<0.25) title='Vuotokettu ü¶ä';
  else if(ePerSec<0.35) title='Ilmamurhaaja üîß';

  log(`${success?'üéâ Kierros onnistui':'‚è± Aika loppui'} ‚Äî Titteli: <strong>${title}</strong> | Energiasakko ‚àí${ePenalty}p | Aikabonus +${tBonus}p`);
  $('nextBtn').disabled=false;
}

/* ===== Schematic Rendering ===== */
function renderSchematic(){
  const svg=$('schem'); svg.innerHTML='';
  // Main header & pump
  const g = (tag, attrs)=>{ const el=document.createElementNS('http://www.w3.org/2000/svg', tag); for(const k in attrs){ el.setAttribute(k, attrs[k]); } return el; };
  const group = g('g',{});
  // Pump
  group.appendChild(g('circle',{cx:500, cy:60, r:22, class:'node'}));
  group.appendChild(g('polygon',{points:'494,52 512,60 494,68', fill:'#5ea0ff'}));
  group.appendChild(g('rect',{x:430,y:18,width:140,height:30,rx:8,class:'meter'}));
  const t1=g('text',{x:438,y:38,class:'txt'}); t1.textContent='Pumppu ‚Ä¢ P_s + drift'; group.appendChild(t1);

  // Header trunk
  group.appendChild(g('path',{d:'M500 82 L500 120', class:'pipe', 'stroke-width':10}));
  group.appendChild(g('circle',{cx:500, cy:120, r:6, class:'node'}));

  // Six branches positions
  const x0=220, xstep=120, yTop=120, yBot=420;
  for(let i=0;i<6;i++){
    const x = x0 + i*xstep;
    // branch pipe
    const line = g('path',{id:`bline${i}`, d:`M500 120 L ${x} 180 L ${x} ${yBot}`, class:'pipe','stroke-width':8});
    line.style.cursor='pointer';
    line.addEventListener('click',()=>selectBranch(i));
    group.appendChild(line);
    // end node
    group.appendChild(g('circle',{cx:x, cy:yBot, r:7, class:'node'}));
    // meter
    group.appendChild(g('rect',{x:x-40, y:yBot+18, width:80, height:44, rx:8, class:'meter'}));
    const lbl=g('text',{x:x-30, y:yBot+36, class:'label'}); lbl.textContent=BRN[i]; group.appendChild(lbl);
    const ptxt=g('text',{id:`ptxt${i}`, x:x-30, y:yBot+56, class:'txt'}); ptxt.textContent='P=‚Äî'; group.appendChild(ptxt);

    // subs (draw small taps)
    const subs = G.branches[i].subs;
    for(let s=0;s<subs.length;s++){
      const sy = yBot - 70 - s*35;
      group.appendChild(g('circle',{cx:x, cy:sy, r:5, class:'node'}));
      const sp = g('path',{id:`subline${i}_${s}`, d:`M ${x} ${sy} L ${x+36} ${sy}`, class:'pipe', 'stroke-width': subs[s].on?6:2, stroke: subs[s].on?'#66ffc2aa':'#6ea8ff55'});
      sp.style.cursor='pointer';
      sp.addEventListener('click',()=>{
        selectBranch(i);
        subs[s].on = !subs[s].on; G.actions++; playPssht(); timeCost(1.0); scoreChange(-1);
        log(`${subs[s].name} ‚Üí ${subs[s].on?'ON':'OFF'}`);
        updateAll();
      });
      group.appendChild(sp);
      const stxt = g('text',{id:`subtxt${i}_${s}`, x:x+44, y:sy+4, class:'txt'}); stxt.textContent=subs[s].name; group.appendChild(stxt);
    }
  }
  svg.appendChild(group);
  highlightSelected();
  updateSchematicVisuals();
}

function highlightSelected(){
  for(let i=0;i<6;i++){
    const el = $('bline'+i);
    if(!el) continue;
    el.setAttribute('stroke', i===G.selected ? '#9ad1ff' : '#7aa2ff88');
  }
}

function updateSchematicVisuals(){
  // pipe width ~ flow, text ~ pressure
  let maxQ=0; G.branches.forEach(b=>{ if(b.flow>maxQ) maxQ=b.flow; });
  for(let i=0;i<6;i++){
    const b=G.branches[i];
    const w = clamp(6 + 26*(b.flow/Math.max(0.001,maxQ)), 6, 32);
    const el=$('bline'+i); if(el) el.setAttribute('stroke-width', w.toFixed(1));
    const pt=$('ptxt'+i); if(pt) pt.textContent=`P=${b.meterP.toFixed(2)}`;
    // subs stroke on/off
    b.subs.forEach((s,idx)=>{
      const sl=$(`subline${i}_${idx}`); if(sl){ sl.setAttribute('stroke-width', s.on?6:2); sl.setAttribute('stroke', s.on?'#66ffc2aa':'#6ea8ff55'); }
    });
  }
}

/* ===== Side Stats ===== */
function updateSide(){
  $('qtot').textContent=G.qtot.toFixed(3);
  $('phead').textContent=G.phead.toFixed(3);
  $('qbar').style.width = clamp( (G.qtot/ (6*1.5))*100, 0, 100)+'%';
  $('pbar').style.width = clamp( (G.phead/ (G.Ps*1.2))*100, 0, 100)+'%';
  $('energy').textContent = G.energy.toFixed(1);
  $('time').textContent = Math.ceil(G.timeLeft)+' s';
  $('tbar').style.width = clamp( (G.timeLeft/G.timeMax)*100, 0, 100)+'%';

  // pressures list
  const pl=$('pressList'); pl.innerHTML='';
  G.branches.forEach((b,i)=>{
    const d=document.createElement('div'); d.className='pill';
    d.style.cursor='pointer';
    d.onclick=()=>selectBranch(i);
    d.innerHTML = `<strong>${b.name}</strong>&nbsp; P=${b.meterP.toFixed(2)} ‚Ä¢ open=${Math.round(b.open*100)}%${b.stuckMin>0?' (min '+Math.round(b.stuckMin*100)+'%)':''}`;
    pl.appendChild(d);
  });

  $('leaksLeft').textContent = (G.leaks.length - G.leaksFound);
  $('stuckInfo').textContent = G.stuckInfo ? 'mahdollinen' : 'ei';
  $('driftInfo').textContent = (G.driftAmp*100).toFixed(0)+'%';
  $('selBranch').textContent = G.branches[G.selected].name;
  $('selOpen').textContent = Math.round(G.branches[G.selected].open*100)+'%';
}

/* ===== Hint Flash ===== */
function flashHint(bi, si){
  const el=$('bline'+bi);
  if(el){ const old=el.getAttribute('stroke'); el.setAttribute('stroke','#ffd166'); setTimeout(()=>{ el.setAttribute('stroke',old); },900); }
  if(si!=null){
    const sl=$(`subline${bi}_${si}`); if(sl){ const old=sl.getAttribute('stroke'); sl.setAttribute('stroke','#ffd166'); setTimeout(()=>{ sl.setAttribute('stroke',old); },900); }
  }
}

/* ===== Help Modal ===== */
$('helpBtn').onclick=()=>{ $('helpModal').style.display='flex'; };
$('helpClose').onclick=()=>{ $('helpModal').style.display='none'; };
$('helpModal').addEventListener('click',(e)=>{ if(e.target.id==='helpModal') e.currentTarget.style.display='none'; });

/* ===== Guess Modal open from controls ===== */
function perfms(){ return performance.now(); }

/* ===== Game Loop ===== */
let perfNow = performance.now();
function updateAll(){
  solveNetwork();
  updateSchematicVisuals();
  updateSide();
}
function gameTick(){
  perfNow = performance.now();
  if(!G.finished){
    // integrate energy
    G.energy += G.qtot * G.phead * G.dt;
    // time
    G.timeLeft -= G.dt;
    if(G.timeLeft<=0){
      G.timeLeft=0; finishRound(false);
    }
  }
  updateSide();
}
setInterval(gameTick, G.dt*1000);

/* ===== Init ===== */
setupLevel();
updateAll();

/* ===== Keyboard helpers ===== */
window.addEventListener('keydown',(e)=>{
  if(e.key==='ArrowLeft') adjOpen(-0.05);
  if(e.key==='ArrowRight') adjOpen(+0.05);
});

/* ===== Expose for select change ===== */
</script>
</body>
</html>
