<!doctype html>
<html lang="fi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Virtauslaskuri ¬∑ Villen koodailut</title>
    <link rel="icon" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50">
    <nav class="bg-white/80 backdrop-blur border-b">
      <div class="max-w-6xl mx-auto px-4 py-2 text-sm text-gray-600 flex items-center gap-3">
        <a href="index.html" class="hover:underline">‚Üê Etusivu</a>
        <span class="text-gray-300">|</span>
        <span>Virtauslaskuri</span>
      </div>
    </nav>

    <div id="root"></div>

    <!-- React & Babel (selaimen k√§√§nn√∂s JSX:st√§) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Sovellus -->
    <script type="text/babel">
      const { useState, useMemo, useEffect } = React;
      const LOGO_SRC = "logo.png"; // jos puuttuu ‚Üí kuva piilotetaan onError:illa

      // Materiaalit
      const materials = [
        { key: "pehd", label: "PE/HDPE (sile√§)", eps_mm: 0.0015 },
        { key: "pvc",  label: "PVC/PEX",        eps_mm: 0.0015 },
        { key: "kupari", label: "Kupari",       eps_mm: 0.0015 },
        { key: "ter√§s",  label: "Hiiliter√§s (kaupallinen)", eps_mm: 0.045 },
        { key: "rst",    label: "Ruostumaton ter√§s", eps_mm: 0.015 },
        { key: "valurauta", label: "Valurauta", eps_mm: 0.26 },
        { key: "betoni", label: "Betoni",       eps_mm: 0.3 },
      ];

      // Nesteet (+5 ¬∞C mukana)
      const fluids = [
        { key: "water", label: "Vesi", temps: [
          { t: 5,  rho: 1000.0, nu: 1.52e-6 },
          { t: 10, rho: 999.7, nu: 1.307e-6 },
          { t: 20, rho: 998.0, nu: 1.004e-6 },
          { t: 40, rho: 992.0, nu: 0.658e-6 },
          { t: 60, rho: 983.0, nu: 0.476e-6 },
        ]},
        { key: "sea", label: "Merivesi", temps: [
          { t: 5,  rho: 1027.0, nu: 1.5e-6 },
          { t: 20, rho: 1025.0, nu: 1.07e-6 },
          { t: 40, rho: 1020.0, nu: 0.72e-6 },
        ]},
        { key: "pg30", label: "Propyleeniglykoli 30%", temps: [
          { t: 20, rho: 1036.0, nu: 3.8e-6 },
          { t: 40, rho: 1026.0, nu: 2.0e-6 },
          { t: 60, rho: 1014.0, nu: 1.2e-6 },
        ]},
        { key: "oil32", label: "Hydrauliikka√∂ljy ISO VG 32", temps: [
          { t: 20, rho: 870.0, nu: 150e-6 },
          { t: 40, rho: 860.0, nu: 32e-6 },
          { t: 60, rho: 850.0, nu: 12e-6 },
        ]},
      ];

      // Pienh√§vi√∂t (K)
      const minorComponents = [
        { key: "elbow90_std", label: "Mutka 90¬∞ (vakio)", K: 0.9 },
        { key: "elbow90_lr",  label: "Mutka 90¬∞ (loiva)", K: 0.2 },
        { key: "elbow45",     label: "Mutka 45¬∞", K: 0.4 },
        { key: "gate_open",   label: "Sulkuventtiili (auki)", K: 0.2 },
        { key: "globe_open",  label: "Globe/s√§√§t√∂venttiili (auki)", K: 10 },
        { key: "check_swing", label: "Takaiskuventtiili (heiluri)", K: 2.0 },
        { key: "tee_through", label: "T-haara (suora l√§pi)", K: 0.6 },
        { key: "tee_branch",  label: "T-haara (haara)", K: 1.8 },
        { key: "sudden_contr",label: "√Ñkillinen supistus", K: 0.5 },
        { key: "sudden_exp",  label: "√Ñkillinen laajennus", K: 1.0 },
      ];

      const dnList = [10,15,20,25,32,40,50,65,80,100,125,150,200,250,300];
      const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));

      // Aput
      const areaFromDmm = (dmm)=>{ const D=dmm/1000; return Math.PI*D*D/4; };
      const dmmFromArea  = (A)=>Math.sqrt(4*A/Math.PI)*1000;

      // Lukitusnappi ‚Äì suurennettu
      function LockButton({locked,onToggle,label}){
        return (
          <span className="inline-flex items-center gap-2">
            <button type="button" onClick={onToggle} aria-pressed={locked}
              className={`h-8 w-8 grid place-items-center rounded-lg border text-sm ${locked?'bg-gray-900 text-white border-gray-900':'bg-white border-gray-300 hover:bg-gray-50'}`}>
              {locked ? "üîí" : "üîì"}
            </button>
            <span>{label}</span>
          </span>
        );
      }

      // Mukautettu slider/number input: sallii tyhjent√§misen
      function SliderWithNumber({label,value,onChange,step=1,min=0,max=100,unit="",extra=null}){
        return (
          <div className="flex flex-col gap-2">
            <div className="flex items-end justify-between">
              <span className="text-sm text-gray-600">{label}</span>
              <div className="flex items-center gap-2 w-56">
                {/* number input ilman min/max -attribuutteja: tyhj√§ arvo sallittu */}
                <input type="number" step={step}
                  value={Number.isFinite(value)?value:""}
                  onChange={e=>{
                    const val = e.target.value;
                    if(val === "") onChange(NaN);
                    else {
                      const v=parseFloat(val);
                      if(!Number.isNaN(v)) onChange(v);
                    }
                  }}
                  onBlur={e=>{
                    const val = e.target.value;
                    if(val === "") return;
                    const v=parseFloat(val);
                    if(!Number.isNaN(v)) onChange(clamp(v,min,max));
                  }}
                  className="w-full rounded-xl border p-1.5 text-right" />
                <span className="text-gray-500 text-sm w-16 text-right">{unit}</span>
              </div>
            </div>
            <input type="range" step={step} min={min} max={max}
              value={Number.isFinite(value)?value:min}
              onChange={e=>onChange(parseFloat(e.target.value))}
              className="w-full" />
            {extra}
          </div>
        );
      }

      // NumberField: sallii tyhj√§ arvo, s√§ilytt√§√§ min/max advanced-kentiss√§
      function NumberField({label,value,onChange,step=1,min=0,max=Number.POSITIVE_INFINITY,unit="",hint="",disabled=false}){
        return (
          <label className="flex flex-col gap-1">
            <span className="text-sm text-gray-600">{label}</span>
            <div className="flex items-center gap-2">
              <input type="number" step={step} min={min} max={max}
                value={Number.isFinite(value)?value:""}
                onChange={e=>{
                  if(disabled) return;
                  const val = e.target.value;
                  if(val === "") onChange(NaN);
                  else {
                    const v=parseFloat(val);
                    if(!Number.isNaN(v)) onChange(v);
                  }
                }}
                onBlur={e=>{
                  if(disabled) return;
                  const val = e.target.value;
                  if(val === "") return;
                  const v=parseFloat(val);
                  if(!Number.isNaN(v)) onChange(clamp(v,min,max));
                }}
                disabled={disabled}
                className={`w-full rounded-xl border p-2 focus:outline-none focus:ring text-right ${disabled?'bg-gray-100 text-gray-500':''}`} />
              <span className="text-gray-500 w-14 text-right">{unit}</span>
            </div>
            {hint && <span className="text-xs text-gray-400">{hint}</span>}
          </label>
        );
      }

      function ResultRow({label,value,unit,digits=2}){
        const fmt = n => (Number.isFinite(n)? n.toLocaleString(undefined,{maximumFractionDigits:digits}) : "-");
        return (
          <div className="flex items-baseline justify-between border-b py-1">
            <span className="text-gray-600">{label}</span>
            <span className="font-semibold">{fmt(value)} <span className="text-gray-500 font-normal">{unit}</span></span>
          </div>
        );
      }

      function App(){
        // Oletukset: DN100, v=1.5 m/s, L=100 m, vesi 20¬∞C
        const [diameterMM,_setDiameterMM] = useState(100);
        const [velocity,_setVelocity]     = useState(1.5);
        const [length,setLength]          = useState(100);

        const [showAdvanced,setShowAdvanced] = useState(false);

        // Valitse, onko k√§ytt√§j√§n sy√∂tt√§m√§ nostokorkeus pumpun puolella (alkupaine) vai putken loppupaine.
        // "pump" tarkoittaa, ett√§ sy√∂tetty arvo on pumpun tuottama nostokorkeus. "end" tarkoittaa, ett√§ sy√∂tetty arvo on
        // haluttu nostokorkeus putken p√§√§ss√§, jolloin pumpun tuottama nostokorkeus lasketaan lis√§√§m√§ll√§ putkistoh√§vi√∂.
        const [headType,setHeadType] = useState("pump");

        // Fluidi
        const [fluidKey,setFluidKey]   = useState("water");
        const [fluidTemp,setFluidTemp] = useState(20);
        const [rho,setRho]             = useState(998);
        const [nu,setNu]               = useState(1.004e-6);
        const [overrideFluid,setOverrideFluid] = useState(false);

        // Materiaali/karheus
        const [materialKey,setMaterialKey] = useState("pehd");
        const selectedMat = useMemo(()=>materials.find(m=>m.key===materialKey),[materialKey]);
        const [epsMM,setEpsMM] = useState(selectedMat.eps_mm);

        // Pienh√§vi√∂t
        const [minorQtys,setMinorQtys] = useState(()=>Object.fromEntries(minorComponents.map(c=>[c.key,0])));
        const [customK,setCustomK]     = useState(0);
        const [customQty,setCustomQty] = useState(0);

        // S√§hk√∂ & k√§ytt√∂
        const [eff,setEff]             = useState(0.7);
        const [hours,setHours]         = useState(4000);
        const [energyPrice,setEnergyPrice] = useState(0.12);
        // Kokonaisenergian laskentaa varten: valintaruutu ja nostokorkeus
        const [showTotalEnergy,setShowTotalEnergy] = useState(false);
        // nostokorkeus (m) pumpun tuottamaa kokonaispainetta varten
        const [totalHead,setTotalHead] = useState(0);

        // Massavirta + lukitukset
        const [massFlow,_setMassFlow]  = useState(998*areaFromDmm(100)*1.5); // kg/s
        const [lockD,setLockD] = useState(false);
        const [lockV,setLockV] = useState(false);
        const [lockM,setLockM] = useState(false);

        useEffect(()=>setEpsMM(selectedMat.eps_mm),[materialKey]);

        // P√§ivit√§ fluidiominaisuudet presetist√§ (jos ei override)
        useEffect(()=>{
          if(overrideFluid) return;
          const f=fluids.find(x=>x.key===fluidKey); if(!f) return;
          const temps=f.temps.map(x=>x.t);
          const closest=temps.reduce((p,c)=>Math.abs(c-fluidTemp)<Math.abs(p-fluidTemp)?c:p,temps[0]);
          const rec=f.temps.find(x=>x.t===closest);
          setFluidTemp(closest); setRho(rec.rho); setNu(rec.nu);
          // jos ·πÅ lukittu, noudata lukituksia
          applyConstraints('D', diameterMM, lockD, lockV, lockM, rec.rho);
        },[fluidKey,fluidTemp,overrideFluid]);

        // Œ£K
        const sumK = useMemo(
          ()=> minorComponents.reduce((acc,c)=>acc + c.K*(minorQtys[c.key]||0),0) + (customK||0)*(customQty||0),
          [minorQtys,customK,customQty]
        );

        function setLocks(which){
          let d=lockD,v=lockV,m=lockM;
          if(which==='D') d=!d; else if(which==='V') v=!v; else m=!m;
          const count=[d,v,m].filter(Boolean).length;
          if(count>2){ d=(which==='D'); v=(which==='V'); m=(which==='M'); } // max 2 lukkoa
          setLockD(d); setLockV(v); setLockM(m);
          applyConstraints('D',diameterMM,d,v,m);
        }

        function applyConstraints(source, value, ld=lockD, lv=lockV, lm=lockM, rhoArg){
          const rhoUse = (typeof rhoArg==='number') ? rhoArg : rho;
          // Jos sy√∂tetty arvo ei ole numeerinen (esim. tyhj√§ kentt√§), asetetaan vastaava tila NaN ja ei muuteta muita arvoja.
          if(!Number.isFinite(value)){
            if(source === 'D') _setDiameterMM(value);
            else if(source === 'V') _setVelocity(value);
            else if(source === 'M') _setMassFlow(value);
            return;
          }
          let d=diameterMM, v=velocity, m=massFlow;
          if(source==='D') d=value;
          if(source==='V') v=value;
          if(source==='M') m=value;

          const A=areaFromDmm(d);
          const lockedCount=[ld,lv,lm].filter(Boolean).length;

          if(lockedCount>=2){
            if(ld && lv){ m = rhoUse*v*A; }
            else if(ld && lm){ v = m/(rhoUse*A); }
            else if(lv && lm){ const Aneed = m/(rhoUse*v); d = dmmFromArea(Aneed); }
          } else if(lm){ // vain ·πÅ lukittu
            if(source==='D'){ v = m/(rhoUse*areaFromDmm(d)); }
            else if(source==='V'){ const Aneed = m/(rhoUse*v); d = dmmFromArea(Aneed); }
            else { v = m/(rhoUse*areaFromDmm(d)); }
          } else if(lv){ // vain v lukittu
            if(source==='D'){ m = rhoUse*v*areaFromDmm(d); }
            else if(source==='M'){ const Aneed = m/(rhoUse*v); d = dmmFromArea(Aneed); }
          } else if(ld){ // vain D lukittu
            if(source==='V'){ m = rhoUse*v*areaFromDmm(d); }
            else if(source==='M'){ v = m/(rhoUse*areaFromDmm(d)); }
          } else { // ei lukkoja
            if(source==='M'){ v = m/(rhoUse*areaFromDmm(d)); }
            else { m = rhoUse*v*areaFromDmm(d); }
          }

          // √Ñl√§ rajoita minimihalkaisijaa 5 mm: sallitaan pienemm√§t arvot, jotta k√§ytt√§j√§ voi kirjoittaa vapaasti. Minimi 1 mm.
          d = clamp(d,1,1000);
          v = clamp(v,0,10);
          m = clamp(m,0,2000);

          _setDiameterMM(Number(d.toFixed(3)));
          _setVelocity(Number(v.toFixed(4)));
          _setMassFlow(Number(m.toFixed(3)));
        }

        // Tulokset
        const results = useMemo(()=>{
          const D = diameterMM/1000;
          const A = Math.PI*D*D/4;
          const v = velocity;
          const Q = v*A;            // m¬≥/s
          const mdot = rho*Q;       // kg/s
          const Q_lpm = Q*1000*60;  // L/min
          const Q_m3h = Q*3600;     // m¬≥/h

          const Re = (v*D)/nu;
          const eps = epsMM/1000;
          let f = 0;
          if(Re>0 && Re<2300) f = 64/Re;
          else if(Re>=2300){
            const term = eps/(3.7*D) + 5.74/Math.pow(Re,0.9);
            f = 0.25/Math.pow(Math.log10(term),2);
          }

          const g = 9.80665;
          const hf_fric  = f*(length/D)*(v*v)/(2*g);
          const hf_minor = sumK*(v*v)/(2*g);
          const hf_total = hf_fric + hf_minor;

          const dp_total     = rho*g*hf_total;         // Pa
          const dp_bar_total = dp_total/1e5;           // bar

          // bar / 100 m (vain putkikitka)
          const hf_fric_100 = f*(100/D)*(v*v)/(2*g);
          const dp_bar_fric_100 = (rho*g*hf_fric_100)/1e5;

          const P_hyd = dp_total*Q;                    // W
          const P_in  = P_hyd/Math.max(0.01,eff);      // W
          const E_year_kWh = (P_in*hours)/1000;        // kWh/a
          const cost_year  = E_year_kWh*energyPrice;   // ‚Ç¨/a

          return { mdot,Q_lpm,Q_m3h, Re,f, hf_fric,hf_minor,hf_total, dp_bar_total, dp_bar_fric_100, P_hyd,P_in, E_year_kWh,cost_year };
        },[diameterMM,velocity,length,rho,nu,epsMM,eff,hours,energyPrice,sumK]);

        // Jos k√§ytt√§j√§ haluaa laskea nostokorkeuden vaikutuksen kokonaisenergian tarpeeseen,
        // lasketaan pumpun nostokorkeuden aiheuttama lis√§teho ja energia. N√§m√§ arvot
        // huomioidaan vain, jos showTotalEnergy on true.
        const A_head = areaFromDmm(diameterMM);
        const Q_head = velocity * A_head;                          // m¬≥/s
        // Laske pumpun ja loppupaineen nostokorkeudet sy√∂tt√∂tyypin perusteella.
        // pumpHeadM: pumpun tuottama nostokorkeus (m)
        // endHeadM: paineen nostokorkeus putken p√§√§ss√§ (m)
        const pumpHeadM = headType === "end" ? totalHead + results.hf_total : totalHead;
        const endHeadM  = headType === "end" ? totalHead : totalHead - results.hf_total;
        // Laske pumpun teho ja energia pumpun nostokorkeuden perusteella
        const headPowerHyd = rho * 9.80665 * pumpHeadM * Q_head;   // W (hydraulinen)
        const headPowerIn  = headPowerHyd / Math.max(0.01, eff);   // W (s√§hk√∂)
        const headEnergyYear = (headPowerIn * hours) / 1000;       // kWh/a
        const headCostYear   = headEnergyYear * energyPrice;       // ‚Ç¨/a
        // Yhteenlasketut arvot (h√§vi√∂t + nostokorkeus)
        const totalPowerHyd  = results.P_hyd + headPowerHyd;
        const totalPowerIn   = results.P_in  + headPowerIn;
        const totalEnergyYear= results.E_year_kWh + headEnergyYear;
        const totalCostYear  = results.cost_year + headCostYear;

        // Kokonaisnostokorkeus pumpulle on pumpun tuottama nostokorkeus (pumpHeadM).
        const totalLift = pumpHeadM;

        // M√§√§rit√§ DN-valinnan arvo: jos sis√§halkaisija ei t√§sm√§√§ vakiolistaan, n√§ytet√§√§n tyhj√§ (---)
        const dnSelectValue = dnList.includes(Number(diameterMM)) ? Number(diameterMM) : "";

        return (
          <div className="min-h-screen text-gray-900 p-4 sm:p-8">
            <div className="mx-auto max-w-6xl space-y-6">

              <header className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                <div className="flex items-center gap-3">
                  <img src={LOGO_SRC} alt="Villen koodailut" className="h-8 w-auto"
                       onError={e=>e.currentTarget.style.display='none'} />
                  <div>
                    <div className="text-xs text-gray-500 uppercase tracking-wide">Villen koodailut</div>
                    <h1 className="text-2xl sm:text-3xl font-bold">Virtauslaskuri</h1>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <button onClick={()=>setShowAdvanced(s=>!s)}
                          className="px-3 py-2 rounded-2xl border bg-white hover:bg-gray-50 text-sm"
                          aria-expanded={showAdvanced} aria-controls="advanced-panel">
                    {showAdvanced ? "Piilota tarkemmat tiedot" : "Tarkemmat tiedot"}
                  </button>
                </div>
              </header>

              <section className="bg-white p-4 sm:p-6 rounded-2xl shadow">
                <h2 className="font-semibold mb-4">Perusasetukset</h2>
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* Vasemman kolumnin ohjaimet */}
                  <div className="space-y-4">
                    <div className="space-y-1">
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-gray-600">DN-pikavalinta</span>
                        <span className="text-xs text-gray-400">ID‚âàDN mm (arvio)</span>
                      </div>
                      <select className="rounded-xl border p-2 w-full" value={dnSelectValue}
                              onChange={e=>applyConstraints('D', parseFloat(e.target.value))}>
                        <option value="">---</option>
                        {dnList.map(dn => <option key={dn} value={dn}>DN{dn}</option>)}
                      </select>
                    </div>

                    <SliderWithNumber
                      label={<LockButton locked={lockD} onToggle={()=>setLocks('D')} label="Sis√§halkaisija" />}
                      value={diameterMM}
                      onChange={v=>applyConstraints('D',v)}
                      step={1} min={1} max={1000} unit="mm"
                    />

                    <SliderWithNumber
                      label={<LockButton locked={lockV} onToggle={()=>setLocks('V')} label="Virtausnopeus" />}
                      value={velocity}
                      onChange={v=>applyConstraints('V',v)}
                      step={0.01} min={0} max={10} unit="m/s"
                    />

                    <SliderWithNumber
                      label={<LockButton locked={lockM} onToggle={()=>setLocks('M')} label="Massavirta" />}
                      value={massFlow}
                      onChange={v=>applyConstraints('M',v)}
                      step={0.01} min={0} max={2000} unit="kg/s"
                      extra={
                        <div className="text-xs text-gray-500 mt-1">
                          ‚âà {((massFlow/Math.max(1e-9,rho))*3600).toLocaleString(undefined,{maximumFractionDigits:2})} m¬≥/h ‚Ä¢
                          {((massFlow/Math.max(1e-9,rho))*60000).toLocaleString(undefined,{maximumFractionDigits:0})} L/min
                        </div>
                      }
                    />

                    <SliderWithNumber label="Putken pituus" value={length} onChange={setLength}
                                      step={1} min={0} max={5000} unit="m" />

                    {/* Kokonaisenergia-asetukset poistettu t√§lt√§ puolelta */}
                  </div>

                  {/* Oikean puolen tulokset */}
                  <div className="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="space-y-2">
                      <h3 className="text-sm uppercase tracking-wide text-gray-500">Virtaama</h3>
                      <ResultRow label="Massavirta ·πÅ" value={results.mdot} unit="kg/s" digits={3} />
                      <ResultRow label="Q" value={results.Q_lpm} unit="L/min" />
                      <ResultRow label="Q" value={results.Q_m3h} unit="m¬≥/h" />
                    </div>
                    <div className="space-y-2">
                      <h3 className="text-sm uppercase tracking-wide text-gray-500">Energia</h3>
                      {/* Putkistoh√§vi√∂t (kitka + pienh√§vi√∂t) */}
                      <div className="space-y-1">
                        <h4 className="font-medium text-gray-700">Putkistoh√§vi√∂t</h4>
                        <ResultRow label="Paineh√§vi√∂ yhteens√§" value={results.dp_bar_total} unit="bar" digits={2} />
                        <ResultRow label="Paineh√§vi√∂ / 100 m (putkikitka)" value={results.dp_bar_fric_100} unit="bar/100 m" digits={2} />
                        <ResultRow label="Hydraulinen teho" value={results.P_hyd/1000} unit="kW" />
                        <ResultRow label="S√§hk√∂teho" value={results.P_in/1000} unit="kW" />
                        <ResultRow label="Vuotuinen energia" value={results.E_year_kWh} unit="kWh/a" />
                        <ResultRow label="Vuotuinen kustannus" value={results.cost_year} unit="‚Ç¨ / a" digits={0} />
                      </div>
                      {/* Kokonaisenergia (pumppu + putkisto) - n√§ytet√§√§n oikealla sarakkeessa */}
                      <div className="mt-6 space-y-2 mb-8">
                        <div className="flex items-center gap-2">
                          <input id="showTotalEnergy" type="checkbox" checked={showTotalEnergy}
                                 onChange={e=>setShowTotalEnergy(e.target.checked)} />
                          <label htmlFor="showTotalEnergy" className="text-sm text-gray-700">Laske my√∂s nostokorkeus mukaan</label>
                        </div>
                        {showTotalEnergy && (
                          <>
                            {/* Valitse, onko sy√∂tetty arvo pumpun vai loppupaineen nostokorkeus. Valinta esitet√§√§n omalla rivill√§√§n. */}
                            <div className="flex flex-col gap-1 mb-2">
                              <label className="text-sm text-gray-600">Nostokorkeustyyppi</label>
                              <select className="rounded-xl border p-2 text-sm w-full" value={headType}
                                      onChange={e=>setHeadType(e.target.value)}>
                                <option value="pump">Alkupaine (pumpun nostokorkeus)</option>
                                <option value="end">Loppupaine (haluttu nostokorkeus putken p√§√§ss√§)</option>
                              </select>
                            </div>
                            <NumberField label={headType === 'pump' ? 'Pumpun nostokorkeus' : 'Loppupaineen nostokorkeus'}
                                         value={totalHead} onChange={setTotalHead}
                                         step={0.1} min={0} max={1000} unit="m"
                                         hint={headType === 'pump' ? 'Sy√∂t√§ pumpun tuottama nostokorkeus' : 'Sy√∂t√§ haluttu nostokorkeus putken p√§√§ss√§'} />
                            {/* N√§yt√§ pumpun ja loppupaineen nostokorkeus sek√§ putkiston nostoh√§vi√∂ isommalla tekstill√§ */}
                            <div className="mt-2 space-y-1">
                              <div className="text-sm font-medium text-gray-700">Pumpun nostokorkeus: {Number.isFinite(pumpHeadM) ? pumpHeadM.toLocaleString(undefined,{maximumFractionDigits:1}) : "-"} m</div>
                              <div className="text-sm font-medium text-gray-700">Loppupaineen nostokorkeus: {Number.isFinite(endHeadM) ? endHeadM.toLocaleString(undefined,{maximumFractionDigits:1}) : "-"} m</div>
                              <div className="text-sm font-medium text-gray-700">Putkiston nostoh√§vi√∂: {Number.isFinite(results.hf_total) ? results.hf_total.toLocaleString(undefined,{maximumFractionDigits:1}) : "-"} m</div>
                            </div>
                            <div className="bg-gray-50 border rounded-xl p-3 space-y-3">
                              <div className="grid grid-cols-4 gap-2 font-medium text-sm text-gray-700">
                                <div></div>
                                <div className="text-center">Pumppu</div>
                                <div className="text-center">Putkisto</div>
                                <div className="text-center">Yhteens√§</div>
                              </div>
                              <div className="grid grid-cols-4 gap-2 items-baseline">
                                <div className="text-gray-600">Hydraulinen teho</div>
                                <div className="text-right font-semibold">
                                  {(headPowerHyd/1000).toLocaleString(undefined,{maximumFractionDigits:2})} <span className="text-gray-500 font-normal">kW</span>
                                </div>
                                <div className="text-right font-semibold">
                                  {(results.P_hyd/1000).toLocaleString(undefined,{maximumFractionDigits:2})} <span className="text-gray-500 font-normal">kW</span>
                                </div>
                                <div className="text-right font-semibold">
                                  {(totalPowerHyd/1000).toLocaleString(undefined,{maximumFractionDigits:2})} <span className="text-gray-500 font-normal">kW</span>
                                </div>
                              </div>
                              <div className="grid grid-cols-4 gap-2 items-baseline">
                                <div className="text-gray-600">S√§hk√∂teho</div>
                                <div className="text-right font-semibold">
                                  {(headPowerIn/1000).toLocaleString(undefined,{maximumFractionDigits:2})} <span className="text-gray-500 font-normal">kW</span>
                                </div>
                                <div className="text-right font-semibold">
                                  {(results.P_in/1000).toLocaleString(undefined,{maximumFractionDigits:2})} <span className="text-gray-500 font-normal">kW</span>
                                </div>
                                <div className="text-right font-semibold">
                                  {(totalPowerIn/1000).toLocaleString(undefined,{maximumFractionDigits:2})} <span className="text-gray-500 font-normal">kW</span>
                                </div>
                              </div>
                              <div className="grid grid-cols-4 gap-2 items-baseline">
                                <div className="text-gray-600">Vuotuinen energia</div>
                                <div className="text-right font-semibold">
                                  {headEnergyYear.toLocaleString(undefined,{maximumFractionDigits:0})} <span className="text-gray-500 font-normal">kWh/a</span>
                                </div>
                                <div className="text-right font-semibold">
                                  {results.E_year_kWh.toLocaleString(undefined,{maximumFractionDigits:0})} <span className="text-gray-500 font-normal">kWh/a</span>
                                </div>
                                <div className="text-right font-semibold">
                                  {totalEnergyYear.toLocaleString(undefined,{maximumFractionDigits:0})} <span className="text-gray-500 font-normal">kWh/a</span>
                                </div>
                              </div>
                              <div className="grid grid-cols-4 gap-2 items-baseline">
                                <div className="text-gray-600">Vuotuinen kustannus</div>
                                <div className="text-right font-semibold">
                                  {headCostYear.toLocaleString(undefined,{maximumFractionDigits:0})} <span className="text-gray-500 font-normal">‚Ç¨ / a</span>
                                </div>
                                <div className="text-right font-semibold">
                                  {results.cost_year.toLocaleString(undefined,{maximumFractionDigits:0})} <span className="text-gray-500 font-normal">‚Ç¨ / a</span>
                                </div>
                                <div className="text-right font-semibold">
                                  {totalCostYear.toLocaleString(undefined,{maximumFractionDigits:0})} <span className="text-gray-500 font-normal">‚Ç¨ / a</span>
                                </div>
                              </div>
                            </div>
                          </>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              {showAdvanced && (
                <section id="advanced-panel" className="bg-white p-4 sm:p-6 rounded-2xl shadow space-y-6">
                  <h2 className="font-semibold">Tarkemmat tiedot</h2>
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="space-y-4">
                      <div className="flex flex-col gap-1">
                        <span className="text-sm text-gray-600">Neste</span>
                        <select className="rounded-xl border p-2" value={fluidKey} onChange={e=>setFluidKey(e.target.value)}>
                          {fluids.map(f => <option key={f.key} value={f.key}>{f.label}</option>)}
                        </select>
                      </div>

                      <div className="flex flex-col gap-1">
                        <span className="text-sm text-gray-600">L√§mp√∂tila (¬∞C)</span>
                        <select className="rounded-xl border p-2" value={fluidTemp}
                                onChange={e=>setFluidTemp(parseFloat(e.target.value))}>
                          {fluids.find(f=>f.key===fluidKey).temps.map(t => <option key={t.t} value={t.t}>{t.t} ¬∞C</option>)}
                        </select>
                      </div>

                      <div className="flex items-center gap-2">
                        <input id="overrideFluid" type="checkbox" checked={overrideFluid}
                               onChange={e=>setOverrideFluid(e.target.checked)} />
                        <label htmlFor="overrideFluid" className="text-sm text-gray-700">Yliaja nesteen ominaisuudet k√§sin</label>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <NumberField label="Tiheys œÅ" value={rho}
                                     onChange={v=>{ setRho(v); applyConstraints('D',diameterMM,lockD,lockV,lockM,v); }}
                                     step={1} min={100} max={2000} unit="kg/m¬≥" disabled={!overrideFluid} />
                        <NumberField label="Kin. viskositeetti ŒΩ" value={nu}
                                     onChange={setNu} step={1e-7} min={1e-7} max={1e-3} unit="m¬≤/s" disabled={!overrideFluid} />
                      </div>

                      <div className="flex flex-col gap-1">
                        <span className="text-sm text-gray-600">Putkimateriaali</span>
                        <select className="rounded-xl border p-2" value={materialKey}
                                onChange={e=>setMaterialKey(e.target.value)}>
                          {materials.map(m => <option key={m.key} value={m.key}>{m.label}</option>)}
                        </select>
                      </div>

                      <NumberField label="Karheus Œµ" value={epsMM} onChange={setEpsMM}
                                   step={0.001} min={0} max={1} unit="mm" />
                    </div>

                    <div className="space-y-4">
                      <NumberField label="Kokonais-hy√∂tysuhde Œ∑" value={eff} onChange={setEff}
                                   step={0.01} min={0.01} max={1} unit="-" hint="Pumppu √ó moottori, esim. 0.7" />
                      <NumberField label="K√§ytt√∂tunnit/a" value={hours} onChange={setHours}
                                   step={1} min={0} max={8760} unit="h" />
                      <NumberField label="S√§hk√∂n hinta" value={energyPrice} onChange={setEnergyPrice}
                                   step={0.001} min={0} max={10} unit="‚Ç¨/kWh" />
                      <div className="text-xs text-gray-500">Huomioi: alla n√§ytett√§v√§t tehot ja energiat perustuvat vain putkiston aiheuttamiin h√§vi√∂ihin (kitkasta ja pienh√§vi√∂ist√§).</div>


                      <div className="space-y-3">
                        <h3 className="font-medium">Pienh√§vi√∂t (komponentit)</h3>
                        <div className="space-y-2">
                          {minorComponents.map(c => (
                            <div key={c.key} className="flex items-center gap-2">
                              <div className="flex-1">
                                <div className="text-sm">{c.label}</div>
                                <div className="text-xs text-gray-500">K‚âà{c.K}</div>
                              </div>
                              <div className="flex items-center gap-1">
                                <button type="button" onClick={()=>setMinorQtys(q=>({...q,[c.key]: Math.max(0, Math.round((q[c.key]||0)-1))}))} className="px-2 py-2 rounded-xl border hover:bg-gray-50">‚àí</button>
                                <input type="number" min={0} step={1} className="w-20 rounded-xl border p-2 text-right"
                                  value={minorQtys[c.key]??0}
                                  onChange={e=>{ const n=Math.max(0, Math.round(parseFloat(e.target.value||"0"))); setMinorQtys(q=>({...q,[c.key]: n})); }} />
                                <button type="button" onClick={()=>setMinorQtys(q=>({...q,[c.key]: Math.max(0, (q[c.key]||0)+1)}))} className="px-2 py-2 rounded-xl border hover:bg-gray-50">+</button>
                              </div>
                            </div>
                          ))}
                        </div>

                        <div className="pt-3 border-t space-y-2">
                          <div className="text-sm font-medium">Oma komponentti</div>
                          <div className="flex items-center gap-3 flex-wrap">
                            <label className="flex items-center gap-2">
                              <span className="text-sm text-gray-600">K</span>
                              <input type="number" min={0} step={0.01} className="w-24 rounded-xl border p-2 text-right"
                                value={customK} onChange={e=>setCustomK(Math.max(0, parseFloat(e.target.value||"0")))}/>
                            </label>
                            <div className="flex items-center gap-1">
                              <button type="button" onClick={()=>setCustomQty(n=>Math.max(0, n-1))} className="px-2 py-2 rounded-xl border hover:bg-gray-50">‚àí</button>
                              <input type="number" min={0} step={1} className="w-20 rounded-xl border p-2 text-right"
                                value={customQty} onChange={e=>setCustomQty(Math.max(0, Math.round(parseFloat(e.target.value||"0"))))}/>
                              <button type="button" onClick={()=>setCustomQty(n=>Math.max(0, n+1))} className="px-2 py-2 rounded-xl border hover:bg-gray-50">+</button>
                            </div>
                            <div className="text-xs text-gray-500">K¬∑n = {(customK*customQty).toLocaleString(undefined,{maximumFractionDigits:2})}</div>
                          </div>
                        </div>

                        <div className="text-sm text-gray-700">
                          Œ£K = {(minorComponents.reduce((a,c)=>a + c.K*(minorQtys[c.key]||0),0) + (customK||0)*(customQty||0)).toLocaleString(undefined,{maximumFractionDigits:2})}
                        </div>
                      </div>
                    </div>

                    <div className="space-y-2">
                      <h3 className="text-sm uppercase tracking-wide text-gray-500">Diagnostiikka</h3>
                      <ResultRow label="Reynolds" value={results.Re} unit="-" digits={0} />
                      <ResultRow label="Kitkakerroin f" value={results.f} unit="-" digits={4} />
                      <ResultRow label="Pituush√§vi√∂ h_f" value={results.hf_fric} unit="m" digits={2} />
                      <ResultRow label="Pienh√§vi√∂t h_m" value={results.hf_minor} unit="m" digits={2} />
                      <ResultRow label="Yhteens√§ h_tot" value={results.hf_total} unit="m" digits={2} />
                      <ResultRow label="Œîp (bar)" value={results.dp_bar_total} unit="bar" digits={2} />
                    </div>
                  </div>
                </section>
              )}

              <footer className="text-center text-xs text-gray-400">¬©
                {new Date().getFullYear()} Villen koodailut ‚Ä¢ Virtauslaskuri
              </footer>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
