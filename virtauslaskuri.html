<!doctype html>
<html lang="fi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Virtauslaskuri · Jukkola Systems Oy</title>
    <link rel="icon" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style> html,body,#root { height:100%; } </style>
  </head>
  <body class="bg-gray-50">
    <nav class="bg-white/80 backdrop-blur border-b">
      <div class="max-w-6xl mx-auto px-4 py-2 text-sm text-gray-600 flex items-center gap-3">
        <a href="index.html" class="hover:underline">← Etusivu</a>
        <span class="text-gray-300">|</span>
        <span>Virtauslaskuri</span>
      </div>
    </nav>
    <div id="root"></div>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- App -->
    <script type="text/babel">
      const { useState, useMemo, useEffect } = React;
      const LOGO_SRC = "logo.png"; // vapaaehtoinen; jos puuttuu, piilotetaan kuva

      // --- Materiaalit ---
      const materials = [
        { key: "pehd", label: "PE/HDPE (sileä)", eps_mm: 0.0015 },
        { key: "pvc", label: "PVC/PEX", eps_mm: 0.0015 },
        { key: "kupari", label: "Kupari", eps_mm: 0.0015 },
        { key: "teräs", label: "Hiiliteräs (kaupallinen)", eps_mm: 0.045 },
        { key: "rst", label: "Ruostumaton teräs", eps_mm: 0.015 },
        { key: "valurauta", label: "Valurauta", eps_mm: 0.26 },
        { key: "betoni", label: "Betoni", eps_mm: 0.3 },
      ];

      // --- Nesteet (likiarvot) ---
      const fluids = [
        { key: "water", label: "Vesi", temps: [
          { t: 10, rho: 999.7, nu: 1.307e-6 },
          { t: 20, rho: 998.0, nu: 1.004e-6 },
          { t: 40, rho: 992.0, nu: 0.658e-6 },
          { t: 60, rho: 983.0, nu: 0.476e-6 },
        ]},
        { key: "sea", label: "Merivesi", temps: [
          { t: 20, rho: 1025.0, nu: 1.07e-6 },
          { t: 40, rho: 1020.0, nu: 0.72e-6 },
        ]},
        { key: "pg30", label: "Propyleeniglykoli 30%", temps: [
          { t: 20, rho: 1036.0, nu: 3.8e-6 },
          { t: 40, rho: 1026.0, nu: 2.0e-6 },
          { t: 60, rho: 1014.0, nu: 1.2e-6 },
        ]},
        { key: "oil32", label: "Hydrauliikkaöljy ISO VG 32", temps: [
          { t: 20, rho: 870.0, nu: 150e-6 },
          { t: 40, rho: 860.0, nu: 32e-6 },
          { t: 60, rho: 850.0, nu: 12e-6 },
        ]},
      ];

      // --- Pienhäviöt (K) ---
      const minorComponents = [
        { key: "elbow90_std", label: "Mutka 90° (vakio)", K: 0.9 },
        { key: "elbow90_lr", label: "Mutka 90° (loiva)", K: 0.2 },
        { key: "elbow45", label: "Mutka 45°", K: 0.4 },
        { key: "gate_open", label: "Sulkuventtiili (auki)", K: 0.2 },
        { key: "globe_open", label: "Globe/säätöventtiili (auki)", K: 10 },
        { key: "check_swing", label: "Takaiskuventtiili (heiluri)", K: 2.0 },
        { key: "tee_through", label: "T-haara (suora läpi)", K: 0.6 },
        { key: "tee_branch", label: "T-haara (haara)", K: 1.8 },
        { key: "sudden_contr", label: "Äkillinen supistus", K: 0.5 },
        { key: "sudden_exp", label: "Äkillinen laajennus", K: 1.0 },
      ];

      const dnList = [10,15,20,25,32,40,50,65,80,100,125,150,200,250,300];
      const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));

      function SliderWithNumber({label,value,onChange,step=1,min=0,max=100,unit=""}){
        return (
          <div className="flex flex-col gap-2">
            <div className="flex items-end justify-between">
              <span className="text-sm text-gray-600">{label}</span>
              <div className="flex items-center gap-2 w-44">
                <input type="number" step={step} min={min} max={max}
                  value={Number.isFinite(value) ? value : ""}
                  onChange={e=>{ const v=parseFloat(e.target.value); if(!Number.isNaN(v)) onChange(v); }}
                  onBlur={e=>{ const v=parseFloat(e.target.value); if(!Number.isNaN(v)) onChange(clamp(v,min,max)); }}
                  className="w-full rounded-xl border p-1.5 text-right" />
                <span className="text-gray-500 text-sm w-10">{unit}</span>
              </div>
            </div>
            <input type="range" step={step} min={min} max={max}
              value={Number.isFinite(value) ? value : min}
              onChange={e=>onChange(parseFloat(e.target.value))}
              className="w-full" />
          </div>
        );
      }

      function NumberField({label,value,onChange,step=1,min=0,max=Number.POSITIVE_INFINITY,unit="",hint="",disabled=false}){
        return (
          <label className="flex flex-col gap-1">
            <span className="text-sm text-gray-600">{label}</span>
            <div className="flex items-center gap-2">
              <input type="number" step={step} min={min} max={max}
                value={Number.isFinite(value) ? value : ""}
                onChange={e=>{ if(disabled) return; const v=parseFloat(e.target.value); if(!Number.isNaN(v)) onChange(v); }}
                onBlur={e=>{ if(disabled) return; const v=parseFloat(e.target.value); if(!Number.isNaN(v)) onChange(clamp(v,min,max)); }}
                disabled={disabled}
                className={`w-full rounded-xl border p-2 focus:outline-none focus:ring text-right ${disabled ? "bg-gray-100 text-gray-500" : ""}`} />
              <span className="text-gray-500 w-14 text-right">{unit}</span>
            </div>
            {hint && <span className="text-xs text-gray-400">{hint}</span>}
          </label>
        );
      }

      function ResultRow({label,value,unit,digits=2}){
        const fmt = n => (Number.isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:digits}) : "-");
        return (
          <div className="flex items-baseline justify-between border-b py-1">
            <span className="text-gray-600">{label}</span>
            <span className="font-semibold">{fmt(value)} <span className="text-gray-500 font-normal">{unit}</span></span>
          </div>
        );
      }

      function App(){
        // Oletukset: DN100, 1.5 m/s, 100 m, vesi 20 °C
        const [diameterMM,setDiameterMM]=useState(100);
        const [velocity,setVelocity]=useState(1.5);
        const [length,setLength]=useState(100);

        const [showAdvanced,setShowAdvanced]=useState(false);

        const [fluidKey,setFluidKey]=useState("water");
        const [fluidTemp,setFluidTemp]=useState(20);
        const [rho,setRho]=useState(998);
        const [nu,setNu]=useState(1.004e-6);
        const [overrideFluid,setOverrideFluid]=useState(false);

        const [materialKey,setMaterialKey]=useState("pehd");
        const selectedMat = useMemo(()=>materials.find(m=>m.key===materialKey),[materialKey]);
        const [epsMM,setEpsMM]=useState(selectedMat.eps_mm);

        const [minorQtys,setMinorQtys]=useState(()=>Object.fromEntries(minorComponents.map(c=>[c.key,0])));
        const [customK,setCustomK]=useState(0);
        const [customQty,setCustomQty]=useState(0);

        const [eff,setEff]=useState(0.7);
        const [hours,setHours]=useState(4000);
        const [energyPrice,setEnergyPrice]=useState(0.12);

        useEffect(()=>setEpsMM(selectedMat.eps_mm),[materialKey]);
        useEffect(()=>{ if(overrideFluid) return; const f=fluids.find(x=>x.key===fluidKey); if(!f) return;
          const temps=f.temps.map(x=>x.t);
          const closest=temps.reduce((p,c)=>Math.abs(c-fluidTemp)<Math.abs(p-fluidTemp)?c:p,temps[0]);
          const rec=f.temps.find(x=>x.t===closest);
          setFluidTemp(closest); setRho(rec.rho); setNu(rec.nu);
        },[fluidKey,fluidTemp,overrideFluid]);

        const sumK = useMemo(()=>
          minorComponents.reduce((acc,c)=>acc + c.K*(minorQtys[c.key]||0),0) + (customK||0)*(customQty||0),
          [minorQtys,customK,customQty]
        );

        const results = useMemo(()=>{
          const D=diameterMM/1000, A=Math.PI*D*D/4, Q=velocity*A, mdot=rho*Q;
          const Q_lpm=Q*1000*60, Q_m3h=Q*3600;
          const Re=(velocity*D)/nu, eps=epsMM/1000; let f=0;
          if(Re>0 && Re<2300) f=64/Re; else if(Re>=2300){ const term=eps/(3.7*D)+5.74/Math.pow(Re,0.9); f=0.25/Math.pow(Math.log10(term),2); }
          const g=9.80665, v=velocity;
          const hf_fric=f*(length/D)*(v*v)/(2*g), hf_minor=sumK*(v*v)/(2*g), hf_total=hf_fric+hf_minor;
          const dp_total=rho*g*hf_total, dp_bar_total=dp_total/1e5;
          const P_hyd=dp_total*Q, P_in=P_hyd/Math.max(0.01,eff);
          const E_year_kWh=(P_in*hours)/1000, cost_year=E_year_kWh*energyPrice;
          return { mdot,Q_lpm,Q_m3h, Re,f, hf_fric,hf_minor,hf_total, dp_total,dp_bar_total, P_hyd,P_in, E_year_kWh,cost_year, sumK };
        },[diameterMM,velocity,length,rho,nu,epsMM,eff,hours,energyPrice,sumK]);

        return (
          <div className="min-h-screen bg-gray-50 text-gray-900 p-4 sm:p-8">
            <div className="mx-auto max-w-6xl space-y-6">
              <header className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                <div className="flex items-center gap-3">
                  <img src={LOGO_SRC} alt="Jukkola Systems Oy" className="h-8 w-auto" onError={e=>e.currentTarget.style.display='none'} />
                  <div>
                    <div className="text-xs text-gray-500 uppercase tracking-wide">Jukkola Systems Oy</div>
                    <h1 className="text-2xl sm:text-3xl font-bold">Virtauslaskuri</h1>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <button onClick={()=>setShowAdvanced(s=>!s)} className="px-3 py-2 rounded-2xl border bg-white hover:bg-gray-50 text-sm">
                    {showAdvanced ? "Piilota tarkemmat tiedot" : "Tarkemmat tiedot"}
                  </button>
                </div>
              </header>

              <section className="bg-white p-4 sm:p-6 rounded-2xl shadow">
                <h2 className="font-semibold mb-4">Perusasetukset</h2>
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                  <div className="space-y-4">
                    <div className="space-y-1">
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-gray-600">DN-pikavalinta</span>
                        <span className="text-xs text-gray-400">ID≈DN mm (arvio)</span>
                      </div>
                      <select className="rounded-xl border p-2 w-full" value={diameterMM} onChange={e=>setDiameterMM(parseFloat(e.target.value))}>
                        {dnList.map(dn => <option key={dn} value={dn}>DN{dn}</option>)}
                      </select>
                    </div>
                    <SliderWithNumber label="Sisähalkaisija" value={diameterMM} onChange={setDiameterMM} step={1} min={5} max={1000} unit="mm" />
                    <SliderWithNumber label="Virtausnopeus" value={velocity} onChange={setVelocity} step={0.01} min={0} max={10} unit="m/s" />
                    <SliderWithNumber label="Putken pituus" value={length} onChange={setLength} step={1} min={0} max={5000} unit="m" />
                  </div>

                  <div className="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="space-y-2">
                      <h3 className="text-sm uppercase tracking-wide text-gray-500">Virtaama</h3>
                      <ResultRow label="Massavirta ṁ" value={results.mdot} unit="kg/s" digits={3} />
                      <ResultRow label="Q" value={results.Q_lpm} unit="L/min" />
                      <ResultRow label="Q" value={results.Q_m3h} unit="m³/h" />
                    </div>
                    <div className="space-y-2">
                      <h3 className="text-sm uppercase tracking-wide text-gray-500">Häviöt & energia</h3>
                      <ResultRow label="Painehäviö" value={results.dp_bar_total} unit="bar" digits={2} />
                      <ResultRow label="Hydrauliikkateho" value={results.P_hyd / 1000} unit="kW" />
                      <ResultRow label="Sähköteho" value={results.P_in / 1000} unit="kW" />
                      <ResultRow label="Vuotuinen energia" value={results.E_year_kWh} unit="kWh/a" />
                      <ResultRow label="Vuotuinen kustannus" value={results.cost_year} unit="€ / a" digits={0} />
                    </div>
                  </div>
                </div>
              </section>

              {showAdvanced && (
                <section id="advanced-panel" className="bg-white p-4 sm:p-6 rounded-2xl shadow space-y-6">
                  <h2 className="font-semibold">Tarkemmat tiedot</h2>

                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="space-y-4">
                      <div className="flex flex-col gap-1">
                        <span className="text-sm text-gray-600">Neste</span>
                        <select className="rounded-xl border p-2" value={fluidKey} onChange={e=>setFluidKey(e.target.value)}>
                          {fluids.map(f => <option key={f.key} value={f.key}>{f.label}</option>)}
                        </select>
                      </div>

                      <div className="flex flex-col gap-1">
                        <span className="text-sm text-gray-600">Lämpötila (°C)</span>
                        <select className="rounded-xl border p-2" value={fluidTemp} onChange={e=>setFluidTemp(parseFloat(e.target.value))}>
                          {fluids.find(f=>f.key===fluidKey).temps.map(t => <option key={t.t} value={t.t}>{t.t} °C</option>)}
                        </select>
                      </div>

                      <div className="flex items-center gap-2">
                        <input id="overrideFluid" type="checkbox" checked={overrideFluid} onChange={e=>setOverrideFluid(e.target.checked)} />
                        <label htmlFor="overrideFluid" className="text-sm text-gray-700">Yliaja nesteen ominaisuudet käsin</label>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <NumberField label="Tiheys ρ" value={rho} onChange={setRho} step={1} min={100} max={2000} unit="kg/m³" disabled={!overrideFluid} />
                        <NumberField label="Kin. viskositeetti ν" value={nu} onChange={setNu} step={1e-7} min={1e-7} max={1e-3} unit="m²/s" disabled={!overrideFluid} />
                      </div>

                      <div className="flex flex-col gap-1">
                        <span className="text-sm text-gray-600">Putkimateriaali</span>
                        <select className="rounded-xl border p-2" value={materialKey} onChange={e=>setMaterialKey(e.target.value)}>
                          {materials.map(m => <option key={m.key} value={m.key}>{m.label}</option>)}
                        </select>
                      </div>

                      <NumberField label="Karheus ε" value={epsMM} onChange={setEpsMM} step={0.001} min={0} max={1} unit="mm" />
                    </div>

                    <div className="space-y-4">
                      <NumberField label="Kokonais-hyötysuhde η" value={eff} onChange={setEff} step={0.01} min={0.01} max={1} unit="-" />
                      <NumberField label="Käyttötunnit/a" value={hours} onChange={setHours} step={1} min={0} max={8760} unit="h" />
                      <NumberField label="Sähkön hinta" value={energyPrice} onChange={setEnergyPrice} step={0.001} min={0} max={10} unit="€/kWh" />
                      <div className="text-xs text-gray-500">Sähköteho ja vuotuinen energia lasketaan kokonaishäviöistä ja η:stä.</div>

                      <div className="space-y-3">
                        <h3 className="font-medium">Pienhäviöt (komponentit)</h3>
                        <div className="space-y-2">
                          {minorComponents.map(c => (
                            <div key={c.key} className="flex items-center gap-2">
                              <div className="flex-1">
                                <div className="text-sm">{c.label}</div>
                                <div className="text-xs text-gray-500">K≈{c.K}</div>
                              </div>
                              <div className="flex items-center gap-1">
                                <button type="button" onClick={()=>setMinorQtys(q=>({...q,[c.key]: Math.max(0, Math.round((q[c.key]||0)-1))}))} className="px-2 py-2 rounded-xl border hover:bg-gray-50">−</button>
                                <input type="number" min={0} step={1} className="w-20 rounded-xl border p-2 text-right"
                                  value={minorQtys[c.key]??0}
                                  onChange={e=>{ const n=Math.max(0, Math.round(parseFloat(e.target.value||"0"))); setMinorQtys(q=>({...q,[c.key]: n})); }} />
                                <button type="button" onClick={()=>setMinorQtys(q=>({...q,[c.key]: Math.max(0, (q[c.key]||0)+1)}))} className="px-2 py-2 rounded-xl border hover:bg-gray-50">+</button>
                              </div>
                            </div>
                          ))}
                        </div>

                        <div className="pt-3 border-t space-y-2">
                          <div className="text-sm font-medium">Oma komponentti</div>
                          <div className="flex items-center gap-3 flex-wrap">
                            <label className="flex items-center gap-2">
                              <span className="text-sm text-gray-600">K</span>
                              <input type="number" min={0} step={0.01} className="w-24 rounded-xl border p-2 text-right"
                                value={customK} onChange={e=>setCustomK(Math.max(0, parseFloat(e.target.value||"0")))}/>
                            </label>
                            <div className="flex items-center gap-1">
                              <button type="button" onClick={()=>setCustomQty(n=>Math.max(0, n-1))} className="px-2 py-2 rounded-xl border hover:bg-gray-50">−</button>
                              <input type="number" min={0} step={1} className="w-20 rounded-xl border p-2 text-right"
                                value={customQty} onChange={e=>setCustomQty(Math.max(0, Math.round(parseFloat(e.target.value||"0"))))}/>
                              <button type="button" onClick={()=>setCustomQty(n=>Math.max(0, n+1))} className="px-2 py-2 rounded-xl border hover:bg-gray-50">+</button>
                            </div>
                            <div className="text-xs text-gray-500">K·n = {(customK*customQty).toLocaleString(undefined,{maximumFractionDigits:2})}</div>
                          </div>
                        </div>

                        <div className="text-sm text-gray-700">ΣK = {(minorComponents.reduce((a,c)=>a + c.K*(minorQtys[c.key]||0),0) + (customK||0)*(customQty||0)).toLocaleString(undefined,{maximumFractionDigits:2})}</div>
                      </div>
                    </div>

                    <div className="space-y-2">
                      <h3 className="text-sm uppercase tracking-wide text-gray-500">Diagnostiikka</h3>
                      <ResultRow label="Reynolds" value={results.Re} unit="-" digits={0} />
                      <ResultRow label="Kitkakerroin f" value={results.f} unit="-" digits={4} />
                      <ResultRow label="Pituushäviö h_f" value={results.hf_fric} unit="m" digits={2} />
                      <ResultRow label="Pienhäviöt h_m" value={results.hf_minor} unit="m" digits={2} />
                      <ResultRow label="Yhteensä h_tot" value={results.hf_total} unit="m" digits={2} />
                      <ResultRow label="Δp (bar)" value={results.dp_bar_total} unit="bar" digits={2} />
                    </div>
                  </div>
                </section>
              )}

              <footer className="text-center text-xs text-gray-400">© {new Date().getFullYear()} Jukkola Systems Oy • Virtauslaskuri</footer>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
