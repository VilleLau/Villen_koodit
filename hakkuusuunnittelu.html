<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hakkuusuunnittelu – Kalajoen pilotti</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/maplibre-gl@3.2.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.2.1/dist/maplibre-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root {
      color-scheme: dark light;
      --bg-dark: #0b1120;
      --panel-dark: rgba(15,23,42,0.86);
      --text-light: #e2e8f0;
      --accent: #38bdf8;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(56,189,248,0.15), transparent 55%),
                  radial-gradient(circle at 80% 0%, rgba(59,130,246,0.18), transparent 60%),
                  var(--bg-dark);
      color: var(--text-light);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    header h1 {
      font-size: clamp(1.2rem, 1.8vw + 1rem, 2.2rem);
      margin: 0;
      font-weight: 700;
    }
    header .user-info {
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: rgba(15,23,42,0.65);
      padding: 0.5rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.25);
    }
    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(280px, 2fr) minmax(320px, 28rem);
      gap: 1.2rem;
      padding: 0 1.5rem 1.5rem;
    }
    #map {
      width: 100%;
      border-radius: 1.25rem;
      overflow: hidden;
      box-shadow: 0 25px 45px rgba(15,23,42,0.38);
      min-height: 480px;
    }
    .panel {
      background: var(--panel-dark);
      border-radius: 1.25rem;
      padding: 1.25rem;
      border: 1px solid rgba(148,163,184,0.18);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      box-shadow: 0 18px 38px rgba(2,6,23,0.45);
    }
    .panel h2 {
      margin: 0;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .panel section {
      background: rgba(15,23,42,0.65);
      border-radius: 1rem;
      padding: 1rem;
      border: 1px solid rgba(148,163,184,0.18);
    }
    label span {
      font-size: 0.8rem;
      display: block;
      color: rgba(226,232,240,0.85);
    }
    input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(148,163,184,0.25);
      background: rgba(15,23,42,0.8);
      color: #f8fafc;
      font-size: 0.95rem;
    }
    input[type="range"] {
      width: 100%;
    }
    button {
      border: none;
      border-radius: 0.9rem;
      padding: 0.75rem 1rem;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: transform 0.16s ease, box-shadow 0.16s ease;
    }
    button.primary {
      background: linear-gradient(120deg, #38bdf8, #3b82f6);
      color: #0b1120;
      box-shadow: 0 12px 30px rgba(56,189,248,0.3);
    }
    button.secondary {
      background: rgba(30,41,59,0.9);
      color: #e2e8f0;
      border: 1px solid rgba(148,163,184,0.25);
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    .stand-card {
      margin-top: 0.75rem;
      border-radius: 0.9rem;
      padding: 0.9rem;
      background: rgba(30,41,59,0.65);
      border: 1px solid rgba(148,163,184,0.18);
    }
    .stand-card header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.5rem;
    }
    .stand-card header h3 {
      margin: 0;
      font-size: 1.05rem;
    }
    .species-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.75rem;
    }
    .species-card {
      background: rgba(15,23,42,0.75);
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: 0.8rem;
      padding: 0.75rem;
      font-size: 0.9rem;
    }
    .species-card ul {
      margin: 0.45rem 0 0;
      padding-left: 1.15rem;
      font-size: 0.8rem;
      opacity: 0.78;
    }
    .summary {
      display: grid;
      gap: 0.6rem;
      font-size: 0.95rem;
    }
    .summary strong {
      font-size: 1.15rem;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(56,189,248,0.15);
      color: #bae6fd;
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .login-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      z-index: 20;
      backdrop-filter: blur(18px);
    }
    .login-card {
      width: min(420px, 100%);
      background: rgba(15,23,42,0.85);
      border-radius: 1.2rem;
      padding: 2rem;
      border: 1px solid rgba(148,163,184,0.2);
      box-shadow: 0 25px 48px rgba(2,6,23,0.45);
      display: flex;
      flex-direction: column;
      gap: 1.3rem;
    }
    .login-card h2 { margin: 0; font-size: 1.6rem; }
    .login-card p { margin: 0; line-height: 1.4; color: rgba(226,232,240,0.78); }
    .login-card form { display: flex; flex-direction: column; gap: 0.9rem; }
    .login-card input { background: rgba(15,23,42,0.92); }
    .badge {
      font-size: 0.8rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background: rgba(56,189,248,0.2);
      color: #bae6fd;
      font-weight: 600;
    }
    .controls-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.75rem;
    }
    .controls-row button {
      flex: 1 1 140px;
    }
    button.small {
      font-size: 0.8rem;
      padding: 0.4rem 0.6rem;
      border-radius: 0.7rem;
    }
    .settings-toggle {
      margin-top: 0.9rem;
      width: 100%;
    }
    .assortment-card {
      margin-top: 0.85rem;
      padding: 0.85rem;
      border-radius: 0.9rem;
      background: rgba(15,23,42,0.72);
      border: 1px solid rgba(148,163,184,0.22);
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }
    .assortment-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
    }
    .assortment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.65rem;
    }
    .assortment-grid label {
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .assortment-grid input[type="range"] {
      margin-top: 0.4rem;
    }
    .switch {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.8rem;
      color: rgba(226,232,240,0.85);
    }
    .species-toggle {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      font-size: 0.8rem;
      color: rgba(226,232,240,0.82);
    }
    .species-toggle label {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(30,41,59,0.7);
      padding: 0.25rem 0.55rem;
      border-radius: 0.7rem;
      border: 1px solid rgba(148,163,184,0.25);
    }
    .summary-expanded {
      display: grid;
      gap: 0.6rem;
      font-size: 0.9rem;
    }
    .summary-expanded ul {
      margin: 0.35rem 0 0;
      padding-left: 1.2rem;
      opacity: 0.85;
    }
    .pill-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .pill-group button {
      font-size: 0.85rem;
      padding: 0.4rem 0.7rem;
      background: rgba(15,23,42,0.7);
      border: 1px solid rgba(148,163,184,0.25);
      border-radius: 999px;
      color: #cbd5f5;
    }
    .pill-group button.active {
      background: rgba(56,189,248,0.25);
      border-color: rgba(56,189,248,0.7);
      color: #e0f2fe;
    }
    .toast {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: rgba(15,23,42,0.92);
      border: 1px solid rgba(56,189,248,0.35);
      color: #e0f2fe;
      padding: 0.85rem 1rem;
      border-radius: 0.9rem;
      box-shadow: 0 20px 40px rgba(2,6,23,0.4);
      opacity: 0;
      transform: translateY(12px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      pointer-events: none;
      z-index: 30;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    @media (max-width: 1024px) {
      main {
        grid-template-columns: 1fr;
      }
      #map {
        min-height: 380px;
      }
    }
    @media (max-width: 640px) {
      header { flex-direction: column; align-items: flex-start; }
      header .user-info { align-self: stretch; justify-content: space-between; }
      body { background-attachment: fixed; }
      .panel { padding: 1rem; }
      .panel section { padding: 0.85rem; }
      .stand-card { padding: 0.75rem; }
      .species-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
    }
  </style>
</head>
<body>
  <div id="login-overlay" class="login-overlay" role="dialog" aria-modal="true">
    <div class="login-card">
      <div>
        <span class="badge">Sisäinen pilotti</span>
        <h2>Kirjaudu hakkuusuunnitteluun</h2>
        <p>Kalajoen pilottialue. Käytä testitunnusta jatkaaksesi: käyttäjä <strong>kalajoki</strong>, salasana <strong>metsä2024</strong>.</p>
      </div>
      <form id="login-form">
        <label>
          <span>Käyttäjätunnus</span>
          <input type="text" id="username" autocomplete="username" required />
        </label>
        <label>
          <span>Salasana</span>
          <input type="password" id="password" autocomplete="current-password" required />
        </label>
        <button type="submit" class="primary">Kirjaudu</button>
      </form>
      <small style="opacity:0.7; line-height:1.4;">Tämä demoversio käyttää paikallista kirjautumista. Lopulliseen toteutukseen liitetään yrityksen kertakirjautuminen.</small>
    </div>
  </div>

  <header>
    <h1>Kalajoen hakkuusuunnittelun pilotti</h1>
    <div class="user-info" id="user-info" hidden>
      <span id="user-name">–</span>
      <span class="tag">Beta</span>
      <button id="logout" class="secondary" style="padding:0.4rem 0.8rem; font-size:0.85rem;">Kirjaudu ulos</button>
    </div>
  </header>

  <main>
    <div id="map" aria-label="Metsäkartta Kalajoelta"></div>
    <aside class="panel">
      <div>
        <h2>Alue &amp; asetukset</h2>
        <section>
          <label>
            <span>Valitse kiinteistö</span>
            <select id="property-select">
              <option value="">– Valitse kohde kartalta tai listasta –</option>
            </select>
          </label>
          <div class="controls-row">
            <button id="refresh-property" class="secondary small" type="button">Päivitä rajapinnasta</button>
            <button id="api-settings" class="secondary small" type="button">API-asetukset</button>
          </div>
          <button id="toggle-settings" class="secondary settings-toggle" type="button">Näytä kooste</button>
        </section>
        <section id="settings-panel">
          <h3 style="margin:0; font-size:1.05rem;">Hinnoittelu ja katkaisupituudet</h3>
          <p style="margin:0.35rem 0 0; font-size:0.85rem; opacity:0.8;">Säädä puutavaralajeittain hinnat, katkaisupituudet ja painotus. Kuitu on oletuksena pois käytöstä.</p>
          <div id="assortment-controls"></div>
          <div class="controls-row" style="margin-top:1rem;">
            <button id="save-settings" class="primary small" type="button" style="flex:0 1 auto;">Tallenna oletukset</button>
            <button id="reset-settings" class="secondary small" type="button" style="flex:0 1 auto;">Palauta oletukset</button>
          </div>
        </section>
        <section id="summary-expanded" class="summary-expanded" hidden>
          <div>
            <strong>Kooste</strong>
            <p style="margin:0.35rem 0 0; opacity:0.75; font-size:0.85rem;">Asetukset piilotettu. Näytä asetukset muokataksesi hintoja ja pituuksia.</p>
          </div>
          <div>
            <span class="tag">Viimeisin optimointi</span>
            <ul id="assortment-summary-list"></ul>
          </div>
        </section>
      </div>

      <div>
        <h2>Kasvulohkot</h2>
        <div id="stands-container"></div>
      </div>

      <div>
        <h2>Optimointi ja raportointi</h2>
        <section class="summary" id="summary">
          <div>
            <strong>Kokonaisvolyymi:</strong>
            <span id="summary-volume">–</span>
          </div>
          <div>
            <strong>Optimoitu arvo:</strong>
            <span id="summary-value">–</span>
          </div>
          <div>
            <strong>Minimivaatimukset:</strong>
            <span id="summary-constraints">–</span>
          </div>
          <div>
            <strong>Huomiot:</strong>
            <span id="summary-notes">Valitse kiinteistö ja käynnistä optimointi.</span>
          </div>
        </section>
        <div class="pill-group" style="margin-top:0.75rem;">
          <button id="optimize" class="primary" style="flex:1;">Optimoi tuotto</button>
          <button id="generate-pdf" class="secondary">Lataa PDF</button>
          <button id="send-email" class="secondary">Luo sähköposti</button>
        </div>
      </div>
    </aside>
  </main>

  <div id="toast" class="toast" role="status"></div>

  <script>
    const TEST_USER = { username: "kalajoki", password: "metsä2024", name: "Kalajoen pilotti" };
    const SESSION_KEY = "hakkuusuunnittelu_session";

    const SETTINGS_KEY = "hakkuusuunnittelu_assortment_settings";
    const API_KEY_STORAGE = "hakkuusuunnittelu_metsakeskus_api";
    const METSAKESKUS_API_BASE = "https://avoin.api.metsakeskus.fi/forest-resource/v1";

    const SPECIES = [
      { key: "spruce", label: "Kuusi" },
      { key: "pine", label: "Mänty" },
      { key: "birch", label: "Koivu" }
    ];

    const ASSORTMENT_META = {
      tukki: { label: "Tukki", defaultPrice: 70, defaultPriority: 130, defaultLengths: ["4.8 m", "5.1 m"], defaultEnabled: true, defaultSpecies: { spruce: true, pine: true, birch: false } },
      pikkutukki: { label: "Pikkutukki", defaultPrice: 62, defaultPriority: 115, defaultLengths: ["4.3 m", "4.5 m"], defaultEnabled: true, defaultSpecies: { spruce: true, pine: true, birch: false } },
      kuitu: { label: "Kuitu", defaultPrice: 32, defaultPriority: 80, defaultLengths: ["3.0 m"], defaultEnabled: false, defaultSpecies: { spruce: true, pine: true, birch: true } },
      parru: { label: "Parru", defaultPrice: 48, defaultPriority: 95, defaultLengths: ["3.6 m", "4.0 m"], defaultEnabled: true, defaultSpecies: { spruce: true, pine: true, birch: true } },
      energiapuu: { label: "Energiapuu", defaultPrice: 28, defaultPriority: 70, defaultLengths: ["Kokopuu"], defaultEnabled: true, defaultSpecies: { spruce: true, pine: true, birch: true } },
      hakkuutahde: { label: "Hakkuutähde", defaultPrice: 12, defaultPriority: 50, defaultLengths: ["Hakkuutähde"], defaultEnabled: true, defaultSpecies: { spruce: true, pine: true, birch: true } }
    };

    let propertyData = [
      {
        id: "217-409-158-1",
        name: "ITÄMETSÄ, Kannus",
        areaHa: 62.8,
        centroid: [24.068, 63.904],
        geometry: {
          type: "Polygon",
          coordinates: [[[24.0521,63.9094],[24.0876,63.9094],[24.0948,63.8962],[24.0665,63.8938],[24.0509,63.901],[24.0521,63.9094]]]
        },
        stands: [
          {
            id: "IM-01",
            areaHa: 21.5,
            developmentClass: "uudistuskypsä",
            geometry: {
              type: "Polygon",
              coordinates: [[[24.0565,63.9072],[24.0678,63.9072],[24.0678,63.9008],[24.0565,63.9008],[24.0565,63.9072]]]
            },
            species: {
              spruce: {
                label: "Kuusi",
                assortments: {
                  tukki: { volume: 110, minHarvest: 70, lengths: ["4.9 m", "5.2 m"], enabledByDefault: true },
                  pikkutukki: { volume: 26, minHarvest: 12, lengths: ["4.3 m"], enabledByDefault: true },
                  kuitu: { volume: 28, minHarvest: 0, lengths: ["3.0 m"], enabledByDefault: false },
                  parru: { volume: 16, minHarvest: 8, lengths: ["3.8 m"], enabledByDefault: true },
                  energiapuu: { volume: 12, minHarvest: 0, lengths: ["Kokopuu"], enabledByDefault: true },
                  hakkuutahde: { volume: 9, minHarvest: 0, lengths: ["Hakkuutähde"], enabledByDefault: true }
                }
              },
              pine: {
                label: "Mänty",
                assortments: {
                  tukki: { volume: 78, minHarvest: 45, lengths: ["4.8 m", "5.0 m"], enabledByDefault: true },
                  pikkutukki: { volume: 20, minHarvest: 10, lengths: ["4.2 m"], enabledByDefault: true },
                  kuitu: { volume: 18, minHarvest: 0, lengths: ["3.0 m"], enabledByDefault: false },
                  parru: { volume: 15, minHarvest: 6, lengths: ["3.6 m"], enabledByDefault: true },
                  energiapuu: { volume: 10, minHarvest: 0, lengths: ["Kokopuu"], enabledByDefault: true },
                  hakkuutahde: { volume: 6, minHarvest: 0, lengths: ["Hakkuutähde"], enabledByDefault: true }
                }
              },
              birch: {
                label: "Koivu",
                assortments: {
                  kuitu: { volume: 20, minHarvest: 0, lengths: ["3.0 m"], enabledByDefault: false },
                  parru: { volume: 12, minHarvest: 5, lengths: ["3.6 m"], enabledByDefault: true },
                  energiapuu: { volume: 14, minHarvest: 0, lengths: ["Kokopuu"], enabledByDefault: true },
                  hakkuutahde: { volume: 7, minHarvest: 0, lengths: ["Hakkuutähde"], enabledByDefault: true }
                }
              }
            }
          },
          {
            id: "IM-02",
            areaHa: 18.3,
            developmentClass: "varttunut",
            geometry: {
              type: "Polygon",
              coordinates: [[[24.0678,63.9072],[24.0795,63.9072],[24.0795,63.9008],[24.0678,63.9008],[24.0678,63.9072]]]
            },
            species: {
              spruce: {
                label: "Kuusi",
                assortments: {
                  tukki: { volume: 74, minHarvest: 44, lengths: ["4.8 m", "5.0 m"], enabledByDefault: true },
                  pikkutukki: { volume: 22, minHarvest: 10, lengths: ["4.1 m"], enabledByDefault: true },
                  kuitu: { volume: 18, minHarvest: 0, lengths: ["3.0 m"], enabledByDefault: false },
                  parru: { volume: 12, minHarvest: 6, lengths: ["3.7 m"], enabledByDefault: true },
                  energiapuu: { volume: 10, minHarvest: 0, lengths: ["Kokopuu"], enabledByDefault: true },
                  hakkuutahde: { volume: 6, minHarvest: 0, lengths: ["Hakkuutähde"], enabledByDefault: true }
                }
              },
              pine: {
                label: "Mänty",
                assortments: {
                  tukki: { volume: 60, minHarvest: 36, lengths: ["4.6 m", "4.9 m"], enabledByDefault: true },
                  pikkutukki: { volume: 18, minHarvest: 9, lengths: ["4.0 m"], enabledByDefault: true },
                  kuitu: { volume: 14, minHarvest: 0, lengths: ["3.0 m"], enabledByDefault: false },
                  parru: { volume: 11, minHarvest: 5, lengths: ["3.5 m"], enabledByDefault: true },
                  energiapuu: { volume: 8, minHarvest: 0, lengths: ["Kokopuu"], enabledByDefault: true },
                  hakkuutahde: { volume: 5, minHarvest: 0, lengths: ["Hakkuutähde"], enabledByDefault: true }
                }
              },
              birch: {
                label: "Koivu",
                assortments: {
                  kuitu: { volume: 16, minHarvest: 0, lengths: ["3.0 m"], enabledByDefault: false },
                  parru: { volume: 10, minHarvest: 4, lengths: ["3.4 m"], enabledByDefault: true },
                  energiapuu: { volume: 12, minHarvest: 0, lengths: ["Kokopuu"], enabledByDefault: true },
                  hakkuutahde: { volume: 5, minHarvest: 0, lengths: ["Hakkuutähde"], enabledByDefault: true }
                }
              }
            }
          },
          {
            id: "IM-03",
            areaHa: 12.0,
            developmentClass: "ensiharvennus",
            geometry: {
              type: "Polygon",
              coordinates: [[[24.059,63.9008],[24.0795,63.9008],[24.0795,63.8948],[24.059,63.8948],[24.059,63.9008]]]
            },
            species: {
              spruce: {
                label: "Kuusi",
                assortments: {
                  tukki: { volume: 30, minHarvest: 18, lengths: ["4.6 m"], enabledByDefault: true },
                  pikkutukki: { volume: 18, minHarvest: 8, lengths: ["4.0 m"], enabledByDefault: true },
                  kuitu: { volume: 14, minHarvest: 0, lengths: ["2.8 m"], enabledByDefault: false },
                  parru: { volume: 10, minHarvest: 4, lengths: ["3.5 m"], enabledByDefault: true },
                  energiapuu: { volume: 12, minHarvest: 0, lengths: ["Kokopuu"], enabledByDefault: true },
                  hakkuutahde: { volume: 8, minHarvest: 0, lengths: ["Hakkuutähde"], enabledByDefault: true }
                }
              },
              pine: {
                label: "Mänty",
                assortments: {
                  tukki: { volume: 36, minHarvest: 20, lengths: ["4.7 m"], enabledByDefault: true },
                  pikkutukki: { volume: 22, minHarvest: 10, lengths: ["4.0 m"], enabledByDefault: true },
                  kuitu: { volume: 12, minHarvest: 0, lengths: ["2.8 m"], enabledByDefault: false },
                  parru: { volume: 12, minHarvest: 5, lengths: ["3.4 m"], enabledByDefault: true },
                  energiapuu: { volume: 9, minHarvest: 0, lengths: ["Kokopuu"], enabledByDefault: true },
                  hakkuutahde: { volume: 5, minHarvest: 0, lengths: ["Hakkuutähde"], enabledByDefault: true }
                }
              },
              birch: {
                label: "Koivu",
                assortments: {
                  kuitu: { volume: 9, minHarvest: 0, lengths: ["2.6 m"], enabledByDefault: false },
                  parru: { volume: 8, minHarvest: 3, lengths: ["3.2 m"], enabledByDefault: true },
                  energiapuu: { volume: 10, minHarvest: 0, lengths: ["Kokopuu"], enabledByDefault: true },
                  hakkuutahde: { volume: 4, minHarvest: 0, lengths: ["Hakkuutähde"], enabledByDefault: true }
                }
              }
            }
          }
        ]
      }
    ];

    const initialProperty = propertyData[0] || null;

    const FALLBACK_REMOTE_DATA = {
      "217-409-158-1": JSON.parse(JSON.stringify(propertyData.find((p) => p.id === "217-409-158-1")))
    };




    function buildPropertyFeatures(properties) {
      return {
        type: "FeatureCollection",
        features: properties
          .filter((property) => property.geometry)
          .map((property) => ({
            type: "Feature",
            properties: { id: property.id, name: property.name },
            geometry: property.geometry
          }))
      };
    }

    let propertyFeatures = buildPropertyFeatures(propertyData);
    function buildStandFeatures(property) {
      if (!property) {
        return { type: "FeatureCollection", features: [] };
      }
      return {
        type: "FeatureCollection",
        features: (property.stands || [])
          .filter((stand) => stand.geometry)
          .map((stand) => ({
            type: "Feature",
            properties: {
              id: stand.id,
              propertyId: property.id,
              developmentClass: stand.developmentClass || ""
            },
            geometry: stand.geometry
          }))
      };
    }

    let standFeatures = buildStandFeatures(initialProperty);

    const maastokarttaStyle = {
      version: 8,
      sources: {
        maastokartta: {
          type: "raster",
          tiles: ["https://tiles.kartat.kapsi.fi/maastokartta/{z}/{x}/{y}.jpg"],
          tileSize: 256,
          attribution: "Karttataso © Maanmittauslaitos (CC BY 4.0)"
        }
      },
      layers: [
        {
          id: "maastokartta",
          type: "raster",
          source: "maastokartta",
          minzoom: 0,
          maxzoom: 18
        }
      ]
    };

    const map = new maplibregl.Map({
      container: "map",
      style: {
        ...maastokarttaStyle,
        glyphs: maastokarttaStyle.glyphs || "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf"
      },
      center: (initialProperty && initialProperty.centroid) || [24.068, 63.904],
      zoom: initialProperty ? 12 : 8.5,
      pitch: 0,
      attributionControl: false
    });
    map.addControl(new maplibregl.NavigationControl({ visualizePitch: false }), "top-right");
    map.addControl(new maplibregl.ScaleControl({ unit: "metric" }), "bottom-right");
    map.addControl(new maplibregl.AttributionControl({ compact: true }));

    map.on("load", () => {
      map.addSource("properties", {
        type: "geojson",
        data: propertyFeatures
      });

      map.addSource("stands", {
        type: "geojson",
        data: standFeatures
      });

      map.addLayer({
        id: "property-fill",
        type: "fill",
        source: "properties",
        minzoom: 11,
        paint: {
          "fill-color": "rgba(56,189,248,0.22)",
          "fill-opacity": ["interpolate", ["linear"], ["zoom"], 11, 0.08, 13, 0.25, 14, 0.38]
        }
      });

      map.addLayer({
        id: "stand-fill",
        type: "fill",
        source: "stands",
        minzoom: 12,
        paint: {
          "fill-color": "rgba(148,163,184,0.35)",
          "fill-opacity": ["interpolate", ["linear"], ["zoom"], 12, 0.12, 14, 0.45]
        }
      });

      map.addLayer({
        id: "property-outline",
        type: "line",
        source: "properties",
        minzoom: 11,
        paint: {
          "line-color": "rgba(56,189,248,0.6)",
          "line-width": ["interpolate", ["linear"], ["zoom"], 11, 1, 13, 2.2]
        }
      });

      map.addLayer({
        id: "stand-outline",
        type: "line",
        source: "stands",
        minzoom: 12,
        paint: {
          "line-color": "rgba(226,232,240,0.9)",
          "line-width": ["interpolate", ["linear"], ["zoom"], 12, 1, 14, 2.2]
        }
      });

      map.addLayer({
        id: "property-highlight",
        type: "line",
        source: "properties",
        minzoom: 11,
        paint: {
          "line-color": "rgba(59,130,246,0.95)",
          "line-width": ["interpolate", ["linear"], ["zoom"], 11, 2.2, 13, 3.6]
        },
        filter: ["==", ["get", "id"], "__none__"]
      });

      if (propertySelect.value) {
        map.setFilter("property-highlight", ["==", ["get", "id"], propertySelect.value]);
      }

      if (initialProperty && initialProperty.geometry) {
        const bounds = geometryToBounds(initialProperty.geometry);
        if (bounds) {
          map.fitBounds(bounds, { padding: 60, animate: false });
        }
      }
    });

    map.on("click", "property-fill", (e) => {
      const feature = e.features && e.features[0];
      if (!feature) return;
      const property = propertyData.find((p) => p.id === feature.properties.id);
      if (!property) return;
      selectProperty(property.id, true);
    });

    map.on("mouseenter", "property-fill", () => {
      map.getCanvas().style.cursor = "pointer";
    });
    map.on("mouseleave", "property-fill", () => {
      map.getCanvas().style.cursor = "";
    });

    map.on("mouseenter", "stand-fill", () => {
      map.getCanvas().style.cursor = "pointer";
    });
    map.on("mouseleave", "stand-fill", () => {
      map.getCanvas().style.cursor = "";
    });

    function geometryToBounds(geometry) {
      if (!geometry || !geometry.coordinates) return null;
      const coords = [];
      const collect = (segment) => {
        if (!Array.isArray(segment)) return;
        segment.forEach((item) => {
          if (Array.isArray(item) && typeof item[0] === "number" && typeof item[1] === "number") {
            coords.push(item);
          } else {
            collect(item);
          }
        });
      };
      collect(geometry.coordinates);
      if (!coords.length) return null;
      const bounds = coords.slice(1).reduce((acc, coord) => acc.extend(coord), new maplibregl.LngLatBounds(coords[0], coords[0]));
      return bounds;
    }

    function updateStandSource(property) {
      standFeatures = buildStandFeatures(property);
      if (map.getSource("stands")) {
        map.getSource("stands").setData(standFeatures);
      }
    }

    function flyToProperty(property) {
      if (!property) return;
      const bounds = property.geometry ? geometryToBounds(property.geometry) : null;
      if (bounds) {
        map.fitBounds(bounds, { padding: 60, duration: 900 });
        return;
      }
      if (property.centroid) {
        map.flyTo({ center: property.centroid, zoom: 12.5, essential: true });
      }
    }

    const propertySelect = document.getElementById("property-select");
    const standsContainer = document.getElementById("stands-container");
    const summaryVolume = document.getElementById("summary-volume");
    const summaryValue = document.getElementById("summary-value");
    const summaryConstraints = document.getElementById("summary-constraints");
    const summaryNotes = document.getElementById("summary-notes");
    const summaryExpanded = document.getElementById("summary-expanded");
    const assortmentSummaryList = document.getElementById("assortment-summary-list");
    const settingsPanel = document.getElementById("settings-panel");
    const toggleSettingsButton = document.getElementById("toggle-settings");
    const saveSettingsButton = document.getElementById("save-settings");
    const resetSettingsButton = document.getElementById("reset-settings");
    const refreshButton = document.getElementById("refresh-property");
    const apiSettingsButton = document.getElementById("api-settings");

    let settingsCollapsed = false;
    let lastPlan = null;
    let currentSettings = loadStoredSettings();

    renderAssortmentControls(currentSettings);
    populatePropertySelect();

    if (initialProperty) {
      propertySelect.value = initialProperty.id;
      selectProperty(initialProperty.id, false);
    }

    toggleSettingsButton.addEventListener("click", () => {
      settingsCollapsed = !settingsCollapsed;
      settingsPanel.hidden = settingsCollapsed;
      summaryExpanded.hidden = !settingsCollapsed;
      toggleSettingsButton.textContent = settingsCollapsed ? "Näytä asetukset" : "Näytä kooste";
      if (settingsCollapsed) {
        renderSummaryDetail(lastPlan);
      }
    });

    saveSettingsButton.addEventListener("click", () => {
      currentSettings = gatherSettings();
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(currentSettings));
      renderToast("Asetukset tallennettu");
    });

    resetSettingsButton.addEventListener("click", () => {
      currentSettings = loadDefaultSettings();
      renderAssortmentControls(currentSettings);
      renderToast("Oletusasetukset palautettu");
    });

    propertySelect.addEventListener("change", (event) => {
      const propertyId = event.target.value;
      if (!propertyId) return;
      selectProperty(propertyId, true);
    });

    refreshButton.addEventListener("click", () => {
      const currentId = propertySelect.value || prompt("Anna kiinteistötunnus (esim. 217-409-158-1)");
      if (!currentId) return;
      refreshPropertyFromApi(currentId.trim());
    });

    apiSettingsButton.addEventListener("click", configureApiKey);
    function populatePropertySelect(selectedId = "") {
      const previous = propertySelect.value;
      propertySelect.innerHTML = '<option value="">– Valitse kohde kartalta tai listasta –</option>';
      propertyData
        .slice()
        .sort((a, b) => a.name.localeCompare(b.name, "fi"))
        .forEach((property) => {
          const option = document.createElement("option");
          option.value = property.id;
          option.textContent = `${property.name} (${property.id})`;
          propertySelect.appendChild(option);
        });
      const target = selectedId || previous;
      if (target && propertyData.some((property) => property.id === target)) {
        propertySelect.value = target;
      }
    }

    function loadDefaultSettings() {
      const defaults = {};
      Object.entries(ASSORTMENT_META).forEach(([key, meta]) => {
        defaults[key] = {
          enabled: meta.defaultEnabled !== false,
          price: meta.defaultPrice != null ? meta.defaultPrice : 0,
          priority: meta.defaultPriority != null ? meta.defaultPriority : 100,
          lengths: Array.isArray(meta.defaultLengths) ? [...meta.defaultLengths] : [],
          species: SPECIES.reduce((acc, species) => {
            acc[species.key] = meta.defaultSpecies ? Boolean(meta.defaultSpecies[species.key]) : true;
            return acc;
          }, {})
        };
      });
      return defaults;
    }

    function loadStoredSettings() {
      const defaults = loadDefaultSettings();
      try {
        const stored = JSON.parse(localStorage.getItem(SETTINGS_KEY));
        if (stored && typeof stored === "object") {
          Object.entries(defaults).forEach(([key, base]) => {
            if (!stored[key]) return;
            defaults[key] = {
              enabled: stored[key].enabled != null ? stored[key].enabled : base.enabled,
              price: Number(stored[key].price != null ? stored[key].price : base.price),
              priority: Number(stored[key].priority != null ? stored[key].priority : base.priority),
              lengths: Array.isArray(stored[key].lengths) ? stored[key].lengths : base.lengths,
              species: { ...base.species, ...(stored[key].species || {}) }
            };
          });
        }
      } catch (error) {
        console.warn("Failed to parse stored settings", error);
      }
      return defaults;
    }

    function renderAssortmentControls(settings) {
      const container = document.getElementById("assortment-controls");
      const markup = Object.entries(ASSORTMENT_META)
        .map(([key, meta]) => {
          const config = settings[key] || loadDefaultSettings()[key];
          const lengths = Array.isArray(config.lengths) ? config.lengths.join(", ") : "";
          const speciesToggles = SPECIES.map((species) => {
            const speciesEnabled = config.species && config.species[species.key];
            return `
            <label>
              <input type="checkbox" id="${key}-species-${species.key}" ${speciesEnabled ? "checked" : ""} />
              ${species.label}
            </label>`;
          }).join("");
          return `
            <article class="assortment-card" data-assortment="${key}">
              <div class="assortment-header">
                <h4 style="margin:0; font-size:1rem;">${meta.label}</h4>
                <label class="switch">
                  <input type="checkbox" id="${key}-enabled" ${config.enabled ? "checked" : ""} />
                  <span>Käytössä</span>
                </label>
              </div>
              <div class="assortment-grid">
                <label>Hinta €/m³
                  <input id="${key}-price" type="number" min="0" step="1" value="${config.price}" />
                </label>
                <label>Katkaisupituudet
                  <input id="${key}-lengths" type="text" value="${lengths}" placeholder="esim. 4.8 m, 5.1 m" />
                </label>
                <label>Painotus <span id="${key}-priority-display">${config.priority}%</span>
                  <input id="${key}-priority" type="range" min="0" max="200" step="5" value="${config.priority}" />
                </label>
              </div>
              <div class="species-toggle">
                <span style="opacity:0.75;">Puulajit:</span>
                ${speciesToggles}
              </div>
            </article>
          `;
        })
        .join("");
      container.innerHTML = markup;
      Object.keys(ASSORTMENT_META).forEach((key) => {
        const slider = document.getElementById(`${key}-priority`);
        const display = document.getElementById(`${key}-priority-display`);
        if (slider && display) {
          display.textContent = `${slider.value}%`;
          slider.addEventListener("input", () => {
            display.textContent = `${slider.value}%`;
          });
        }
      });
    }

    function gatherSettings() {
      const settings = {};
      Object.keys(ASSORTMENT_META).forEach((key) => {
        const enabledInput = document.getElementById(`${key}-enabled`);
        if (!enabledInput) return;
        const price = Number(document.getElementById(`${key}-price`).value || 0);
        const lengthsValue = document.getElementById(`${key}-lengths`).value || "";
        const priority = Number(document.getElementById(`${key}-priority`).value || 0);
        const speciesSelection = {};
        SPECIES.forEach((species) => {
          const checkbox = document.getElementById(`${key}-species-${species.key}`);
          speciesSelection[species.key] = checkbox ? checkbox.checked : false;
        });
        const lengths = lengthsValue
          .split(/[,;]/)
          .map((token) => token.trim())
          .filter(Boolean);
        settings[key] = {
          enabled: enabledInput.checked,
          price,
          lengths,
          priority,
          species: speciesSelection
        };
      });
      return settings;
    }

    function standTotalVolume(stand) {
      return Object.values(stand.species || {}).reduce((speciesSum, species) => {
        return speciesSum + Object.values(species.assortments || {}).reduce((assortmentSum, assortment) => {
          return assortmentSum + (assortment.volume || 0);
        }, 0);
      }, 0);
    }

    function propertyTotalVolume(property) {
      return property.stands.reduce((total, stand) => total + standTotalVolume(stand), 0);
    }

    function renderSummaryDetail(plan) {
      if (!assortmentSummaryList) return;
      if (!plan) {
        assortmentSummaryList.innerHTML = "<li>Optimoi tuotto nähdäksesi koonnin.</li>";
        return;
      }
      const rows = Object.keys(ASSORTMENT_META)
        .map((key) => {
          const totals = plan.assortmentTotals && plan.assortmentTotals[key];
          if (!totals || totals.volume <= 0) return null;
          const label = assortmentLabel(key);
          const valueText = totals.value.toLocaleString("fi-FI", { maximumFractionDigits: 0 });
          return `<li>${label}: ${totals.volume.toFixed(0)} m³ (${valueText} €)</li>`;
        })
        .filter(Boolean);
      assortmentSummaryList.innerHTML = rows.length ? rows.join("\n") : "<li>Ei kertymiä valituilla asetuksilla.</li>";
    }

    function selectProperty(propertyId, focus = false) {
      const property = propertyData.find((p) => p.id === propertyId);
      if (!property) return;
      const plan = lastPlan && lastPlan.propertyId === propertyId ? lastPlan : null;
      if (!plan) {
        lastPlan = null;
      }
      propertySelect.value = propertyId;
      renderStands(property);
      updateSummary(property, plan);
      updateStandSource(property);
      if (map.getLayer("property-highlight")) {
        map.setFilter("property-highlight", ["==", ["get", "id"], propertyId]);
      }
      if (focus) {
        flyToProperty(property);
      }
    }

    function renderStands(property) {
      standsContainer.innerHTML = "";
      property.stands.forEach((stand) => {
        const card = document.createElement("article");
        card.className = "stand-card";
        const totalVolume = standTotalVolume(stand);
        card.innerHTML = `
          <header>
            <h3>${stand.id}</h3>
            <span class="tag">${stand.developmentClass}</span>
          </header>
          <div style="font-size:0.85rem; opacity:0.8;">${stand.areaHa.toFixed(1)} ha • Kokonaisvolyymi ${totalVolume.toFixed(0)} m³</div>
          <div class="species-grid"></div>
        `;
        const speciesGrid = card.querySelector(".species-grid");
        Object.entries(stand.species || {}).forEach(([speciesKey, speciesDetails]) => {
          const assortments = Object.entries(speciesDetails.assortments || {}).filter(([, details]) => ((details && details.volume) || 0) > 0);
          if (!assortments.length) return;
          const speciesCard = document.createElement("div");
          speciesCard.className = "species-card";
          const speciesLabel = speciesDetails.label || speciesName(speciesKey);
          const items = assortments
            .map(([assortKey, details]) => {
              const label = assortmentLabel(assortKey);
              const minText = details.minHarvest ? ` • min ${details.minHarvest} m³` : "";
              const defaultState = details.enabledByDefault === false ? " (oletuksena pois)" : "";
              const lengthText = Array.isArray(details.lengths) && details.lengths.length ? details.lengths.join(", ") : "–";
              return `<li>${label}${defaultState}: ${details.volume} m³${minText}<br /><span style="opacity:0.75;">Pituudet: ${lengthText}</span></li>`;
            })
            .join("");
          speciesCard.innerHTML = `
            <strong>${speciesLabel}</strong>
            <ul>${items}</ul>
          `;
          speciesGrid.appendChild(speciesCard);
        });
        standsContainer.appendChild(card);
      });
    }

    function updateSummary(property, plan) {
      const totalVolume = propertyTotalVolume(property);
      summaryVolume.textContent = `${totalVolume.toFixed(0)} m³`;
      if (!plan) {
        summaryValue.textContent = "–";
        summaryConstraints.textContent = "Ei sitovia minimirajoja";
        summaryNotes.textContent = "Säädä asetuksia ja paina Optimoi tuotto.";
        renderSummaryDetail(null);
        return;
      }
      summaryValue.textContent = `${plan.totalValue.toLocaleString("fi-FI", { maximumFractionDigits: 0 })} €`;
      summaryConstraints.textContent = plan.constraints.length ? plan.constraints.join(" • ") : "Ei sitovia minimirajoja";
      summaryNotes.textContent = plan.notes.length ? plan.notes.join(" ") : "Kaikki minimivaatimukset täyttyvät.";
      renderSummaryDetail(plan);
    }

    function optimize(property, settings) {
      const plan = {
        propertyId: property.id,
        totalValue: 0,
        totalVolume: 0,
        stands: [],
        constraints: [],
        notes: [],
        assortmentTotals: {}
      };

      property.stands.forEach((stand) => {
        const standPlan = { id: stand.id, species: {} };
        Object.entries(stand.species || {}).forEach(([speciesKey, speciesDetails]) => {
          const speciesLabel = speciesDetails.label || speciesName(speciesKey);
          const speciesPlan = { label: speciesLabel, assortments: {} };
          Object.entries(speciesDetails.assortments || {}).forEach(([assortKey, details]) => {
            const config = settings[assortKey];
            const meta = ASSORTMENT_META[assortKey];
            if (!details || !config) return;
            if (!config.enabled || !config.species[speciesKey]) {
              if ((details.minHarvest || 0) > 0) {
                const label = (meta && meta.label) || assortKey;
                plan.notes.push(`${stand.id}: ${speciesLabel} ${label} ei käytössä (min ${details.minHarvest} m³).`);
              }
              if ((details.minHarvest || 0) > 0 || details.enabledByDefault !== false) {
                const label = (meta && meta.label) || assortKey;
                speciesPlan.assortments[assortKey] = {
                  label,
                  enabled: false,
                  harvestVolume: 0,
                  revenue: 0,
                  minRequired: details.minHarvest || 0
                };
              }
              return;
            }
            const priorityFactor = Math.max(config.priority || 0, 0) / 100;
            const requested = Math.round(details.volume * priorityFactor);
            let harvestVolume = Math.max(details.minHarvest || 0, requested);
            harvestVolume = Math.min(harvestVolume, details.volume);
            const meetsMin = harvestVolume >= (details.minHarvest || 0);
            if (!meetsMin) {
              const label = (meta && meta.label) || assortKey;
              plan.notes.push(`${stand.id}: ${speciesLabel} ${label} ei täytä minimikertymää (${harvestVolume.toFixed(0)} m³ < ${details.minHarvest} m³).`);
            }
            const price = config.price || 0;
            const revenue = harvestVolume * price;
            plan.totalValue += revenue;
            plan.totalVolume += harvestVolume;
            const label = (meta && meta.label) || assortKey;
            speciesPlan.assortments[assortKey] = {
              label,
              enabled: true,
              harvestVolume,
              revenue,
              minRequired: details.minHarvest || 0,
              lengths: config.lengths
            };
            if ((details.minHarvest || 0) > 0) {
              const labelForConstraint = (meta && meta.label) || assortKey;
              plan.constraints.push(`${speciesLabel} ${labelForConstraint} ≥ ${details.minHarvest} m³`);
            }
            if (!plan.assortmentTotals[assortKey]) {
              plan.assortmentTotals[assortKey] = { volume: 0, value: 0 };
            }
            plan.assortmentTotals[assortKey].volume += harvestVolume;
            plan.assortmentTotals[assortKey].value += revenue;
          });
          if (Object.keys(speciesPlan.assortments).length) {
            standPlan.species[speciesKey] = speciesPlan;
          }
        });
        plan.stands.push(standPlan);
      });

      plan.constraints = Array.from(new Set(plan.constraints));
      plan.notes = Array.from(new Set(plan.notes));
      return plan;
    }

    function speciesName(key) {
      const match = SPECIES.find((item) => item.key === key);
      return match ? match.label : key;
    }

    function assortmentLabel(key) {
      const meta = ASSORTMENT_META[key];
      return meta && meta.label ? meta.label : key;
    }

    async function refreshPropertyFromApi(propertyId) {
      const apiKey = getStoredApiKey();
      if (!apiKey) {
        renderToast("Aseta API-avain ennen hakua");
        configureApiKey();
        return;
      }
      const originalText = refreshButton.textContent;
      refreshButton.disabled = true;
      refreshButton.textContent = "Ladataan...";
      summaryNotes.textContent = "Haetaan kiinteistön tietoja rajapinnasta...";
      try {
        const response = await fetch(`${METSAKESKUS_API_BASE}/properties/${encodeURIComponent(propertyId)}`, {
          headers: {
            Authorization: `Bearer ${apiKey}`
          }
        });
        if (!response.ok) {
          throw new Error(`API response ${response.status}`);
        }
        const data = await response.json();
        const normalized = normalizeRemoteProperty(propertyId, data);
        if (!normalized) {
          throw new Error("Odottamaton rajapintavastaus");
        }
        upsertPropertyData(normalized);
        renderToast("Kiinteistön tiedot päivitetty");
      } catch (error) {
        console.error("Property fetch failed", error);
        const fallback = FALLBACK_REMOTE_DATA[propertyId];
        if (fallback) {
          upsertPropertyData(JSON.parse(JSON.stringify(fallback)));
          renderToast("Käytetään esimerkkidataa (rajapintakutsu epäonnistui)");
        } else {
          summaryNotes.textContent = "Rajapintaa ei voitu hakea. Tarkista API-avain ja yhteys.";
          renderToast("Rajapinnan haku epäonnistui");
        }
      } finally {
        refreshButton.disabled = false;
        refreshButton.textContent = originalText;
      }
    }

    function configureApiKey() {
      const current = getStoredApiKey();
      const value = prompt("Syötä Metsäkeskuksen API-avain", current || "");
      if (value === null) return;
      const trimmed = value.trim();
      if (trimmed) {
        localStorage.setItem(API_KEY_STORAGE, trimmed);
        renderToast("API-avain tallennettu");
      } else {
        localStorage.removeItem(API_KEY_STORAGE);
        renderToast("API-avain poistettu");
      }
    }

    function getStoredApiKey() {
      return localStorage.getItem(API_KEY_STORAGE) || "";
    }

    function normalizeRemoteProperty(propertyId, data) {
      if (!data || typeof data !== "object") return null;
      if (!data.stands || !Array.isArray(data.stands)) {
        return null;
      }
      const firstStand = data.stands[0];
      const hasSpruceAssortments = firstStand && firstStand.species && firstStand.species.spruce && firstStand.species.spruce.assortments;
      if (!hasSpruceAssortments) {
        return null;
      }
      return {
        id: data.id || propertyId,
        name: data.name || propertyId,
        areaHa: data.areaHa || data.area || 0,
        centroid: data.centroid || data.center || null,
        geometry: data.geometry || null,
        stands: data.stands
      };
    }

    function upsertPropertyData(property) {
      const clone = JSON.parse(JSON.stringify(property));
      const index = propertyData.findIndex((item) => item.id === clone.id);
      if (index >= 0) {
        propertyData[index] = clone;
      } else {
        propertyData.push(clone);
      }
      populatePropertySelect(clone.id);
      refreshMapFeatures();
      selectProperty(clone.id, true);
    }

    function refreshMapFeatures() {
      propertyFeatures = buildPropertyFeatures(propertyData);
      if (map.getSource("properties")) {
        map.getSource("properties").setData(propertyFeatures);
      }
      const selectedProperty = propertyData.find((item) => item.id === propertySelect.value) || null;
      updateStandSource(selectedProperty);
    }
    function renderToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2800);
    }

    document.getElementById("optimize").addEventListener("click", () => {
      const propertyId = propertySelect.value;
      if (!propertyId) {
        renderToast("Valitse ensin kiinteistö");
        return;
      }
      const property = propertyData.find((p) => p.id === propertyId);
      if (!property) return;
      currentSettings = gatherSettings();
      lastPlan = optimize(property, currentSettings);
      updateSummary(property, lastPlan);
      if (settingsCollapsed) {
        renderSummaryDetail(lastPlan);
      }
      renderToast("Optimointi suoritettu");
    });

    document.getElementById("generate-pdf").addEventListener("click", () => {
      if (!lastPlan) {
        renderToast("Aja optimointi ennen raportin luontia");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const property = propertyData.find((p) => p.id === lastPlan.propertyId);
      doc.setFontSize(16);
      doc.text("Hakkuusuunnitelman yhteenveto", 14, 18);
      doc.setFontSize(11);
      doc.text(`Kiinteistö: ${property.name} (${property.id})`, 14, 28);
      doc.text(`Kokonaisvolyymi: ${lastPlan.totalVolume.toFixed(0)} m³`, 14, 36);
      doc.text(`Optimoitu arvo: ${lastPlan.totalValue.toFixed(0)} €`, 14, 44);
      doc.text("Minimivaatimukset:", 14, 54);
      lastPlan.constraints.forEach((c, index) => {
        doc.text(`• ${c}`, 18, 64 + index * 8);
      });
      let offset = 64 + lastPlan.constraints.length * 8 + 8;
      doc.text("Lohkokohtaiset tulokset:", 14, offset);
      offset += 8;
      lastPlan.stands.forEach((stand) => {
        doc.text(`${stand.id}`, 14, offset);
        offset += 6;
        Object.values(stand.species).forEach((species) => {
          doc.text(`${species.label}`, 18, offset);
          offset += 6;
          Object.values(species.assortments).forEach((assortment) => {
            const status = assortment.enabled ? "" : " (ei käytössä)";
            doc.text(`- ${assortment.label}${status}: ${assortment.harvestVolume.toFixed(0)} m³ (${assortment.revenue.toFixed(0)} €)`, 22, offset);
            offset += 6;
          });
          offset += 4;
        });
        offset += 2;
      });
      doc.save(`hakkuusuunnitelma_${property.id}.pdf`);
      renderToast("PDF ladattu");
    });

    document.getElementById("send-email").addEventListener("click", () => {
      if (!lastPlan) {
        renderToast("Aja optimointi ennen sähköpostia");
        return;
      }
      const property = propertyData.find((p) => p.id === lastPlan.propertyId);
      const subject = encodeURIComponent(`Hakkuusuunnitelma ${property.name}`);
      const bodyLines = [
        `Kiinteistö: ${property.name} (${property.id})`,
        `Kokonaisvolyymi: ${lastPlan.totalVolume.toFixed(0)} m³`,
        `Optimoitu arvo: ${lastPlan.totalValue.toFixed(0)} €`,
        "",
        "Lohkokohtaiset kertymät:",
        ...lastPlan.stands.flatMap((stand) => {
          const rows = [`${stand.id}:`];
          Object.values(stand.species).forEach((species) => {
            rows.push(`  ${species.label}:`);
            Object.values(species.assortments).forEach((assortment) => {
              const status = assortment.enabled ? "" : " (ei käytössä)";
              rows.push(`    - ${assortment.label}${status} ${assortment.harvestVolume.toFixed(0)} m³ / ${assortment.revenue.toFixed(0)} €`);
            });
          });
          return rows;
        })
      ];
      const mailto = `mailto:?subject=${subject}&body=${encodeURIComponent(bodyLines.join("\n"))}`;
      window.location.href = mailto;
    });

    function restoreSession() {
      try {
        const session = JSON.parse(localStorage.getItem(SESSION_KEY));
        if (session && session.username === TEST_USER.username) {
          completeLogin(session);
        }
      } catch (error) {
        console.warn("Session parse failed", error);
      }
    }

    function completeLogin(session) {
      document.getElementById("login-overlay").style.display = "none";
      const info = document.getElementById("user-info");
      info.hidden = false;
      document.getElementById("user-name").textContent = session.displayName || TEST_USER.name;
      renderToast("Tervetuloa takaisin");
    }

    document.getElementById("login-form").addEventListener("submit", (event) => {
      event.preventDefault();
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      if (username === TEST_USER.username && password === TEST_USER.password) {
        const session = { username, displayName: "Kalajoen pilotti", timestamp: new Date().toISOString() };
        localStorage.setItem(SESSION_KEY, JSON.stringify(session));
        completeLogin(session);
      } else {
        renderToast("Virheellinen käyttäjätunnus tai salasana");
      }
    });

    document.getElementById("logout").addEventListener("click", () => {
      localStorage.removeItem(SESSION_KEY);
      window.location.reload();
    });

    restoreSession();
  </script>
</body>
</html>
